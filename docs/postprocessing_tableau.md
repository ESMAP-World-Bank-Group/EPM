# Tableau workflow

A Tableau dashboard is available to explore model results. It includes multiple tabs for comparing scenarios, countries, and years across various indicators (capacity, energy, trade flows, costs, etc.). Interactive filters allow detailed data exploration.

## Modelers

A World Bank Creator license is available for team members to modify data sources.
To update the dashboard:

### Loading data

Before you connect to the remote server, ensure you have the following:

- A WB computer or VDI (Virtual Desktop Infrastructure). 
- A YubiKey (only required for VDI authentication).
The setup will not work outside the VDI or without a Yubikey.

1. Connect to the common VDI and launch the `Tableau` app. You may need to register if this is your first connection.
2. Upload results data, with the following structure
```markdown
├── ESMAP_Viz_v5.twb
├── ESMAP_logo.png
├── linestring_countries_2.geojson
└── Scena/
    ├── baseline/
    │   ├── *.csv
    ├── scenario_1/
        ├── *.csv
    └── ...
```

3. Place all scenario folders inside the `Scena/` directory. Each folder must contain the CSVs exported from the model.
   - The dashboard expects structured CSV files. These are automatically generated when running the EPM model from Python. If running from GAMS Studio, CSVs must be extracted manually (less efficient). See the `Running EPM from Python` section for guidance.
**Important**: one of the scenarios inside must be named `baseline`, otherwise an error will be raised.
4. Add the file `linestring_countries_2.geojson` inside the `Scena/` folder. This is required for geographic visualizations. Details on how to obtain this file are given below

#### Creating geojson file

Some visualization tabs in Tableau include maps, which require a GeoJSON file to display countries or regions. This file must match the zones defined in your EPM model. The necessary data can be generated by following the steps below.

1. Step 1: Create the `geojson_to_epm.csv` mapping File

This CSV file defines how names from the GeoJSON file should be translated into EPM-compatible zone names. It also allows you to split countries into sub-zones if needed (e.g. North/South).

- `Geojson`: the name of the country or region as it appears in the GeoJSON file.  
  _Example_: `United Republic of Tanzania`
- `EPM`: the name used for that zone in the EPM model.  
  _Example_: `Tanzania`
- `region`: _(optional)_ only used when splitting a country into several zones. Specifies which part of the country this line refers to.  
  _Example_: `north`
- `country`: _(optional)_ if a country is split, this column gives the full country name (e.g. `Democratic Republic of the Congo`), while the `Geojson` column may be something like `Democratic Republic of the Congo - North`.
- `division`: _(optional)_ describes how the country is split. Current accepted values:  
  - `NS` = North/South  
  - `EW` = East/West  
  More division types may be added in the future.

Save this file as `geojson_to_epm.csv` in the output folder for your run.

2. Step 2: Run the Script to Generate GeoJSON Data
```python 
python utils.py --zones Angola DRC DRC_South Eswatini Lesotho Malawi Mozambique Namibia South_Africa Tanzania Zambia Zimbabwe --folder Tableau
```
Here:
- `--zones`: list of EPM zones to include in the GeoJSON output. These must match the zone names in your model.
- `--folder`: name of the folder that contains your model results. This should match the folder inside the `output/` directory. Example: if your results are saved in `output/Tableau`, use `--folder Tableau`.
**Note**: Make sure to run this command from the root of the repository at `epm/postprocessing`. It will not work if it is run from `epm`.
**Note**: The output folder (`output/your_folder`) must contain both: `geojson_to_epm.csv` (mapping file created above) and `zcmap.csv` (zone-country map used when running the model)

Once the script runs successfully, it will generate the `linestring_countries_2.geojson` file you can use directly in Tableau for map visualizations.

### Update visualization

To update the visualization for new scenarios, you should follow the steps:
1. Upload the new scenarios with the arborescence as described previously, keeping in mind that one of the scenarios is named `baseline`.
2. Tableau opens in live connection mode by default. This causes delays when interacting with filters or switching views.
To avoid these delays, you must extract the data. For each of these four data sets, you must extract the data by going to `Data` and `Extract data`: `linestring`, `pCostSummaryWeightedAverageCountry`, `Plant DB` and `pSummary`
3. Once this has been done, data is extracted and optimized so that the visualizations will now load faster.
4. When refreshing with new scenarios, extrated data remains based on the previous scenarios. Two steps can be used to refresh the data and access the new visualization:
   1. Keep previous extracts but view new data: For each of the dataset above, unclick `Use Extract` (reverts to live mode).
   2. Replace extracts with new data: for each of the dataset above, go to `Extract` → `Remove` → `Remove the extract and delete the extract file`.
   Then re-extract to optimize the new data (Step 2)


## Sharing with stakeholders

The Tableau dashboard can be shared with external users who don’t need to edit data sources but can explore results interactively.

### Creating a Tableau Public visualization
In Tableau, go to `Server`, `Tableau Public`, `Save to Tableau Public as`. Choose a name and complete the upload. Once published, a browser window will open with your dashboard.
You may adapt the settings based on the intended usage of this visualization, by going to the `Settings` button:
- Remove `Show Viz on Profile` if you want the visualization to only be accessible to those with a link (hide it from your public profile)
- Remove `Allow Access` to prevent data download.

**Important**: this visualization will only work when data has been extracted. Tableau will prompt an error if you attempt to publish with live connections.
