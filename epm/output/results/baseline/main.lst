GAMS 48.6.1  67fbb04b Jan 23, 2025          LEX-LEG x86 64bit/Linux - 12/16/25 15:08:32 Page 1
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
C o m p i l a t i o n


   1  **********************************************************************
   2  * ELECTRICITY PLANNING MODEL (EPM)
   3  * Developed at the World Bank
   4  **********************************************************************
   5  * Description:
   6  * This GAMS-based model is designed for electricity system planning,
   7  * incorporating capacity expansion, generation dispatch, and policy
   8  * constraints such as renewable energy targets, emissions reductions,
   9  * and market mechanisms.
  10  *
  11  * Author(s): ESMAP Modelling Team
  12  * Organization: World Bank
  13  * Version:
  14  * License: Creative Commons Zero v1.0 Universal
  15  *
  16  * Key Features:
  17  * - Optimization of electricity generation and capacity planning
  18  * - Inclusion of renewable energy integration and storage technologies
  19  * - Multi-period, multi-region modeling framework
  20  * - CO2 emissions constraints and policy instruments
  21  *
  22  * Notes:
  23  * - Ensure GAMS is installed before running this model.
  24  * - The model requires input data in .GDX or Excel format.
  25  *
  26  * Contact:
  27  * Claire Nicolas, cnicolas@worldbank.org
  28  **********************************************************************
  29   
  34   
  37   
  38  * Turn on/off additional information to the listing file
  39  option limRow=0, limCol=0, sysOut=off, solPrint=off;
  42   
  43  *-------------------------------------------------------------------------------------
  44   
  45  * Useful for Python import
  47   
  48  *-------------------------------------------------------------------------------------
  49   
  50  * Folder input
  53   
  54  *-------------------------------------------------------------------------------------
  55   
  56  * By default modeltype is MIP
  60   
  61  * Use the relevant cplex file
  64   
  68   
  69  * Define modeltype-related options
  70  Scalar
  71     modeltypeThreads 'Number of threads available to the modeltypes' /1/
  72     modeltypeOptCR   'Relative gap for MIP modeltype'                /0.05/
  73     modeltypeResLim  'modeltype time limit'                          /300000/
  74  ;
  75  Singleton Set
  76     NLPmodeltype 'Selected NLP modeltype' / '' 'conopt4' /
  77     MIPmodeltype 'Selected MIP modeltype' / '' 'cplex' /
  78  ;
  79   
  80  * Evaluate and assign modeltype settings as macros
  86   
  87  * Apply modeltype settings to GAMS execution
  88  option NLP=conopt4, MIP=cplex, threads=1, optCR=0.05, resLim=300000;
  89   
  90  *-------------------------------------------------------------------------------------
  91   
  92  * Only include base if we don't restart
  95   
  97   
 101   
 102   
 106   
 107   
 111   
 112   
 116   
 117  *-------------------------------------------------------------------------------------
 118   
 119  * Core domain sets loaded from external files
 120  Sets
 121     g        'Generators or technology-fuel types'
 122     f        'Fuels'
 123     tech     'Technologies'
 124     y        'Planning years'
 125     q        'Seasonal blocks (quarters)'
 126     d        'Representative days'
 127     t        'Hours of day'
 128     z        'System zones'
 129     c        'Countries'
 130     zext     'External trading zones'
 131     AT       'Full-year hourly chronology' /AT1*AT8760/
 132     pGenDataInputHeader 'Generator data input headers'
 133     pSettingsHeader
 134     pStorageDataHeader                                        'Storage data headers'
 135     pCSPDataHeader       'CSP data headers'                 / 'Storage', 'Thermal Field' /
 136     pTransmissionHeader  'Transmission data headers'
 137     pH2Header            'Hydrogen data headers'
 138     pTechDataHeader      'Technology data headers'
 139     pe                   'Peak/energy tags for demand'      / 'peak', 'energy' /
 140     hh                   'Hydrogen production units'
 141  ;
 142   
 143   
 144  * Relationship sets derived from the inputs
 145  Sets
 146     zcmap(z<,c<) 'Zone-to-country mapping'
 147     gmap(g,z,tech,f) 'Generator-to-zone/technology/fuel mapping'
 148     sRelevant(d) 'Days where minimum generation limits apply'
 149     mapTS(q,d,t,AT) 'Mapping from season/day/hour tuples to chronological AT index'
 150  ;
 151   
 152  alias (z,z2), (g,g1,g2);
 153   
 154  * Input data parameters
 155  Parameter
 156  * Generator data
 157     pTechData(tech<,pTechDataHeader<)                     'Technology specifications'
 158     pGenDataInput(g<,z,tech,f<,pGenDataInputHeader)       'Generator data from Excel input'
 159     pGenDataInputDefault(z,tech,f,pGenDataInputHeader)    'Default generator data by zone/tech/fuel'
 160     pCapexTrajectoriesDefault(z,tech,f,y)                 'Default CAPEX trajectories'
 161     pCapexTrajectories(g,y)                               'Generator CAPEX trajectories'
 162     pAvailabilityDefault(z,tech,f,q)                      'Default availability factors'
 163   
 164  * Storage data
 165     pStorageDataInput(g,*,pStorageDataHeader)                 'Storage unit specifications'
 166   
 167  * CSP and technology data
 168     pCSPData(g,pCSPDataHeader,pStorageDataHeader)           'Concentrated solar power data'
 169   
 170  * Fuel data
 171     pFuelCarbonContent(f)                                 'Carbon content by fuel (tCO2/MMBtu)'
 172     pMaxFuellimit(c,f,y)                                  'Fuel limit in MMBTU*1e6 (million) by country'
 173     pFuelPrice(c,f,y)                                     'Fuel price forecasts'
 174   
 175  * Storage and transmission
 176     pNewTransmission(z,z2,pTransmissionHeader)           'New transmission line specifications'
 177     pStorageDataTemp(g,g2,pStorageDataHeader)             'Temporary storage data for processing'
 178   
 179  * Trade parameters
 180     pTradePrice(zext,q,d,y,t)                             'External trade prices'
 181     pMaxAnnualExternalTradeShare(y,c)                     'Maximum trade share by country'
 182   
 183  * Demand parameters
 184     pDemandProfile(z,q,d,t)                               'Normalized demand profiles'
 185     pDemandForecast(z,pe,y)                               'Peak/energy demand forecasts (MW/GWh)'
 186     pDemandData(z,q,d,y,t)                                'Hourly load curves'
 187   
 188  * Emissions and carbon
 189     pEmissionsCountry(c,y)                                'Country emission limits (tons)'
 190     pEmissionsTotal(y)                                    'System-wide emission limits (tons)'
 191     pCarbonPrice(y)                                       'Carbon price (USD/ton CO2)'
 192   
 193  * Time and transfer parameters
 194     pHours(q<,d<,t<)                                      'Hours mapping'
 195     pDays(q)                                              'Number of days represented by each period'
 196     pTransferLimit(z,z2,q,y)                              'Inter-zonal transfer limits'
 197     pMinImport(z2,z,y)                                    'Minimum import requirements'
 198     pLossFactorInternal(z,z2,y)                           'Transmission loss factors'
 199   
 200  * VRE and availability
 201     pVREProfile(z,tech,q,d,t)                             'VRE generation profiles by site'
 202     pVREgenProfile(g,q,d,t)                               'VRE generation profiles by plant'
 203     pAvailabilityInput(g,q)                              'Seasonal availability factors (from CSV, no year)'
 204     pAvailability(g,y,q)                                  'Seasonal availability factors (expanded to years)'
 205     pEvolutionAvailability(g,y)                           'Year-dependent availability evolution factors'
 206   
 207  * Reserve requirements
 208     pSpinningReserveReqCountry(c,y)                       'Country spinning reserve requirements'
 209     pSpinningReserveReqSystem(y)                          'System spinning reserve requirements'
 210     pPlanningReserveMargin(c)                             'Planning reserve margins'
 211   
 212  * Other parameters
 213     pSettings(pSettingsHeader)                            'Model settings and penalties'
 214     pEnergyEfficiencyFactor(z,y)                          'Energy efficiency adjustment factors'
 215     pExtTransferLimit(z,zext,q,*,y)                       'External transfer limits'
 216   
 217  * Hydrogen parameters
 218     pH2DataExcel(hh<,pH2Header)                           'Hydrogen data from Excel'
 219     pAvailabilityH2(hh,q)                                 'H2 plant availability'
 220     pFuelDataH2(f)                                        'Hydrogen fuel properties'
 221     pCapexTrajectoryH2(hh,y)                              'H2 CAPEX trajectories'
 222     pExternalH2(z,q,y)                                    'External H2 demand (MMBtu) to be met'
 223   
 224     ftfindex(f)                                           'Fuel-to-fuel index mapping'
 225  ;
 226   
 227   
 228  * Add to pGenDataInputHeader the headers that are optional for users but necessary for the model
 229   
 230   
 232  *-------------------------------------------------------------------------------------
 233  * Read inputs
 234   
 235  * Include the external reader file defined by the macro variable %READER_FILE%
INCLUDE    /Data/SAPP_2026/EPM/epm/input_readers.gms
 237  **********************************************************************
 238  * ELECTRICITY PLANNING MODEL (EPM)
 239  * Developed at the World Bank
 240  **********************************************************************
 241  * Description:
 242  * This GAMS-based model is designed for electricity system planning,
 243  * incorporating capacity expansion, generation dispatch, and policy
 244  * constraints such as renewable energy targets, emissions reductions,
 245  * and market mechanisms.
 246  *
 247  * Author(s): ESMAP Modelling Team
 248  * Organization: World Bank
 249  * Version:
 250  * License: Creative Commons Zero v1.0 Universal
 251  *
 252  * Key Features:
 253  * - Optimization of electricity generation and capacity planning
 254  * - Inclusion of renewable energy integration and storage technologies
 255  * - Multi-period, multi-region modeling framework
 256  * - CO2 emissions constraints and policy instruments
 257  *
 258  * Notes:
 259  * - Ensure GAMS is installed before running this model.
 260  * - The model requires input data in .GDX.
 261  *
 262  * Contact:
 263  * Claire Nicolas, cnicolas@worldbank.org
 264  **********************************************************************
 265   
 266   
 268   
 269  * Define by default path
 270  * SETTINGS
 277   
 278  * LOAD DATA
 284   
 285  * SUPPLY DATA
 296   
 297  * OTHER SUPPLY OPTIONS
 300   
 301  * RESOURCES
 306   
 310   
 311  * RESERVE
 315   
 316  * TRADE
 327   
 328  * CONSTRAINT
 333   
 334  * H2 RELATED
 341   
 342   
 344   
 874   
 875  * Open the specified GDX input file for reading
GDXIN   /Data/SAPP_2026/EPM/epm/output/simulations_run_20251216_150832/baseline/input.gdx
 877   
 878  * Load domain-defining symbols (sets and indices)
--- LOAD  zcmap = 7:zcmap
--- LOAD  pSettingsHeader = 1:pSettingsHeader
--- LOAD  y = 9:y
--- LOAD  pHours = 10:pHours
--- LOAD  pDays = 3:pDays
--- LOAD  mapTS = 8:mapTS
--- LOAD  pGenDataInputHeader = 4:pGenDataInputHeader
--- LOAD  pTechData = 16:pTechData
--- LOAD  pStorageDataHeader = 5:pStorageDataHeader
--- LOAD  pGenDataInput = 18:pGenDataInput
--- LOAD  gmap = 17:gmap
--- LOAD  pGenDataInputDefault = 19:pGenDataInputDefault
--- LOAD  pAvailabilityDefault = 21:pAvailabilityDefault
--- LOAD  pCapexTrajectoriesDefault = 26:pCapexTrajectoriesDefault
--- LOAD  ftfindex = 30:ftfindex
--- LOAD  pSettings = 2:pSettings
 885   
 886  * Load demand data
--- LOAD  pDemandData = 13:pDemandData
--- LOAD  pDemandForecast = 11:pDemandForecast
--- LOAD  pDemandProfile = 12:pDemandProfile
--- LOAD  pEnergyEfficiencyFactor = 15:pEnergyEfficiencyFactor
--- LOAD  sRelevant = 14:sRelevant
 888   
--- LOAD  pFuelCarbonContent = 31:pFuelCarbonContent
--- LOAD  pCarbonPrice = 45:pCarbonPrice
--- LOAD  pEmissionsCountry = 46:pEmissionsCountry
--- LOAD  pEmissionsTotal = 47:pEmissionsTotal
--- LOAD  pFuelPrice = 27:pFuelPrice
 890   
 891  * Load constraints and technical data
--- LOAD  pMaxFuellimit = 48:pMaxFuellimit
--- LOAD  pTransferLimit = 43:pTransferLimit
--- LOAD  pLossFactorInternal = 42:pLossFactorInternal
--- LOAD  pVREProfile = 24:pVREProfile
--- LOAD  pVREgenProfile = 23:pVREgenProfile
--- LOAD  pAvailabilityInput = 20:pAvailabilityInput
--- LOAD  pEvolutionAvailability = 22:pEvolutionAvailability
--- LOAD  pStorageDataInput = 29:pStorageDataInput
--- LOAD  pCSPData = 28:pCSPData
--- LOAD  pCapexTrajectories = 25:pCapexTrajectories
--- LOAD  pSpinningReserveReqCountry = 33:pSpinningReserveReqCountry
--- LOAD  pSpinningReserveReqSystem = 34:pSpinningReserveReqSystem
--- LOAD  pPlanningReserveMargin = 32:pPlanningReserveMargin
 895   
 896  * Load trade data
--- LOAD  zext = 35:zext
--- LOAD  pTransmissionHeader = 36:pTransmissionHeader
--- LOAD  pExtTransferLimit = 37:pExtTransferLimit
--- LOAD  pNewTransmission = 41:pNewTransmission
--- LOAD  pMinImport = 44:pMinImport
--- LOAD  pTradePrice = 40:pTradePrice
--- LOAD  pMaxAnnualExternalTradeShare = 38:pMaxAnnualExternalTradeShare
 900   
 901  * Load Hydrogen model-related symbols
--- LOAD  pH2Header = 6:pH2Header
--- LOAD  pH2DataExcel = 49:pH2DataExcel
--- LOAD  pAvailabilityH2 = 50:pAvailabilityH2
--- LOAD  pFuelDataH2 = 51:pFuelDataH2
--- LOAD  pCapexTrajectoryH2 = 52:pCapexTrajectoryH2
--- LOAD  pExternalH2 = 53:pExternalH2
 903   
 904  * Close the GDX file after loading all required data
 906   
 908   
 909  *-------------------------------------------------------------------------------------
 910   
 911  * Make input verification
 915   
 916   
 930   
 931   
 933   
 934  *-------------------------------------------------------------------------------------
 935  * Make input treatment
 936   
 940   
 942   
 956   
 958   
 960   
 961  *-------------------------------------------------------------------------------------
 962   
 965   
 967   
 968  *-------------------------------------------------------------------------------------
 969   
 970  * Only include BASE_FILE if this is a fresh run (i.e., not using a restart file)
 971  * This prevents reloading sets, parameters, or data already available in the restart
INCLUDE    /Data/SAPP_2026/EPM/epm/base.gms
 973  **********************************************************************
 974  * ELECTRICITY PLANNING MODEL (EPM)
 975  * Developed at the World Bank
 976  **********************************************************************
 977  * Description:
 978  * This GAMS-based model is designed for electricity system planning,
 979  * incorporating capacity expansion, generation dispatch, and policy
 980  * constraints such as renewable energy targets, emissions reductions,
 981  * and market mechanisms.
 982  *
 983  * Author(s): ESMAP Modelling Team
 984  * Organization: World Bank
 985  * Version:
 986  * License: Creative Commons Zero v1.0 Universal
 987  *
 988  * Key Features:
 989  * - Optimization of electricity generation and capacity planning
 990  * - Inclusion of renewable energy integration and storage technologies
 991  * - Multi-period, multi-region modeling framework
 992  * - CO2 emissions constraints and policy instruments
 993  *
 994  * Notes:
 995  * - Ensure GAMS is installed before running this model.
 996  * - The model requires input data in .GDX or Excel format.
 997  *
 998  * Contact:
 999  * Claire Nicolas, cnicolas@worldbank.org
1000  **********************************************************************
1001   
1004   
1005  *-------------------------------------------------------------------
1006  * DECLARATION OF SETS, PARAMETERS AND VARIABLES
1007  *-------------------------------------------------------------------
1008   
1009   
1010   
1011  alias (y,y2);
1012  alias (f,f2);
1013  alias (c,c2);
1014  alias (q,q2);
1015  alias (d,d2);
1016  alias (t,tprev,t2);
1017  alias (AT,AT2);
1018   
1019   
1020   
1021  * -------------------------------------------------------------
1022  * Generator classification sets
1023  * -------------------------------------------------------------
1024  Sets
1025     eg(g)                  'Existing generator fleet'
1026     ng(g)                  'New-build candidates'
1027     commtransmission(z,z2) 'Committed transmission corridors'
1028     cs(g)                  'Concentrated solar power units'
1029     so(g)                  'PV plants paired with storage'
1030     stp(g)                 'Dedicated storage blocks for PV plants'
1031     st(g)                  'All storage technologies (incl. standalone)'
1032     dc(g)                  'Candidates with CAPEX trajectory data'
1033     ndc(g)                 'Candidates without CAPEX trajectory data'
1034     vre(g)                 'Variable renewable technologies'
1035     re(g)                  'Renewable technologies (broader than VRE)'
1036     RampRate(g)            'Generators subject to ramp constraints (filters out inflexible units)'
1037     VRE_noROR(g)           'VRE assets excluding run-of-river (used for spinning reserve sizing)'
1038  ;
1039   
1040   
1041  * -------------------------------------------------------------
1042  * Mapping sets (generator-to-fuel/zone, network structure)
1043  * -------------------------------------------------------------
1044  Sets
1045     gfmap(g,f)             'Generator-to-fuel association'
1046     gzmap(g,z)             'Generator-to-zone association'
1047     zfmap(z,f)             'Fuel availability by zone'
1048     gsmap(g2,g)            'Storage-to-generator linkage'
1049     sTopology(z,z2)        'Internal network adjacency'
1050     sMapConnectedZonesDiffCountries(z,z2) 'Cross-country connections subset (topology filter)'
1051  ;
1052   
1053   
1054  * -------------------------------------------------------------
1055  * Status and modeltype-control sets
1056  * -------------------------------------------------------------
1057  Sets
1058     gstatus  'Generator status lookup'           / Existing, Candidate, Committed /
1059     tstatus  'Transmission project status'      / Candidate, Committed /
1060     mipline  'modeltype option line identifiers'
1061     mipopt(mipline<) 'MIP modeltype option key-value pairs' / system.empty /
1062  ;
1063   
1064   
1065  * -------------------------------------------------------------
1066  * Implicit domains (restrict variables to meaningful tuples)
1067  * -------------------------------------------------------------
1068  Sets
1069     sPwrOut(g,f,q,d,t,y)        'Active generator-fuel-time combinations'
1070     sExportPrice(z,zext,q,d,t,y) 'Valid export price records (external zones)'
1071     sImportPrice(z,zext,q,d,t,y) 'Valid import price records (external zones)'
1072     sAdditionalTransfer(z,z2,y)  'Transmission build decision domain'
1073     sFlow(z,z2,q,d,t,y)         'Feasible flow pairs'
1074     sSpinningReserve(g,q,d,t,y) 'Generators able to provide spinning reserve'
1075     FD(q,d,t)                  'Feasible q,d,t tuples for dispatch mode'
1076  ;
1077   
1078  Singleton sets
1079     sStartYear(y)
1080     sFirstHour(t)
1081     sLastHour(t)
1082     sFirstDay(d)
1083     sLastDay(d)
1084  ;
1085   
1086  Set
1087     sFirstHourAT(AT)          'First chronological hour in the AT sequence (used for ramp gating)'
1088  ;
1089   
1090  * Additional parameters for results and reporting
1091  * -------------------------------------------------------------
1092  * Global flags and shared parameters for reporting/constraints
1093  * -------------------------------------------------------------
1094  Parameter
1095     pAllHours(q,d,y,t)           'All operating hours (used for peak tracking)'
1096     pFindSysPeak(y)              'Yearly system peak indicator'
1097     pSeasonalReporting           'Enable seasonal report outputs'
1098     fEnableInternalExchange      'Allow internal zone trading'
1099     fRemoveInternalTransferLimit 'Override internal transfer limits'
1100     fAllowTransferExpansion      'Permit expansion of internal transmission (set elsewhere too; redundant flag)'
1101     pDR                          'Discount rate applied in objective'
1102     fEnableCapexTrajectoryH2     'Toggle CAPEX trajectory for hydrogen assets'
1103     fEnableEnergyEfficiency     'Enable demand-side efficiency adjustments'
1104     fApplySystemCo2Constraint   'Apply system-wide CO₂ constraint'
1105     pExtTransferLimitIn(z,zext,q,y)  'Exogenous import limit from external zones'
1106     pExtTransferLimitOut(z,zext,q,y) 'Exogenous export limit to external zones'
1107     psVREForecastErrorPct        'Forecast error percentage for VRE (used in reserves)'
1108  ;
1109   
1110  * Additional structure sets (technology/mapping)
1111  Set
1112     gprimf(g,f)            'Primary fuel used by each generator'
1113     gtechmap(g,tech)       'Generator-to-technology linkage'
1114     gstatusmap(g,gstatus)  'Generator status lookup (existing/candidate/committed)'
1115     tstatusmap(z,z2,tstatus) 'Transmission status lookup'
1116     Zd(z)                  'Demand-serving zones'
1117     Zt(z)                  'Zone type classification (often redundant with Zd)'
1118     stg(g)                 'Storage generators (grid-scale)'
1119     ror(g)                 'Run-of-river assets (subset of renewables)'
1120     MinGenPoint(g)         'Generators with minimum generation constraints (used for startup cost accumulation)'
1121  ;
1122   
1123   
1124  Parameters
1125     pCostOfCurtailment          'Penalty on curtailed VRE (check usage – may be redundant)'
1126     pCostOfCO2backstop          'CO₂ backstop cost ($/ton)'
1127     pWeightYear(y)              'Inter-year weighting factor'
1128   
1129  * Generator data
1130     pGenData(g,pGenDataInputHeader) 'Generator characteristics (capex, heat rate, etc.)'
1131     pAvailability(g,y,q)           'Seasonal availability factors'
1132     pCapexTrajectories(g,y)        'CAPEX trajectory multipliers'
1133     pInitialOnStart(g)             'Initial commitment state (1=on) for the first chronological slot (default or from data)'
1134   
1135  * External exchange data
1136     fEnableExternalExchange          'Permit external exchange'
1137     pMaxAnnualExternalTradeShare(y,c) 'Annual import/export share cap by country'
1138     pTradePrice(zext,q,d,y,t)      'Border price for external trades'
1139     sMaxHourlyImportExternalShare  'Hourly import cap (share of demand)'
1140     sMaxHourlyExportExternalShare  'Hourly export cap (share of demand)'
1141     pExtTransferLimit(z,zext,q,*,y) 'Full external transfer limit tensor'
1142     pExtTransferLimitIn(z,zext,q,y) 'Import limit (duplicate of earlier parameter)'
1143     pExtTransferLimitOut(z,zext,q,y)'Export limit (duplicate of earlier parameter)'
1144   
1145  * Demand inputs
1146     pDemandData(z,q,d,y,t)         'Demand time series (seasonal, daily, hourly)'
1147   
1148  * Renewable/storage inputs
1149     pCSPProfile(g,q,d,t)           'CSP solar profile (pu)'
1150     pStoPVProfile(g,q,d,t)         'PV-with-storage profile (pu)'
1151     pStorageData(g,pStorageDataHeader)  'Storage technical data'
1152   
1153  * Reserve and policy inputs
1154     pCapacityCredit(g,y)           'Capacity credit for planning reserves'
1155     psVREForecastErrorPct          'Reserve add-on for VRE (note: duplicate naming with parameter above)'
1156     pCarbonPrice(y)                'Carbon price trajectory'
1157     pFuelCarbonContent(f)          'Fuel carbon intensity (tCO₂/MMBtu)'
1158   
1159  * Economic parameters
1160     pRR(y)                         'Discount factor (accumulated)'
1161     pWACC                          'Weighted average cost of capital'
1162     pCRF(g)                        'Capital recovery factor (generator)'
1163     pCRFsst(g)                     'Capital recovery factor (storage)'
1164     pCRFcst(g)                     'Capital recovery factor (CSP storage)'
1165     pCRFcth(g)                     'Capital recovery factor (CSP thermal field)'
1166     pVoLL                          'Value of lost load'
1167     pPlanningReserveVoLL           'Penalty for planning reserve shortfall'
1168     pSpinningReserveVoLL           'Penalty for spinning reserve shortfall'
1169     ssMaxCapitalInvestmentInvestment 'Total capital limit (USD) – consider renaming for clarity'
1170     pVarCost(g,f,y)                'Variable cost (fuel + VOM)'
1171     pFuelCost(g,f,y)               'Fuel price'
1172     pVOMCost(g,f,y)                'Variable O&M component'
1173   
1174  * Control toggles
1175     fEnableCapacityExpansion
1176     fApplyRampConstraint           'Enable ramping constraints'
1177     fApplyFuelConstraint           'Enable fuel availability limits'
1178     fApplyCapitalConstraint        'Enable total capital constraint'
1179     fEnableCSP                     'Enable CSP features'
1180     fEnableStorage                 'Enable storage operations'
1181     fEnableCarbonPrice                 'Apply carbon cost'
1182     pSurplusPenalty                'Penalty on surplus energy'
1183     pMinRE                         'Minimum RE share target'
1184     pMinsRenewableTargetYear       'Year from which RE target applies'
1185     fApplyCountryCo2Constraint     'Country-level CO₂ constraint toggle'
1186     fApplySystemCo2Constraint     'System-level CO₂ constraint toggle (duplicate flag name earlier)'
1187     fApplyCountrySpinReserveConstraint 'Enable country spinning reserve constraint'
1188     fApplySystemSpinReserveConstraint 'Enable system spinning reserve constraint'
1189     fApplyPlanningReserveConstraint 'Enable planning reserve constraint'
1190     sIntercoReserveContributionPct 'Share of interconnection capacity counted toward reserves'
1191     fCountIntercoForReserves       'Include interconnections in planning reserve assessment'
1192     sReserveMarginPct              'Planning reserve margin target'
1193     pHeatrate(g,f)                 'Generator heat rate'
1194   
1195     fApplyMinGenShareAllHours
1196   
1197     fDispatchMode                 'Activate full-year dispatch inputs'
1198     fApplyMinGenCommitment        'Minimum generation constraint toggle'
1199     fApplyMUDT                    'Enable minimum up/down-time constraints (dispatch mode only)'
1200     fApplyStartupCost             'Include startup cost in the variable-cost stack'
1201  ;
1202   
1203  Scalar
1204     pStorageInitShare           'Default share of capacity for initial/final SOC anchors'
1205   
1206  * -------------------------------------------------------------
1207  * Positive decision variables (continuous)
1208  * -------------------------------------------------------------
1209  Positive Variables
1210  * Dispatch and demand balance
1211     vPwrOut(g,f,q,d,t,y)      'Generation output (MW)'
1212     vPwrOutDispatch(g,q,d,t,AT,y) 'Chronologically aggregated dispatch per slot (MW)'
1213     vUSE(z,q,d,t,y)           'Unserved demand (MW)'
1214     vSurplus(z,q,d,t,y)       'Surplus generation (MW)'
1215     vYearlySurplus(z,y)       'Annual surplus energy (aggregated)'
1216   
1217  * Capacity evolution
1218     vCap(g,y)                 'Installed capacity (MW)'
1219     vBuild(g,y)               'New build decision (MW)'
1220     vRetire(g,y)              'Retirement decision (MW)'
1221   
1222  * Network flows and external trade
1223     vFlow(z,z2,q,d,t,y)       'Internal power flow (MW)'
1224     vYearlyImportExternal(z,zext,q,d,t,y)  'External imports (MW)'
1225     vYearlyExportExternal(z,zext,q,d,t,y)  'External exports (MW)'
1226   
1227  * Fuel consumption
1228     vFuel(z,f,y)              'Annual fuel consumption (MMBtu)'
1229   
1230  * Annualized CAPEX trackers (note potential overlap among these three)
1231     vAnnCapexGenTraj(g,y)     'Annualized CAPEX with trajectory (verify alongside vAnnGenCapex)'
1232     vAnnGenCapex(g,y)         'Annualized CAPEX for builds in year y'
1233     vAnnCapex(z,y)            'Annualized CAPEX aggregated by zone'
1234   
1235  * Storage and CSP state variables
1236     vThermalOut(g,q,d,t,y)    'CSP thermal output (MW)'
1237     vCapStor(g,y)             'Installed storage energy capacity (MWh)'
1238     vCapTherm(g,y)            'Installed CSP thermal capacity (MW)'
1239     vStorage(g,q,d,t,y)       'State of charge (MW-equivalent)'
1240     vStorInj(g,q,d,t,y)       'Charging power (MW)'
1241     vStorOut(g,q,d,t,y)       'Discharging power (MW)'
1242     vBuildStor(g,y)           'New storage build (MWh)'
1243     vRetireStor(g,y)          'Storage retirement (MWh)'
1244     vBuildTherm(g,y)          'CSP thermal field build (MW)'
1245     vRetireTherm(g,y)         'CSP thermal field retirement (MW)'
1246   
1247  * Reserve shortfalls
1248     vSpinningReserve(g,q,d,t,y)           'Spinning reserve provision (MW)'
1249     vStartupCost(g,q,d,t,y)                 'Startup cost accumulated within each representative slot (USD)'
1250     vUnmetPlanningReserveCountry(c,y)     'Country planning reserve shortfall'
1251     vUnmetPlanningReserveSystem(y)        'System planning reserve shortfall'
1252     vUnmetSpinningReserveCountry(c,q,d,t,y) 'Country spinning reserve shortfall'
1253     vUnmetSpinningReserveSystem(q,d,t,y)  'System spinning reserve shortfall'
1254   
1255  * Emissions accounting
1256     vZonalEmissions(z,y)      'Zonal emissions intensity (tCO₂/MWh)'
1257     vTotalEmissions(y)        'System emissions (tCO₂)'
1258     vYearlyCO2backstop(c,y)   'Country CO₂ backstop usage (t)'
1259     vYearlySysCO2backstop(y)  'System CO₂ backstop usage (t)'
1260   
1261  * Network expansion & curtailment
1262     vNewTransmissionLine(z,z2,y) 'New transmission capacity (MW)'
1263     vAnnualizedTransmissionCapex(z,y) 'Annualized transmission CAPEX (USD)'
1264     vYearlyCurtailmentCost(z,y)  'Annual curtailment penalty (USD)'
1265     vCurtailedVRE(z,g,q,d,t,y)   'Curtailment of VRE (MW)'
1266  ;
1267   
1268  * ------------------------------
1269  * Unit-commitment binaries
1270  * Tracks each generator's ON/OFF state per dispatch slot and records every startup/shutdown transition for constraint logic.
1271  * The chronological mapping `mapTS` ensures these binaries only represent valid hours.
1272  * ------------------------------
1273  Binary Variable
1274     isOn(g,q,d,t,AT,y)         '1 when generator g is online during the chronological slot represented by (q,d,t,AT)'
1275     isStartup(g,q,d,t,AT,y)    '1 when the generator transitions from offline to online during the mapped slot'
1276     isShutdown(g,q,d,t,AT,y)   '1 when the generator transitions from online to offline during the mapped slot'
1277  ;
1278   
1279  * -------------------------------------------------------------
1280  * Free variables (objective & reporting)
1281  * -------------------------------------------------------------
1282  Free Variable
1283     vNPVCost                       'Net present value of total system cost'
1284     vStorNet(g,q,d,t,y)            'Net storage power (discharge - charge)'
1285     vYearlyTotalCost(c,y)          'Annual total cost by country'
1286     vYearlyVariableCost(z,y)       'Annual variable cost by zone'
1287     vYearlyUSECost(z,y)            'Cost of unserved energy'
1288     vYearlyExternalTradeCost(z,y)  'Net external trade cost'
1289     vYearlySpinningReserveCost(z,y)'Spinning reserve penalty'
1290     vYearlyUnmetReserveCostCountry(c,y) 'Country-level reserve shortfall cost'
1291     vYearlyCarbonCost(z,y)         'Zonal carbon cost'
1292     vYearlyCO2BackstopCostCountry(c,y) 'Country CO₂ backstop cost'
1293     vYearlyUnmetPlanningReserveCostSystem(y) 'System planning reserve cost'
1294     vYearlyUnmetSpinningReserveCostSystem(y) 'System spinning reserve cost'
1295     vYearlyCO2BackstopCostSystem(y) 'System CO₂ backstop cost'
1296     vYearlyUnmetPlanningReserveCostCountry(c,y) 'Country planning reserve cost'
1297     vYearlyUnmetSpinningReserveCostCountry(c,y) 'Country spinning reserve cost'
1298     vYearlyStartupCost(z,y)        'Annual startup cost for dispatch slots'
1299     vYearlyFOMCost(z,y)            'Zone fixed O&M cost'
1300     vYearlyFuelCost(z,y)           'Zone fuel cost'
1301     vYearlyVOMCost(z,y)            'Zone variable O&M cost'
1302     vYearlyImportExternalCost(z,y) 'Cost of imports from external zones'
1303     vYearlyExportExternalCost(z,y) 'Revenue from exports to external zones'
1304     vSupply(z,q,d,t,y)             'Total supply meeting demand (balance variable)'
1305  ;
1306   
1307  * -------------------------------------------------------------
1308  * Integer decision variables
1309  * -------------------------------------------------------------
1310  Integer variable
1311     vBuildTransmissionLine(z,z2,y) 'Integer builds for transmission'
1312     vBuiltCapVar(g,y)          'Integer build decision (unit commitment for discrete capacity)'
1313     vRetireCapVar(g,y)         'Integer retirement decision'
1314  ;
1315   
1316   
1317  * -------------------------------------------------------------
1318  * Core equations (objective, balances, constraints)
1319  * -------------------------------------------------------------
1320  Equations
1321   
1322  * ------------------------------
1323  * Objective and cost accounting
1324  * Summarizes NPV and annual cost components across system and countries.
1325  * ------------------------------
1326     eNPVCost                        'Objective function – discounted system cost'
1327     eYearlyTotalCost(c,y)           'Aggregate annual cost at country level'
1328     eYearlyVOMCost(z,y)             'Variable O&M spend by zone'
1329     eYearlySpinningReserveCost(z,y) 'Cost of holding spinning reserves'
1330     eYearlyUSECost(z,y)             'Penalty on unserved demand'
1331     eYearlyExternalTradeCost(z,y)   'Net external trade cost (imports minus exports)'
1332     eYearlyUnmetReserveCostCountry(c,y) 'Combined reserve shortfall penalty'
1333     eYearlyCarbonCost(z,y)          'Carbon-price cost for zone emissions'
1334     eYearlyFOMCost(z,y)                'Total yearly FOM cost'
1335     eYearlyCO2BackstopCostCountry(c,y) 'Cost of CO₂ backstop'
1336     eYearlyVariableCost(z,y)        'Sum of fuel, VOM, and startup costs'
1337     eYearlyStartupCost(z,y)          'Startup cost report when enabled'
1338     eYearlyStartupCostOff(z,y)       'Zero startup cost when disabled'
1339     eYearlyFuelCost(z,y)            'Fuel expenditure by zone'
1340     eYearlyImportExternalCost(z,y)  'Cost of imports from external zones'
1341     eYearlyExportExternalCost(z,y)  'Revenue from power exported externally'
1342     eYearlyUnmetSpinningReserveCostCountry(c,y) 'Country spinning reserve shortfall cost'
1343     eYearlyUnmetPlanningReserveCostCountry(c,y) 'Country planning reserve shortfall cost'
1344     eYearlyUnmetPlanningReserveCostSystem(y) 'System planning reserve shortfall cost'
1345     eYearlyUnmetSpinningReserveCostSystem(y) 'System spinning reserve shortfall cost'
1346     eYearlyCO2BackstopCostsSystem(y) 'System CO₂ backstop expenditure'
1347   
1348  * ------------------------------
1349  * Annualized CAPEX tracking
1350  * Handles annualization of generator CAPEX for trajectory and flat-cost assets.
1351  * ------------------------------
1352     eTotalAnnualizedCapex(z,y)     'Accumulate annualized CAPEX by zone'
1353     eAnnualizedCapexInit(g,y)      'Initial annualized CAPEX for trajectory assets'
1354     eAnnualizedCapexUpdate(g,y)    'Recursive update of annualized CAPEX'
1355     eTotalAnnualizedGenCapex(g,y)  'Annualized CAPEX per generator'
1356   
1357  * ------------------------------
1358  * Demand balance and supply definition
1359  * Ensures zonal demand is met by generation, flows, storage, and trade.
1360  * ------------------------------
1361     eDemSupply(z,q,d,t,y)          'Demand equals total supply'
1362     eDefineSupply(z,q,d,t,y)       'Supply components (gen/flows/storage)'
1363     eMaxHourlyExportShareEnergy(c,q,d,t,y) 'Limit hourly exports as demand share'
1364     eMaxHourlyImportShareEnergy(c,q,d,t,y) 'Limit hourly imports as demand share'
1365   
1366  * ------------------------------
1367  * Capacity evolution
1368  * Updates installed capacity over time for existing and new units, including discrete builds.
1369  * ------------------------------
1370     eInitialCapacity(g,y)          'Initial capacity accounting'
1371     eCapacityEvolutionExist(g,y)   'Existing unit capacity recursion'
1372     eCapacityEvolutionNew(g,y)     'New unit capacity recursion'
1373     eInitialBuildLimit(g)          'Initial build limit for existing assets'
1374     eBuiltCap(g,y)                 'Link integer build variable to capacity'
1375     eRetireCap(g,y)                'Link integer retirement variable to capacity'
1376   
1377  * ------------------------------
1378  * Generation operating limits
1379  * Applies minimum output, availability, and VRE profile constraints.
1380  * ------------------------------
1381     eMinGenRE(c,y)                 'Country minimum renewable generation'
1382     eMaxCF(g,q,y)                  'Capacity factor ceiling'
1383     eMinGen(g,q,d,t,y)             'Minimum dispatch requirement'
1384     eDispatchMinGenPoint(g,q,d,t,y) 'Dispatch minimum generation tied to commitment'
1385     eDispatchMaxGenPoint(g,q,d,t,y) 'Dispatch maximum output tied to commitment'
1386   
1387  * ------------------------------
1388  * Fuel and resource limits
1389  * Tracks fuel usage and enforces optional availability caps by country.
1390  * ------------------------------
1391     eFuel(z,f,y)                   'Fuel consumption accounting'
1392     eFuelLimit(c,f,y)              'Fuel availability constraint'
1393   
1394  * ------------------------------
1395  * Ramp and reserve constraints
1396  * Applies ramp-rate limits and spinning/planning reserve requirements.
1397  * ------------------------------
1398     eRampUpLimit(g,q,d,t,y)        'Ramp-up constraint'
1399     eRampDnLimit(g,q,d,t,y)        'Ramp-down constraint'
1400     eRampContinuity(g,q,d,t,AT,y)   'Tie hourly dispatch to chronological slots'
1401     eDispatchRampUpLimit(g,AT,y)    'Dispatch ramp-up limit across chronological slots'
1402     eDispatchRampDownLimit(g,AT,y)  'Dispatch ramp-down limit across chronological slots'
1403     eSpinningReserveLim(g,q,d,t,y) 'Reserve capability vs capacity'
1404     eSpinningReserveLimVRE(g,f,q,d,t,y) 'Reserve limit adjusted for VRE profile'
1405     eJointResCap(g,q,d,t,y)        'Joint dispatch-reserve envelope'
1406     eSpinningReserveReqCountry(c,q,d,t,y) 'Country spinning reserve requirement'
1407     eSpinningReserveReqSystem(q,d,t,y) 'System spinning reserve requirement'
1408     ePlanningReserveReqSystem(y)   'System planning reserve requirement'
1409     ePlanningReserveReqCountry(c,y) 'Country planning reserve requirement'
1410   
1411  * ------------------------------
1412  * Transmission and trade constraints
1413  * Bounds internal transfers and external exchanges (hourly and annual).
1414  * ------------------------------
1415     eTransferCapacityLimit(z,z2,q,d,t,y) 'Transmission capacity limit'
1416     eMinImportRequirement(z2,z,q,d,t,y) 'Minimum flow requirement if specified'
1417     eVREProfile(g,f,z,q,d,t,y)      'Follow VRE production profile with slack'
1418     eMaxAnnualImportShareEnergy(c,y) 'Annual import share cap'
1419     eMaxAnnualExportShareEnergy(c,y) 'Annual export share cap'
1420     eYearlySurplusCost(z,y)         'Penalty on surplus energy'
1421     eCumulativeTransferExpansion(z,z2,y) 'Cumulative new transfer capacity'
1422     eSymmetricTransferBuild(z,z2,y) 'Symmetric new build requirement'
1423     eAnnualizedTransmissionCapex (z,y) 'Annualized transmission CAPEX'
1424     eExternalImportLimit(z,zext,q,d,t,y) 'Import limit from external zone (MW)'
1425     eExternalExportLimit(z,zext,q,d,t,y) 'Export limit to external zone (MW)'
1426   
1427  * ------------------------------
1428  * Capital & emissions
1429  * Enforces capital budget and CO₂ caps with backstop slack variables.
1430  * ------------------------------
1431     eCapitalConstraint              'Enforce overall capital budget (legacy name)'
1432     eZonalEmissions(z,y)            'Compute zonal CO₂ emissions'
1433     eEmissionsCountry(c,y)          'Country CO₂ cap with backstop slack'
1434     eTotalEmissions(y)              'Aggregate emissions across zones'
1435     eTotalEmissionsConstraint(y)    'System-wide CO₂ cap with backstop'
1436   
1437  * ------------------------------
1438  * Storage operations
1439  * Controls storage charging, SOC evolution, and reserve support obligations.
1440  * ------------------------------
1441     eChargeRampDownLimit(g,q,d,t,y) 'Limit decrease in storage charging'
1442     eChargeRampUpLimit(g,q,d,t,y)   'Limit increase in storage charging'
1443     eYearlyCurtailmentCost(z,y)     'Curtailment penalty (zone)'
1444  *  eSOCCycleClosure(g,q,d,t,y)
1445  *  eDailyStorageEnergyBalance(g,q,d,y)
1446     eSOCSupportsReserve(g,q,d,t,y)  'Ensure SOC can cover reserve commitment'
1447     eChargeCapacityLimit(g,q,d,t,y) 'Charging limited by power capacity'
1448     eChargeLimitWithPVProfile(g,q,d,t,y) 'PV-coupled storage charging limit'
1449     eNetChargeBalance(g,q,d,t,y)    'Net storage discharge minus charge'
1450     eSOCUpperBound(g,q,d,t,y)       'State of charge upper bound'
1451     eStorageCapMinConstraint(g,q,d,t,y) 'Minimum storage energy duration'
1452     eStorageHourTransition
1453     eStorageDayWrap(g,q,d,t,AT,y) 'Dispatch-only wrap using previous chronological hour'
1454     eStorageSOCInitDispatch
1455     eStorageSOCFinalDispatch
1456     eStateOfChargeInitRep
1457   
1458  * ------------------------------
1459  * CSP-specific and storage capacity evolution
1460  * Governs CSP thermal/storage balances and long-term storage capacity updates.
1461  * ------------------------------
1462     eCSPStorageCapacityLimit(g,q,d,t,y) 'CSP storage <= installed capacity'
1463     eCSPStorageInjectionLimit(g,q,d,t,y) 'Limit CSP charging to thermal output'
1464     eCSPStorageInjectionCap(g,q,d,t,y) 'CSP charging bounded by capacity'
1465     eCSPThermalOutputLimit(g,q,d,t,y) 'Thermal output limited by field capacity'
1466     eCSPPowerBalance(g,q,d,t,y)     'Thermal/storage/power balance for CSP'
1467     eCSPStorageEnergyBalance(g,q,d,t,y) 'CSP storage state-of-charge recursion'
1468     eCSPStorageInitialBalance(g,q,d,t,y) 'Initial CSP storage state'
1469     eCapacityStorLimit(g,y)         'Cap storage energy capacity'
1470     eCapStorBalance(g,y)            'Initial storage capacity balance'
1471     eCapStorAnnualUpdateEG(g,y)     'Storage capacity recursion (existing)'
1472     eCapStorAnnualUpdateNG(g,y)     'Storage capacity recursion (new)'
1473     eCapStorInitialNG(g,y)          'Initial storage for new plants'
1474     eBuildStorNew(g)                'Limit storage builds for entrants'
1475     eCapacityThermLimit(g,y)        'CSP thermal capacity cap'
1476     eCapThermBalance1(g,y)          'Thermal capacity recursion (existing)'
1477     eCapThermBalance2(g,y)          'Thermal capacity recursion (new)'
1478     eCapThermBalance3(g,y)          'Initial thermal capacity for new units'
1479     eBuildThermNew(g)               'Limit CSP thermal builds for entrants'
1480   
1481   
1482  * ------------------------------
1483  * Unit-commitment transition equations
1484  * ------------------------------
1485     eCommitmentConsistency 'Keeps each hour’s on/off change consistent with the recorded startup/shutdown activity'
1486     eCommitmentInitialization 'Applies the same accounting for the first chronological slot using the initial status'
1487     eCommitmentSingleTransition 'Prevents multiple start/shutdown actions within a single chronological slot'
1488     eStartupCostConstraint(g,q,d,t,y) 'Aggregate startup cost per representative timeslice'
1489     eMinUpInitial(g,y) 'Initial minimum up-time accounting'
1490     eMinUpRolling(g,AT2,y) 'Rolling minimum up-time enforcement for startups'
1491     eMinDownInitial(g,y) 'Initial minimum down-time accounting'
1492     eMinDownRolling(g,AT2,y) 'Rolling minimum down-time enforcement for shutdowns'
1493  ;
1494   
1495   
1496  *-------------------------------------------------------------------
1497  * OBJECTIVE FUNCTION
1498  *-------------------------------------------------------------------
1499  * Adding system-level cost of reserves and CO2 backstop to the total cost
1500  eNPVCost..
1501     vNPVCost =e= sum(y, pRR(y)*pWeightYear(y)*(sum(c,
1502                                   vYearlyTotalCost(c,y)) +
1503                                   vYearlyUnmetPlanningReserveCostSystem(y) +
1504                                   vYearlyUnmetSpinningReserveCostSystem(y) +
1505                                   vYearlyCO2BackstopCostSystem(y))
1506                                   );
1507   
1508  *-------------------------------------------------------------------
1509  * 1. COST
1510  *-------------------------------------------------------------------
1511  * ------------------------------
1512  * System-level Cost accounting
1513  * ------------------------------
1514   
1515  eYearlyUnmetPlanningReserveCostSystem(y)..
1516     vYearlyUnmetPlanningReserveCostSystem(y) =e= vUnmetPlanningReserveSystem(y)*pPlanningReserveVoLL;
1517   
1518  eYearlyUnmetSpinningReserveCostSystem(y)..
1519     vYearlyUnmetSpinningReserveCostSystem(y) =e= sum((q,d,t), vUnmetSpinningReserveSystem(q,d,t,y)*pHours(q,d,t)*pSpinningReserveVoLL);
1520   
1521  eYearlyCO2BackstopCostsSystem(y)..
1522     vYearlyCO2BackstopCostSystem(y) =e= vYearlySysCO2backstop(y)*pCostOfCO2backstop;
1523   
1524  * Note capex is full capex in $m per MW. Also note VarCost includes fuel cost and VOM -
1525  * essentially the short run marginal cost for the generator
1526   
1527  * Adding country-level cost of reserves and CO2 backstop to the total cost
1528  eYearlyTotalCost(c,y)..
1529     vYearlyTotalCost(c,y) =e= vYearlyUnmetReserveCostCountry(c,y)+ vYearlyCO2BackstopCostCountry(c,y)
1530                             + sum(zcmap(z,c), vAnnCapex(z, y)
1531                                             + vYearlyFOMCost(z, y)
1532                                             + vYearlyVariableCost(z,y)
1533                                             + vYearlySpinningReserveCost(z,y)
1534                                             + vYearlyUSECost(z,y)
1535                                             + vYearlyCarbonCost(z,y)
1536                                             + vYearlyExternalTradeCost(z,y)
1537                                             + vAnnualizedTransmissionCapex(z,y)
1538                                             + vYearlyCurtailmentCost(z,y)
1539                                             + vYearlySurplus(z,y));
1540   
1541  * ------------------------------
1542  * Country-level Cost accounting
1543  * ------------------------------
1544   
1545  * Yearly unmet reserve cost at the country level
1546  eYearlyUnmetReserveCostCountry(c,y)..
1547     vYearlyUnmetReserveCostCountry(c,y) =e= vYearlyUnmetPlanningReserveCostCountry(c,y) + vYearlyUnmetSpinningReserveCostCountry(c,y);
1548   
1549  * Yearly unmet spinning reserve cost at the country level
1550  eYearlyUnmetSpinningReserveCostCountry(c,y)..
1551     vYearlyUnmetSpinningReserveCostCountry(c,y) =e= sum((q,d,t), vUnmetSpinningReserveCountry(c,q,d,t,y)*pHours(q,d,t)*pSpinningReserveVoLL);
1552   
1553  * Yearly unmet planning reserve cost at the country level
1554  eYearlyUnmetPlanningReserveCostCountry(c,y)..
1555     vYearlyUnmetPlanningReserveCostCountry(c,y) =e= vUnmetPlanningReserveCountry(c,y)*pPlanningReserveVoLL;
1556   
1557  * Yearly CO2 backstop cost at the country level
1558  eYearlyCO2BackstopCostCountry(c,y)..
1559     vYearlyCO2BackstopCostCountry(c,y) =e= vYearlyCO2backstop(c,y)*pCostOfCO2backstop;
1560   
1561  * ------------------------------
1562  * Zonal CAPEX accounting
1563  * Aggregates generator-level annualized CAPEX to the zone level.
1564  * ------------------------------
1565  * Annualized CAPEX for all zones in year y
1566  eTotalAnnualizedCapex(z, y)..
1567     vAnnCapex(z,y) =e= sum(gzmap(g,z), vAnnGenCapex(g,y));
1568   
1569  * Annualized CAPEX for all generators in year y
1570  * Separate treatment keeps time-varying CAPEX trajectories (dc) distinct
1571  * from flat-cost assets (ndc) when annualizing capital costs.
1572  * Assets tagged in set dc(g) follow time-varying CAPEX trajectories (stored
1573  * in vAnnCapexGenTraj), while flat-cost assets (ndc(g)) use
1574  * conventional CRF-based annualization. We keep both paths to preserve the
1575  * different depreciation logic without double-counting.
1576  eTotalAnnualizedGenCapex(g,y)..
1577     vAnnGenCapex(g,y) =e=
1578         vAnnCapexGenTraj(g,y)$(dc(g) and ng(g))
1579       + pCRF(g)*vCap(g,y)*pGenData(g,"Capex")*1e6$(ndc(g) and ng(g))
1580       + pCRFsst(g)*vCapStor(g,y)*pStorageData(g,"CapexMWh")*1e3$(ndc(g) and ng(g) and not cs(g))
1581       + pCRFcst(g)*vCapStor(g,y)*pCSPData(g,"Storage","CapexMWh")*1e3$(ndc(g) and ng(g) and not st(g))
1582       + pCRFcth(g)*vCapTherm(g,y)*pCSPData(g,"Thermal Field","CapexMWh")*1e6$(ndc(g) and ng(g));
1583   
1584  * Annualized CAPEX accumulation (years after the start year) for generators with capex trajectory
1585  eAnnualizedCapexUpdate(dc,y)$(not sStartYear(y))..
1586     vAnnCapexGenTraj(dc,y) =e= vAnnCapexGenTraj(dc,y-1)
1587                       + vBuild(dc,y)*pGenData(dc,"Capex")*pCapexTrajectories(dc,y)*pCRF(dc)*1e6
1588                       + vBuildStor(dc,y)*pStorageData(dc,"CapexMWh")*pCapexTrajectories(dc,y)*pCRFsst(dc)*1e3
1589                       + vBuildStor(dc,y)*pCSPData(dc,"Storage","CapexMWh")*pCapexTrajectories(dc,y)*pCRFcst(dc)*1e3
1590                       + vBuildTherm(dc,y)*pCSPData(dc,"Thermal Field","CapexMWh")*pCapexTrajectories(dc,y)*pCRFcth(dc)*1e6;
1591   
1592  * Initial annualized CAPEX in the start year for generators with capex trajectory
1593  eAnnualizedCapexInit(dc,sStartYear(y))..
1594     vAnnCapexGenTraj(dc,y) =e=
1595         vBuild(dc,y)     *pGenData(dc,"Capex")        *pCapexTrajectories(dc,y)*pCRF(dc)   *1e6
1596       + vBuildStor(dc,y) *pStorageData(dc,"CapexMWh")    *pCapexTrajectories(dc,y)*pCRFsst(dc)*1e3
1597       + vBuildStor(dc,y) *pCSPData(dc,"Storage","CapexMWh")*pCapexTrajectories(dc,y)*pCRFcst(dc)*1e3
1598       + vBuildTherm(dc,y)*pCSPData(dc,"Thermal Field","CapexMWh")*pCapexTrajectories(dc,y)*pCRFcth(dc)*1e6;
1599   
1600  * FOM costs including fixed O&M costs for generators, storage, and CSP thermal field
1601  eYearlyFOMCost(z,y)..
1602     vYearlyFOMCost(z,y) =e= sum(gzmap(g,z),  vCap(g,y)*pGenData(g,"FOMperMW"))
1603              + sum(gzmap(st,z), vCapStor(st,y)*pStorageData(st,"FixedOMMWh"))
1604              + sum(gzmap(cs,z), vCapStor(cs,y)*pCSPData(cs,"Storage","FixedOMMWh"))
1605              + sum(gzmap(cs,z), vCapTherm(cs,y)*pCSPData(cs,"Thermal field","FixedOMMWh"));
1606   
1607  * Variable costs equals fuel cost plus VOM cost
1608  eYearlyVariableCost(z,y)..
1609     vYearlyVariableCost(z,y) =e= vYearlyFuelCost(z,y) + vYearlyVOMCost(z,y) + vYearlyStartupCost(z,y);
1610   
1611  * Annualized startup cost pulled from dispatch slots (links to time-sliced variable).
1612  eYearlyStartupCost(z,y)$((fDispatchMode and fApplyStartupCost))..
1613     vYearlyStartupCost(z,y) =e= sum((gzmap(g,z),q,d,t)$MinGenPoint(g),
1614           vStartupCost(g,q,d,t,y)*pHours(q,d,t));
1615   
1616  * If startup costs are disabled, force the reporting variable to zero.
1617  eYearlyStartupCostOff(z,y)$(fDispatchMode=0 or fApplyStartupCost=0)..
1618     vYearlyStartupCost(z,y) =e= 0;
1619  *  Startup cost flows through the same time-slice weighting as the rest of the variable cost stack.
1620   
1621  * Fuel costs
1622  eYearlyFuelCost(z,y)..
1623     vYearlyFuelCost(z,y) =e= sum((gzmap(g,z),f,q,d,t), pFuelCost(g,f,y)*vPwrOut(g,f,q,d,t,y)*pHours(q,d,t));
1624   
1625  * VOM
1626  eYearlyVOMCost(z,y)..
1627     vYearlyVOMCost(z,y) =e= sum((gzmap(g,z),f,q,d,t), pVOMCost(g,f,y)*vPwrOut(g,f,q,d,t,y)*pHours(q,d,t));
1628   
1629  * Note: ReserveCost is in $/MWh -- this is the DIRECT cost of holding reserve like wear and tear that a generator bids in a market
1630  eYearlySpinningReserveCost(z,y)..
1631     vYearlySpinningReserveCost(z,y) =e= sum((gzmap(g,z),q,d,t), vSpinningReserve(g,q,d,t,y)*pGenData(g,"ReserveCost")*pHours(q,d,t));
1632   
1633  * Unserved energy cost (USE)
1634  eYearlyUSECost(z,y)..
1635     vYearlyUSECost(z,y) =e= sum((q,d,t), vUSE(z,q,d,t,y)*pVoLL*pHours(q,d,t));
1636   
1637  * Surplus cost
1638  eYearlySurplusCost(z,y)..
1639     vYearlySurplus(z,y) =e= sum((q,d,t), vSurplus(z,q,d,t,y)*pSurplusPenalty*pHours(q,d,t));
1640   
1641  * Curtailment cost
1642  eYearlyCurtailmentCost(z,y)..
1643     vYearlyCurtailmentCost(z,y) =e= sum((gzmap(g,z),q,d,t), vCurtailedVRE(z,g,q,d,t,y)*pCostOfCurtailment*pHours(q,d,t));
1644   
1645  * Yearly trade cost
1646  eYearlyExternalTradeCost(z,y)..
1647     vYearlyExternalTradeCost(z,y) =e= vYearlyImportExternalCost(z,y) - vYearlyExportExternalCost(z,y);
1648   
1649  * Yearly import and export costs from external zones
1650  eYearlyImportExternalCost(z,y)..
1651     vYearlyImportExternalCost(z,y) =e= sum((zext,q,d,t), vYearlyImportExternal(z,zext,q,d,t,y)*pTradePrice(zext,q,d,y,t)*pHours(q,d,t));
1652   
1653  * Yearly export cost to external zones
1654  eYearlyExportExternalCost(z,y)..
1655     vYearlyExportExternalCost(z,y) =e= sum((zext,q,d,t), vYearlyExportExternal(z,zext,q,d,t,y)*pTradePrice(zext,q,d,y,t)*pHours(q,d,t));
1656   
1657  * Yearly CO2 emissions cost for each zone
1658  eYearlyCarbonCost(z,y)..
1659     vYearlyCarbonCost(z,y) =e= fEnableCarbonPrice*pCarbonPrice(y)
1660                              * Sum((gzmap(g,z),gfmap(g,f),q,d,t), vPwrOut(g,f,q,d,t,y)*pHeatRate(g,f)*pFuelCarbonContent(f)*pHours(q,d,t));
1661   
1662   
1663  * Ensures that when accessing parameters like CostPerLine or Life for a connection between zones i and j,
1664  * the model always uses the maximum of both directions, regardless of ordering.
1665  $macro symmax(s,i,j,h) max(s(i,j,h),s(j,i,h))
1666   
1667  * Computes annualized investment cost of new transmission lines connected to zone z
1668  * using the annuity formula and averaging (divided by 2) to avoid double-counting symmetric lines
1669  eAnnualizedTransmissionCapex(z,y)$(fAllowTransferExpansion and sum(sTopology(z,z2),1))..
1670     vAnnualizedTransmissionCapex(z,y) =e=
1671         sum(sTopology(z,z2),
1672             vNewTransmissionLine(z,z2,y)
1673           * max(pNewTransmission(z,z2,"CostPerLine"),pNewTransmission(z2,z,"CostPerLine"))
1674           * 1e6)
1675       / 2
1676       * (pWACC / (1 - (1 / ((1 + pWACC) ** sum(sTopology(z,z2), max(pNewTransmission(z,z2,"Life"),pNewTransmission(z2,z,"Life")))))));
1677   
1678  * ------------------------------
1679  * Demand and supply balance
1680  * Ensures zonal demand matches supply components.
1681  * ------------------------------
1682  eDemSupply(z,q,d,t,y)$FD(q,d,t)..
1683     pDemandData(z,q,d,y,t) * pEnergyEfficiencyFactor(z,y) =e= vSupply(z,q,d,t,y);
1684   
1685  eDefineSupply(z,q,d,t,y)$FD(q,d,t)..
1686     vSupply(z,q,d,t,y) =e=
1687       sum((gzmap(g,z),gfmap(g,f)), vPwrOut(g,f,q,d,t,y))
1688     - sum(sTopology(z,z2), vFlow(z,z2,q,d,t,y))
1689     + sum(sTopology(z,z2), vFlow(z2,z,q,d,t,y) * (1 - pLossFactorInternal(z,z2,y)))
1690     - sum(gzmap(st,z), vStorInj(st,q,d,t,y))$(fEnableStorage)
1691     + sum(zext, vYearlyImportExternal(z,zext,q,d,t,y))
1692     - sum(zext, vYearlyExportExternal(z,zext,q,d,t,y))
1693     + vUSE(z,q,d,t,y)
1694     - vSurplus(z,q,d,t,y);
1695   
1696   
1697  * ------------------------------
1698  * Generator capacity equations
1699  * Tracks installed capacity for existing/new units.
1700  * ------------------------------
1701  * Initial capacity balance in the first model year
1702  eInitialCapacity(g,sStartYear(y))..
1703     vCap(g,y) =e= pGenData(g,"Capacity")$(eg(g) and (pGenData(g,"StYr") <= sStartYear.val))
1704                 + vBuild(g,y) - vRetire(g,y);
1705   
1706  * Year-on-year capacity tracking for existing generators
1707  eCapacityEvolutionExist(eg,y)$(not sStartYear(y))..
1708     vCap(eg,y) =e= vCap(eg,y-1) + vBuild(eg,y) - vRetire(eg,y);
1709   
1710  * Year-on-year capacity tracking for new generators (non-retirable)
1711  eCapacityEvolutionNew(ng,y)$(not sStartYear(y))..
1712     vCap(ng,y) =e= vCap(ng,y-1) + vBuild(ng,y);
1713   
1714  * Limit on initial build for new generators (starting after model year 1)
1715  eInitialBuildLimit(eg)$(pGenData(eg,"StYr") > sStartYear.val)..
1716     sum(y, vBuild(eg,y)) =l= pGenData(eg,"Capacity");
1717   
1718  eMinGenRE(c,y)$(pMinRE and y.val >= pMinsRenewableTargetYear)..
1719     sum((zcmap(z,c),gzmap(RE,z),gfmap(RE,f),q,d,t), vPwrOut(RE,f,q,d,t,y)*pHours(q,d,t)) =g=
1720     sum((zcmap(z,c),q,d,t), pDemandData(z,q,d,y,t)*pHours(q,d,t)*pEnergyEfficiencyFactor(z,y))*pMinRE;
1721   
1722  eBuiltCap(ng,y)$pGenData(ng,"DescreteCap")..
1723     vBuild(ng,y) =e= pGenData(ng,"UnitSize")*vBuiltCapVar(ng,y);
1724   
1725  eRetireCap(eg,y)$(pGenData(eg,"DescreteCap") and (y.val <= pGenData(eg,"RetrYr")))..
1726     vRetire(eg,y) =e= pGenData(eg,"UnitSize")*vRetireCapVar(eg,y);
1727   
1728  * ------------------------------
1729  * Production equations
1730  * Constrains generator dispatch, ramping, and minimum output.
1731  * ------------------------------
1732  * Enforces dispatch/reserve only when the generator is committed for the chronological slot.
1733  eJointResCap(g,q,d,t,y)$FD(q,d,t)..
1734     sum(gfmap(g,f), vPwrOut(g,f,q,d,t,y)) + vSpinningReserve(g,q,d,t,y)
1735        =l= vCap(g,y)*(1+pGenData(g,"Overloadfactor"));
1736   
1737  eMaxCF(g,q,y)..
1738     sum((gfmap(g,f),d,t), vPwrOut(g,f,q,d,t,y)*pHours(q,d,t)) =l= pAvailability(g,y,q)*vCap(g,y)*sum((d,t), pHours(q,d,t));
1739   
1740  * Note that we are effectively assuming grid-connected RE generation to be dispatchable. Generally speaking, most RE will be
1741  * dispatched anyway because they have zero cost (i.e., not a different outcome from net load approach, but this allows for
1742  * RE generation to be rejected as well
1743  eVREProfile(gfmap(VRE,f),z,q,d,t,y)$(gzmap(VRE,z) and FD(q,d,t))..
1744     vPwrOut(VRE,f,q,d,t,y) + vCurtailedVRE(z,VRE,q,d,t,y) =e= pVREgenProfile(VRE,q,d,t)*vCap(VRE,y);
1745   
1746  eFuel(zfmap(z,f),y)..
1747     vFuel(z,f,y) =e= sum((gzmap(g,z),gfmap(g,f),q,d,t), vPwrOut(g,f,q,d,t,y)*pHours(q,d,t)*pHeatRate(g,f));
1748   
1749  eFuelLimit(c,f,y)$(fApplyFuelConstraint and pMaxFuelLimit(c,f,y) > 0)..
1750     sum((zcmap(z,c),zfmap(z,f)), vFuel(z,f,y)) =l= pMaxFuelLimit(c,f,y)*1e6;
1751   
1752  * Applies the minimum output requirement per capacity share.
1753  eMinGen(g,q,d,t,y)$((fApplyMinGenShareAllHours and pGenData(g,"MinGenShareAllHours") > 0) and FD(q,d,t))..
1754      sum(gfmap(g,f), vPwrOut(g,f,q,d,t,y)) =g= vCap(g,y)*pGenData(g,"MinGenShareAllHours");
1755   
1756  * ------------------------------
1757  * Unit-commitment transition equations
1758  * Ensures the recorded on/off state matches startups/shutdowns and forbids more than one transition per slot.
1759  * Since the state alone cannot capture how many switches occurred, we introduce startup/shutdown binaries alongside `isOn`.
1760  * ------------------------------
1761   
1762  * Dispatch-mode minimum generation only when the generator is recorded as online.
1763  eDispatchMinGenPoint(g,q,d,t,y)$((fDispatchMode and fApplyMinGenCommitment and MinGenPoint(g) and FD(q,d,t)))..
1764     sum(gfmap(g,f), vPwrOut(g,f,q,d,t,y))
1765        =g= pGenData(g,"MinGenCommitment")*pGenData(g,"Capacity")
1766            * sum(AT$mapTS(q,d,t,AT), isOn(g,q,d,t,AT,y));
1767   
1768  * Prevents exceeding capacity while the generator reports being online in dispatch slots.
1769  eDispatchMaxGenPoint(g,q,d,t,y)$((fDispatchMode and fApplyMinGenCommitment and MinGenPoint(g) and FD(q,d,t)))..
1770     sum(gfmap(g,f), vPwrOut(g,f,q,d,t,y))
1771        =l= pGenData(g,"Capacity")*sum(AT$mapTS(q,d,t,AT), isOn(g,q,d,t,AT,y));
1772   
1773  * Keeps each hour’s on/off change consistent with the recorded startup/shutdown activity.
1774  eCommitmentConsistency(g,AT,y)$(ord(AT) > 1 and fDispatchMode and fApplyMinGenCommitment and MinGenPoint(g))..
1775     sum((q,d,t)$mapTS(q,d,t,AT), isStartup(g,q,d,t,AT,y) - isShutdown(g,q,d,t,AT,y))
1776        =e= sum((q,d,t)$mapTS(q,d,t,AT), isOn(g,q,d,t,AT,y))
1777           - sum((q,d,t)$mapTS(q,d,t,AT-1), isOn(g,q,d,t,AT-1,y));
1778   
1779  * Applies the same accounting for the first chronological slot using the initial status.
1780  eCommitmentInitialization(g,AT,y)$(ord(AT) = 1 and fDispatchMode and fApplyMinGenCommitment and MinGenPoint(g))..
1781     sum((q,d,t)$mapTS(q,d,t,AT), isStartup(g,q,d,t,AT,y) - isShutdown(g,q,d,t,AT,y))
1782        =e= sum((q,d,t)$mapTS(q,d,t,AT), isOn(g,q,d,t,AT,y)) - pInitialOnStart(g);
1783   
1784  * Prevents multiple start/shutdown actions within a single chronological slot.
1785  eCommitmentSingleTransition(g,AT,y)$(fDispatchMode and fApplyMinGenCommitment and MinGenPoint(g))..
1786     sum((q,d,t)$mapTS(q,d,t,AT), isStartup(g,q,d,t,AT,y) + isShutdown(g,q,d,t,AT,y)) =l= 1;
1787   
1788  * ------------------------------
1789  * Minimum up/down-time constraints
1790  * ------------------------------
1791  * Initial minimum up-time: if HoursOn > 0, force the remaining required online hours.
1792  eMinUpInitial(g,y)$(fDispatchMode and fApplyMUDT and fApplyMinGenCommitment and MinGenPoint(g) and pGenData(g,"HoursOn")
1793        and pGenData(g,"HoursOff") = 0 and pGenData(g,"minUT") > 0.999)..
1794     sum(AT$(ord(AT) < (pGenData(g,"minUT") - pGenData(g,"HoursOn") + 1)),
1795         sum((q,d,t)$mapTS(q,d,t,AT), 1 - isOn(g,q,d,t,AT,y))) =e= 0;
1796   
1797  * Rolling minimum up-time: every startup must be followed by minUT consecutive on hours.
1798  eMinUpRolling(g,AT2,y)$(fDispatchMode and fApplyMUDT and fApplyMinGenCommitment and MinGenPoint(g) and pGenData(g,"minUT") > 0.999
1799        and ord(AT2) > (pGenData(g,"minUT") - pGenData(g,"HoursOn") + 1)$pGenData(g,"HoursOn")
1800        and ord(AT2) < (card(AT2) - pGenData(g,"minUT") + 1))..
1801     sum(AT$((ord(AT) >= ord(AT2)) and (ord(AT) < ord(AT2) + pGenData(g,"minUT"))),
1802         sum((q,d,t)$mapTS(q,d,t,AT), isOn(g,q,d,t,AT,y)))
1803        =g= pGenData(g,"minUT") * sum((q,d,t)$mapTS(q,d,t,AT2), isStartup(g,q,d,t,AT2,y));
1804   
1805  * Initial minimum down-time: if HoursOff > 0, force the remaining offline hours.
1806  eMinDownInitial(g,y)$(fDispatchMode and fApplyMUDT and fApplyMinGenCommitment and MinGenPoint(g) and pGenData(g,"HoursOn") = 0
1807        and pGenData(g,"HoursOff") and pGenData(g,"minDT") > 0.999)..
1808     sum(AT$(ord(AT) < (pGenData(g,"minDT") - pGenData(g,"HoursOff") + 1)),
1809         sum((q,d,t)$mapTS(q,d,t,AT), isOn(g,q,d,t,AT,y))) =e= 0;
1810   
1811  * Rolling minimum down-time: every shutdown must be followed by minDT consecutive off hours.
1812  eMinDownRolling(g,AT2,y)$(fDispatchMode and fApplyMUDT and fApplyMinGenCommitment and MinGenPoint(g) and pGenData(g,"minDT") > 0.999
1813        and ord(AT2) > (pGenData(g,"minDT") - pGenData(g,"HoursOff") + 1)$pGenData(g,"HoursOff")
1814        and ord(AT2) < (card(AT2) - pGenData(g,"minDT") + 1))..
1815     sum(AT$((ord(AT) >= ord(AT2)) and (ord(AT) < ord(AT2) + pGenData(g,"minDT"))),
1816         sum((q,d,t)$mapTS(q,d,t,AT), 1 - isOn(g,q,d,t,AT,y)))
1817        =g= pGenData(g,"minDT") * sum((q,d,t)$mapTS(q,d,t,AT2), isShutdown(g,q,d,t,AT2,y));
1818   
1819  * ------------------------------
1820  * Startup-cost translation
1821  * ------------------------------
1822  * Aggregate startup events per representative bucket by summing every chronological `AT` slot that belongs to (q,d,t).
1823  * The resulting cost is tied to the time slice so the variable-cost stack can weight it just like fuel and VOM.
1824  eStartupCostConstraint(g,q,d,t,y)$((fDispatchMode and fApplyMinGenCommitment and MinGenPoint(g) and fApplyStartupCost and FD(q,d,t)))..
1825     vStartupCost(g,q,d,t,y) =e= sum(AT$mapTS(q,d,t,AT), isStartup(g,q,d,t,AT,y)) * pGenData(g,"StUpCost");
1826   
1827  * ------------------------------
1828  * Dispatch-level ramping continuity
1829  * ------------------------------
1830   
1831  eRampDnLimit(g,q,d,t,y)$((Ramprate(g) and not sFirstHour(t) and fApplyRampConstraint and fDispatchMode=0) and FD(q,d,t))..
1832     sum(gfmap(g,f), vPwrOut(g,f,q,d,t-1,y)) - sum(gfmap(g,f), vPwrOut(g,f,q,d,t,y)) =l= vCap(g,y)*pGenData(g,"RampDnRate");
1833   
1834  eRampUpLimit(g,q,d,t,y)$((Ramprate(g) and not sFirstHour(t) and fApplyRampConstraint and fDispatchMode=0) and FD(q,d,t))..
1835     sum(gfmap(g,f), vPwrOut(g,f,q,d,t,y)) - sum(gfmap(g,f), vPwrOut(g,f,q,d,t-1,y)) =l= vCap(g,y)*pGenData(g,"RampUpRate");
1836   
1837  * Tie the chronological slot totals to the underlying hourly dispatch so that ramp limits can aggregate across AT.
1838  eRampContinuity(g,q,d,t,AT,y)$((Ramprate(g) and fApplyRampConstraint and fDispatchMode) and mapTS(q,d,t,AT))..
1839     sum(gfmap(g,f), vPwrOut(g,f,q,d,t,y)) =e= vPwrOutDispatch(g,q,d,t,AT,y);
1840   
1841  * Ensure ramp-up across consecutive AT slots respects the ramp rate plus any additional headroom from startups when min-gen constraints are active.
1842  eDispatchRampUpLimit(g,AT,y)$((not sFirstHourAT(AT) and Ramprate(g) and fApplyRampConstraint and fDispatchMode))..
1843     sum((q,d,t)$mapTS(q,d,t,AT), vPwrOutDispatch(g,q,d,t,AT,y))
1844     - sum((q,d,t)$mapTS(q,d,t,AT-1), vPwrOutDispatch(g,q,d,t,AT-1,y))
1845            =l= sum((q,d,t)$mapTS(q,d,t,AT), isStartup(g,q,d,t,AT,y))*pGenData(g,"Capacity")$(fApplyMinGenCommitment and MinGenPoint(g))
1846            + vCap(g,y)*pGenData(g,"RampUpRate");
1847   
1848  * Ensure ramp-down across slots respects ramp-down rates while allowing shutdowns to absorb faster decreases.
1849  eDispatchRampDownLimit(g,AT,y)$((not sFirstHourAT(AT) and Ramprate(g) and fApplyRampConstraint and fDispatchMode))..
1850     sum((q,d,t)$mapTS(q,d,t,AT-1), vPwrOutDispatch(g,q,d,t,AT-1,y))
1851     - sum((q,d,t)$mapTS(q,d,t,AT), vPwrOutDispatch(g,q,d,t,AT,y))
1852            =l= sum((q,d,t)$mapTS(q,d,t,AT), isShutdown(g,q,d,t,AT,y))*pGenData(g,"Capacity")$(fApplyMinGenCommitment and MinGenPoint(g))
1853            + vCap(g,y)*pGenData(g,"RampDnRate");
1854   
1855  * ------------------------------
1856  * Reserve equations
1857  * Enforces spinning and planning reserve requirements.
1858  * ------------------------------
1859  * Spinning reserve limit as a share of capacity
1860  eSpinningReserveLim(g,q,d,t,y)$((fApplyCountrySpinReserveConstraint or fApplySystemSpinReserveConstraint) and FD(q,d,t))..
1861     vSpinningReserve(g,q,d,t,y) =l= vCap(g,y)*pGenData(g,"ResLimShare");
1862   
1863  * Spinning reserve limit for VRE as a share of capacity adjusted for production profile
1864  eSpinningReserveLimVRE(gfmap(VRE,f),q,d,t,y)$((fApplyCountrySpinReserveConstraint or fApplySystemSpinReserveConstraint) and FD(q,d,t))..
1865      vSpinningReserve(VRE,q,d,t,y) =l= vCap(VRE,y)*pGenData(VRE,"ResLimShare")* pVREgenProfile(VRE,q,d,t);
1866   
1867  * This constraint increases solving time x3
1868  * Reserve constraints include interconnections as reserves too
1869  eSpinningReserveReqCountry(c,q,d,t,y)$((fApplyCountrySpinReserveConstraint) and FD(q,d,t))..
1870     sum((zcmap(z,c),gzmap(g,z)),vSpinningReserve(g,q,d,t,y))
1871   + vUnmetSpinningReserveCountry(c,q,d,t,y)
1872  * + sIntercoReserveContributionPct * sum((zcmap(z,c),sMapConnectedZonesDiffCountries(z2,z)), pTransferLimit(z2,z,q,y)
1873  *                                        + vNewTransmissionLine(z2,z,y)*symmax(pNewTransmission,z,z2,"CapacityPerLine")*fAllowTransferExpansion
1874  *                                        - vFlow(z2,z,q,d,t,y))
1875     =g= pSpinningReserveReqCountry(c,y) + sum((zcmap(z,c),gzmap(VRE_noROR,z),gfmap(VRE_noROR,f)), vPwrOut(VRE_noROR,f,q,d,t,y))*psVREForecastErrorPct;
1876   
1877  * System spinning reserve requirement
1878  eSpinningReserveReqSystem(q,d,t,y)$((fApplySystemSpinReserveConstraint) and FD(q,d,t))..
1879     sum(g, vSpinningReserve(g,q,d,t,y)) + vUnmetSpinningReserveSystem(q,d,t,y) =g= pSpinningReserveReqSystem(y) + sum(gfmap(VRE_noROR,f), vPwrOut(VRE_noROR,f,q,d,t,y))*psVREForecastErrorPct;
1880   
1881  * Planning reserve requirement at the country level
1882  ePlanningReserveReqCountry(c,y)$(fApplyPlanningReserveConstraint and pPlanningReserveMargin(c))..
1883     sum((zcmap(z,c),gzmap(g,z)), vCap(g,y)*pCapacityCredit(g,y))
1884   + vUnmetPlanningReserveCountry(c,y)
1885   + (sum((zcmap(z,c),sMapConnectedZonesDiffCountries(z2,z)), sum(q,pTransferLimit(z2,z,q,y))/card(q) + vNewTransmissionLine(z2,z,y)*max(pNewTransmission(z,z2,"CapacityPerLine"),pNewTransmission(z2,z,"CapacityPerLine"))*fAllowTransferExpansion))$fCountIntercoForReserves
1886     =g= (1+pPlanningReserveMargin(c))*smax((q,d,t), sum(zcmap(z,c), pDemandData(z,q,d,y,t)*pEnergyEfficiencyFactor(z,y)));
1887   
1888  * Planning reserve requirement at the system level
1889  ePlanningReserveReqSystem(y)$(fApplyPlanningReserveConstraint and sReserveMarginPct)..
1890     sum(g, vCap(g,y)*pCapacityCredit(g,y)) + vUnmetPlanningReserveSystem(y)
1891     =g= (1+sReserveMarginPct)*smax((q,d,t), sum(z, pDemandData(z,q,d,y,t)*pEnergyEfficiencyFactor(z,y)));
1892   
1893   
1894  * ------------------------------
1895  * Transfer equations
1896  * Limits internal flows and applies trade caps.
1897  * ------------------------------
1898  * Limits flow between zones to existing + expandable transmission capacity
1899  eTransferCapacityLimit(sTopology(z,z2),q,d,t,y)$FD(q,d,t)..
1900     vFlow(z,z2,q,d,t,y) =l= pTransferLimit(z,z2,q,y) + vNewTransmissionLine(z,z2,y)*max(pNewTransmission(z,z2,"CapacityPerLine"),pNewTransmission(z2,z,"CapacityPerLine"))*fAllowTransferExpansion;
1901   
1902  * Enforces minimum import flow into a zone when specified
1903  eMinImportRequirement(sTopology(z,z2),q,d,t,y)$(pMinImport(z2,z,y) and FD(q,d,t))..
1904     vFlow(z2,z,q,d,t,y) =g= pMinImport(z2,z,y);
1905   
1906  * Cumulative build-out of new transfer capacity over time
1907  eCumulativeTransferExpansion(sTopology(z,z2),y)$fAllowTransferExpansion..
1908     vNewTransmissionLine(z,z2,y) =e=  vNewTransmissionLine(z,z2,y-1) + vBuildTransmissionLine(z,z2,y);
1909   
1910  * Ensures symmetry in bidirectional transmission investment
1911  eSymmetricTransferBuild(sTopology(z,z2),y)$fAllowTransferExpansion..
1912     vBuildTransmissionLine(z,z2,y)  =e=  vBuildTransmissionLine(z2,z,y);
1913   
1914  * External trade
1915   
1916  * Caps total import energy based on annual demand and max external trade share
1917  eMaxAnnualImportShareEnergy(c,y)$fEnableExternalExchange..
1918     sum((zcmap(z,c),zext,q,d,t), vYearlyImportExternal(z,zext,q,d,t,y)*pHours(q,d,t)) =l=
1919     sum((zcmap(z,c),q,d,t), pDemandData(z,q,d,y,t)*pHours(q,d,t)*pEnergyEfficiencyFactor(z,y))*pMaxAnnualExternalTradeShare(y,c);
1920   
1921  * Caps total export energy based on annual demand and max external trade share
1922  eMaxAnnualExportShareEnergy(c,y)$fEnableExternalExchange..
1923     sum((zcmap(z,c),zext,q,d,t), vYearlyExportExternal(z,zext,q,d,t,y)*pHours(q,d,t)) =l=
1924     sum((zcmap(z,c),q,d,t), pDemandData(z,q,d,y,t)*pHours(q,d,t)*pEnergyEfficiencyFactor(z,y))*pMaxAnnualExternalTradeShare(y,c);
1925   
1926  * Limits hourly import energy as a share of hourly demand
1927  eMaxHourlyImportShareEnergy(c,q,d,t,y)$((sMaxHourlyImportExternalShare<1 and fEnableExternalExchange) and FD(q,d,t))..
1928     sum((zcmap(z,c), zext), vYearlyImportExternal(z,zext,q,d,t,y))  =l= sum(zcmap(z,c), pDemandData(z,q,d,y,t)*sMaxHourlyImportExternalShare * pEnergyEfficiencyFactor(z,y));
1929   
1930  * Limits hourly export energy as a share of hourly demand
1931  eMaxHourlyExportShareEnergy(c,q,d,t,y)$((sMaxHourlyExportExternalShare<1 and fEnableExternalExchange) and FD(q,d,t))..
1932     sum((zcmap(z,c), zext),vYearlyExportExternal(z,zext,q,d,t,y)) =l= sum(zcmap(z,c), pDemandData(z,q,d,y,t)*sMaxHourlyExportExternalShare * pEnergyEfficiencyFactor(z,y));
1933   
1934  * Caps import volume from an external zone to internal zone
1935  eExternalImportLimit(z,zext,q,d,t,y)$((fEnableExternalExchange) and FD(q,d,t))..
1936     vYearlyImportExternal(z,zext,q,d,t,y)=l= pExtTransferLimitIn(z,zext,q,y);
1937   
1938  * Caps export volume from internal zone to an external zone
1939  eExternalExportLimit(z,zext,q,d,t,y)$((fEnableExternalExchange) and FD(q,d,t))..
1940     vYearlyExportExternal(z,zext,q,d,t,y)=l= pExtTransferLimitOut(z,zext,q,y);
1941   
1942  * ------------------------------
1943  * Storage operations
1944  * Controls storage SOC, charging, and reserve support.
1945  * ------------------------------
1946  * Limits state of charge (SOC) by capacity
1947  eSOCUpperBound(st,q,d,t,y)$(fEnableStorage and FD(q,d,t))..
1948     vStorage(st,q,d,t,y) =l= vCapStor(st,y);
1949   
1950  * Prevents storage being used to meet reserves only
1951  eStorageCapMinConstraint(st,q,d,t,y)$(fEnableStorage and FD(q,d,t))..
1952     vCapStor(st,y) =g= vCap(st,y);
1953   
1954  * Charging power ≤ power capacity
1955  eChargeCapacityLimit(st,q,d,t,y)$(fEnableStorage and FD(q,d,t))..
1956     vStorInj(st,q,d,t,y) =l= vCap(st,y);
1957   
1958  * Charge cap from PV-following storage logic
1959  eChargeLimitWithPVProfile(stp,q,d,t,y)$(fEnableStorage and FD(q,d,t))..
1960     vStorInj(stp,q,d,t,y) =l= sum(gsmap(so,stp), vCap(so,y)*pStoPVProfile(so,q,d,t));
1961   
1962  * Max rate of charge decrease (ramp-down)
1963  eChargeRampDownLimit(st,q,d,t,y)$((not sFirstHour(t) and fEnableStorage and fApplyRampConstraint) and FD(q,d,t))..
1964     vStorInj(st,q,d,t-1,y) - vStorInj(st,q,d,t,y) =l= pGenData(st,'RampDnRate')*vCap(st,y);
1965   
1966  * Max rate of charge increase (ramp-up)
1967  eChargeRampUpLimit(st,q,d,t,y)$((not sFirstHour(t) and fEnableStorage and fApplyRampConstraint) and FD(q,d,t))..
1968     vStorInj(st,q,d,t,y) - vStorInj(st,q,d,t-1,y) =l= pGenData(st,'RampUpRate')*vCap(st,y);
1969   
1970  * Defines net charge as output - input
1971  eNetChargeBalance(st,q,d,t,y)$(fEnableStorage and FD(q,d,t))..
1972     vStorNet(st,q,d,t,y) =e= sum(gfmap(st,f), vPwrOut(st,f,q,d,t,y)) - vStorInj(st,q,d,t,y);
1973   
1974  * Anchors the first hour of the representative-day cycle to the configured capacity share (dispatch mode only).
1975  eStorageSOCInitDispatch(st,g,q,d,t,y)$((fDispatchMode and sFirstHour(t) and sFirstDay(d) and fEnableStorage) and FD(q,d,t))..
1976     vStorage(st,q,d,t,y) =e= vCapStor(st,y)*pStorageInitShare;
1977   
1978  * Forces the last hour of the cycle to return to the same capacity share, ensuring the wrap-around matches the initial value (dispatch mode only).
1979  eStorageSOCFinalDispatch(st,q,d,t,y)$((fDispatchMode and sLastHour(t) and sLastDay(d) and fEnableStorage) and FD(q,d,t))..
1980     vStorage(st,q,d,t,y) =e= vCapStor(st,y)*pStorageInitShare;
1981   
1982  * Representative-day mode: enforce SOC recursion on the first hour without cross-day anchoring.
1983  eStateOfChargeInitRep(st,q,d,t,y)$((not fDispatchMode) and fEnableStorage and sFirstHour(t) and FD(q,d,t))..
1984     vStorage(st,q,d,t,y) =e= pStorageData(st,"Efficiency")*vStorInj(st,q,d,t,y) - sum(gfmap(st,f), vPwrOut(st,f,q,d,t,y));
1985   
1986  * eStorageHourTransition rolls storage state forward using the previous chronological hour (t-1), assuming storage is enabled.
1987  eStorageHourTransition(st,q,d,t,y)$((not sFirstHour(t) and fEnableStorage) and FD(q,d,t))..
1988     vStorage(st,q,d,t,y) =e= vStorage(st,q,d,t-1,y)
1989        + pStorageData(st,"Efficiency")*vStorInj(st,q,d,t,y)
1990        - sum(gfmap(st,f), vPwrOut(st,f,q,d,t,y));
1991   
1992  * Dispatch mode: wrap the first hour of each day to the previous chronological hour (AT-1); no wrap in representative-day mode.
1993  eStorageDayWrap(st,q,d,t,AT,y)$((fDispatchMode and fEnableStorage and sFirstHour(t) and mapTS(q,d,t,AT) and ord(AT) > 1) and FD(q,d,t))..
1994     vStorage(st,q,d,t,y) =e= sum((q2,d2,t2)$mapTS(q2,d2,t2,AT-1), vStorage(st,q2,d2,t2,y))
1995        + pStorageData(st,"Efficiency")*vStorInj(st,q,d,t,y)
1996        - sum(gfmap(st,f), vPwrOut(st,f,q,d,t,y));
1997   
1998  * Ensures SOC level can cover spinning reserve
1999  eSOCSupportsReserve(st,q,d,t,y)$((fEnableStorage) and FD(q,d,t))..
2000     vSpinningReserve(st,q,d,t,y) =l= vStorage(st,q,d,t,y);
2001   
2002  * In dispatch mode, the day-wrap constraint ties each day’s first hour to AT-1, preventing artificial SOC jumps.
2003  * In representative-day mode the wrap is skipped, avoiding cross-day links that do not exist in that chronology.
2004   
2005  * Ensures energy conservation over the full representative day: total input × efficiency = total output
2006  * eDailyStorageEnergyBalance(st,q,d,y)$(fEnableStorage)..
2007  *   pStorageData(st,"efficiency") * sum(t, vStorInj(st,q,d,t,y)) =e= sum((gfmap(st,f),t), vPwrOut(st,f,q,d,t,y));
2008   
2009  * ------------------------------
2010  * CSP-specific equations
2011  * Constrains CSP thermal and storage operations.
2012  * ------------------------------
2013   
2014  * Limits CSP storage level to installed storage capacity.
2015  eCSPStorageCapacityLimit(cs,q,d,t,y)$(fEnableCSP and FD(q,d,t))..
2016     vStorage(cs,q,d,t,y) =l= vCapStor(cs,y);
2017   
2018  * Limits CSP storage injection to thermal energy output * efficiency. Prevents unrealistic injection behavior.
2019  eCSPStorageInjectionLimit(cs,q,d,t,y)$(fEnableCSP and FD(q,d,t))..
2020     vStorInj(cs,q,d,t,y) =l= vThermalOut(cs,q,d,t,y)*pCSPData(cs,"Thermal Field","Efficiency");
2021   
2022  * Prevents CSP storage injection exceeding installed capacity.
2023  eCSPStorageInjectionCap(cs,q,d,t,y)$(fEnableCSP and FD(q,d,t))..
2024     vStorInj(cs,q,d,t,y) =l= vCapStor(cs,y);
2025   
2026  *Limits thermal energy output to installed thermal field capacity * hourly solar profile.
2027  eCSPThermalOutputLimit(cs,q,d,t,y)$(fEnableCSP and FD(q,d,t))..
2028     vThermalOut(cs,q,d,t,y) =l= vCapTherm(cs,y)*pCSPProfile(cs,q,d,t);
2029   
2030  * Balances CSP thermal output, storage in/out, and generator dispatch.
2031  eCSPPowerBalance(cs,q,d,t,y)$(fEnableCSP and FD(q,d,t))..
2032     vThermalOut(cs,q,d,t,y)*pCSPData(cs,"Thermal Field","Efficiency")
2033   - vStorInj(cs,q,d,t,y) + vStorOut(cs,q,d,t,y)*pCSPData(cs,"Storage","Efficiency")
2034     =e= sum(gfmap(cs,f), vPwrOut(cs,f,q,d,t,y));
2035   
2036  * Tracks CSP storage state of charge across time (except for first hour).
2037  eCSPStorageEnergyBalance(cs,q,d,t,y)$((not sFirstHour(t) and fEnableCSP) and FD(q,d,t))..
2038     vStorage(cs,q,d,t,y) =e= vStorage(cs,q,d,t-1,y) + vStorInj(cs,q,d,t,y) - vStorOut(cs,q,d,t,y);
2039   
2040  * Initializes CSP storage balance for the first hour of the day.
2041  eCSPStorageInitialBalance(cs,q,d,sFirstHour(t),y)$((fEnableCSP) and FD(q,d,t))..
2042     vStorage(cs,q,d,t,y) =e= vStorInj(cs,q,d,t,y) - vStorOut(cs,q,d,t,y);
2043   
2044  * ------------------------------
2045  * Storage capacity evolution
2046  * Tracks storage energy capacity builds/retirements.
2047  * ------------------------------
2048   
2049  * Limits total installed storage capacity to predefined technical data from pStorageData and CSP-related capacity from pCSPData. Only applies if storage is included (fEnableStorage).
2050  eCapacityStorLimit(g,y)$fEnableStorage..
2051     vCapStor(g,y) =l= pStorageData(g,"CapacityMWh") + pCSPData(g,"Storage","CapacityMWh");
2052   
2053  * Sets initial year’s storage capacity equal to existing capacity (if online) plus new builds minus retirements.
2054  eCapStorBalance(g, sStartYear(y))..
2055      vCapStor(g,y) =e= pStorageData(g,"CapacityMWh")$(eg(g) and (pGenData(g,"StYr") <= sStartYear.val)) + vBuildStor(g,y) - vRetireStor(g,y);
2056   
2057  * Tracks annual storage capacity changes for existing generators (EGs): previous year’s capacity + builds − retirements.
2058  eCapStorAnnualUpdateEG(eg,y)$(not sStartYear(y) and fEnableStorage)..
2059     vCapStor(eg,y) =e= vCapStor(eg,y-1) + vBuildStor(eg,y) - vRetireStor(eg,y);
2060   
2061  * Tracks annual storage capacity for new generators (NGs): previous year’s capacity + builds. Assumes no retirement.
2062  eCapStorAnnualUpdateNG(ng,y)$(not sStartYear(y) and fEnableStorage)..
2063     vCapStor(ng,y) =e= vCapStor(ng,y-1) + vBuildStor(ng,y);
2064   
2065  * Sets initial capacity for new generators at start year equal to build amount. Applies only in the first year.
2066  eCapStorInitialNG(ng,sStartYear(y))$fEnableStorage..
2067     vCapStor(ng,y) =e= vBuildStor(ng,y);
2068   
2069  eBuildStorNew(eg)$((pGenData(eg,"StYr") > sStartYear.val) and fEnableStorage)..
2070     sum(y, vBuildStor(eg,y)) =l= pStorageData(eg,"CapacityMWh");
2071   
2072  * ------------------------------
2073  * CSP thermal capacity limits
2074  * Tracks CSP thermal field builds and limits.
2075  * ------------------------------
2076  eCapacityThermLimit(g,y)$fEnableCSP..
2077     vCapTherm(g,y) =l= pCSPData(g,"Thermal Field","CapacityMWh");
2078   
2079  eCapThermBalance1(eg,y)$(not sStartYear(y) and fEnableCSP)..
2080     vCapTherm(eg,y) =e= vCapTherm(eg,y-1) + vBuildTherm(eg,y) - vRetireTherm(eg,y);
2081   
2082  eCapThermBalance2(ng,y)$(not sStartYear(y) and fEnableCSP)..
2083     vCapTherm(ng,y) =e= vCapTherm(ng,y-1) + vBuildTherm(ng,y);
2084   
2085  eCapThermBalance3(ng,sStartYear(y))$fEnableCSP..
2086     vCapTherm(ng,y) =e= vBuildTherm(ng,y);
2087   
2088  eBuildThermNew(eg)$((pGenData(eg,"StYr") > sStartYear.val) and fEnableCSP)..
2089     sum(y, vBuildTherm(eg,y)) =l= pCSPData(eg,"Thermal Field","CapacityMWh");
2090   
2091  * ------------------------------
2092  * Capital budget constraint
2093  * Enforces the global investment ceiling.
2094  * ------------------------------
2095   
2096  eCapitalConstraint$fApplyCapitalConstraint..
2097     sum(y, pRR(y)*pWeightYear(y)*sum(ng, pCRF(ng)*vCap(ng,y)*pGenData(ng,"Capex"))) =l= ssMaxCapitalInvestmentInvestment*1e3;
2098   
2099  * ------------------------------
2100  * Emissions related equations
2101  * Computes CO₂ emissions and applies caps/backstops.
2102  * ------------------------------
2103   
2104  eZonalEmissions(z,y)..
2105     vZonalEmissions(z,y) =e=
2106     sum((gzmap(g,z),gfmap(g,f),q,d,t), vPwrOut(g,f,q,d,t,y)*pHeatRate(g,f)*pFuelCarbonContent(f)*pHours(q,d,t));
2107   
2108  eEmissionsCountry(c,y)$fApplyCountryCo2Constraint..
2109     sum(zcmap(z,c), vZonalEmissions(z,y))-vYearlyCO2backstop(c,y)=l= pEmissionsCountry(c,y);
2110   
2111  eTotalEmissions(y)..
2112      sum(z, vZonalEmissions(z,y))=e= vTotalEmissions(y);
2113   
2114  eTotalEmissionsConstraint(y)$fApplySystemCo2Constraint..
2115      vTotalEmissions(y)-vYearlySysCO2backstop(y) =l= pEmissionsTotal(y);
2116   
2117   
2118  Model PA /
2119     eNPVCost
2120     eYearlyUnmetPlanningReserveCostSystem
2121     eYearlyUnmetSpinningReserveCostSystem
2122     eYearlyCO2BackstopCostsSystem
2123     eYearlyTotalCost
2124     eAnnualizedCapexUpdate
2125     eAnnualizedCapexInit
2126     eTotalAnnualizedGenCapex
2127     eTotalAnnualizedCapex
2128     eYearlyFOMCost
2129     eYearlyVariableCost
2130     eYearlyStartupCost
2131     eYearlyStartupCostOff
2132     eYearlyFuelCost
2133     eYearlyVOMCost
2134     eYearlySpinningReserveCost
2135     eYearlyUSECost
2136     eYearlyUnmetReserveCostCountry
2137     eYearlyImportExternalCost
2138     eYearlyExportExternalCost
2139     eYearlyUnmetSpinningReserveCostCountry
2140     eYearlyUnmetPlanningReserveCostCountry
2141     eYearlyCarbonCost
2142     eYearlyCurtailmentCost
2143     eYearlyCO2BackstopCostCountry
2144     eYearlySurplusCost
2145   
2146     eDemSupply
2147     eDefineSupply
2148     eInitialCapacity
2149     eCapacityEvolutionExist
2150     eCapacityEvolutionNew
2151     eInitialBuildLimit
2152   
2153     eMinGenRE
2154     eMaxCF
2155     eMinGen
2156     eDispatchMinGenPoint
2157     eDispatchMaxGenPoint
2158   
2159     eFuel
2160     eRampUpLimit
2161     eRampDnLimit
2162     eRampContinuity
2163     eDispatchRampUpLimit
2164     eDispatchRampDownLimit
2165     eCommitmentConsistency
2166     eCommitmentInitialization
2167     eCommitmentSingleTransition
2168     eMinUpInitial
2169     eMinUpRolling
2170     eMinDownInitial
2171     eMinDownRolling
2172     eStartupCostConstraint
2173   
2174     eSpinningReserveLim
2175     eSpinningReserveLimVRE
2176     eJointResCap
2177     eSpinningReserveReqCountry
2178     eSpinningReserveReqSystem
2179     ePlanningReserveReqCountry
2180     ePlanningReserveReqSystem
2181   
2182     eVREProfile
2183     eFuelLimit
2184     eCapitalConstraint
2185     eZonalEmissions
2186     eEmissionsCountry
2187     eTotalEmissions
2188     eTotalEmissionsConstraint
2189   
2190   
2191     eBuiltCap
2192     eRetireCap
2193   
2194     eTransferCapacityLimit
2195     eMinImportRequirement
2196     eAnnualizedTransmissionCapex
2197     eCumulativeTransferExpansion
2198     eSymmetricTransferBuild
2199     eMaxAnnualImportShareEnergy
2200     eMaxAnnualExportShareEnergy
2201     eMaxHourlyImportShareEnergy
2202     eMaxHourlyExportShareEnergy
2203     eYearlyExternalTradeCost
2204     eExternalImportLimit
2205     eExternalExportLimit
2206   
2207     eSOCUpperBound
2208     eStorageCapMinConstraint
2209     eChargeCapacityLimit
2210     eChargeLimitWithPVProfile
2211     eChargeRampDownLimit
2212     eChargeRampUpLimit
2213     eNetChargeBalance
2214     eStorageHourTransition
2215     eStorageDayWrap
2216     eStorageSOCInitDispatch
2217     eStorageSOCFinalDispatch
2218     eStateOfChargeInitRep
2219   
2220   
2221     eSOCSupportsReserve
2222   
2223     eCSPStorageCapacityLimit
2224     eCSPStorageInjectionLimit
2225     eCSPStorageInjectionCap
2226     eCSPThermalOutputLimit
2227     eCSPPowerBalance
2228   
2229     eCSPStorageEnergyBalance
2230     eCSPStorageInitialBalance
2231   
2232     eCapacityStorLimit
2233     eCapStorBalance
2234     eCapStorAnnualUpdateEG
2235     eCapStorAnnualUpdateNG
2236     eCapStorInitialNG
2237     eBuildStorNew
2238   
2239     eCapacityThermLimit
2240     eCapThermBalance1
2241     eCapThermBalance2
2242     eCapThermBalance3
2243     eBuildThermNew
2244   
2245   
2246     vPwrOut(sPwrOut)
2247     vYearlyExportExternal(sExportPrice)
2248     vYearlyImportExternal(sImportPrice)
2249     vNewTransmissionLine(sAdditionalTransfer)
2250     vFlow(sFlow)
2251     vSpinningReserve(sSpinningReserve)
2252   
2253   
2254  /;
2255   
INCLUDE    /Data/SAPP_2026/EPM/epm/hydrogen_module.gms
2257   
2258   
2259  Sets
2260     H2status  'H2 generation plant status' / Existing, Candidate, Committed /
2261     eh(hh)           'existing hydrogen generation plants'
2262     nh(hh)           'new hydrogen generation plants'
2263     RampRateH2(hh)   'ramp rate constrained H2 generator blocks' // Ramprate takes out inflexible generators for a stronger formulation so that it runs faster
2264     dcH2(hh)         'candidate generators with capex trajectory'
2265     ndcH2(hh)        'candidate generators without capex trajectory'
2266     nRE(g)           'non RE generators'
2267     nVRE(g)          'non VRE generators'
2268     REH2(g)          'set of RE generators which are NOT VRE'
2269     nREH2(g)         'set of generators that are dont belong to subset REH2(g)'
2270     h2zmap(hh,z)
2271     sH2PwrIn(hh,q,d,t,y)
2272  ;
2273   
2274  Sets
2275     H2statusmap(hh,H2status) 'Hydrogen unit status'
2276  ;
2277   
2278  Parameters
2279      fEnableH2Production
2280     pCRFH2(hh)                       'Capital recovery factor'
2281     pCapexTrajectoriesH2(hh,y)       'CAPEX trajectories for hydrogen generation units'
2282     pVarCostH2(hh,y)                 'Variable cost - H2 production'
2283     pH2UnservedCost                  'Cost of external H2 unserved'
2284     pH2Data(hh,pH2Header)                    'Hydrogen production specifications'
2285  ;
2286   
2287  Positive Variables
2288     vCapH2(hh,y)                'total capacity in place accounting for legacy, new and retired plants (MW)'
2289     vBuildH2(hh,y)              'Build (MW)'
2290     vRetireH2(hh,y)             'Retire (MW)'
2291     vH2PwrIn(hh,q,d,t,y)        'Power drawn by H2 plants for H2 production in MW'
2292     vFuelH2(z,y)                'Annual H2 production in MMBTU'
2293     vAnnCapexH2(hh,y)           'Annualized CAPEX of H2 producing technologies'
2294     vPwrREH2(z,q,d,t,y)          'Generation from RE generators that goes to H2 production'
2295     vPwrREGrid(z,q,d,t,y)       'Generation from RE generators that goes to the grid'
2296     vREPwr2H2(g,f,q,d,t,y)       'Generation from RE generators that goes to H2 production'
2297     vREPwr2Grid(g,f,q,d,t,y)    'Generation from VRE generators that goes to the grid'
2298     vFuelH2Quarter(z,q,y)        'H2 fuel saved for H2 electricity generationon a quarterly basis'
2299     vUnmetExternalH2(z,q,y)        'mmBTU of external H2 demand that cant be met'
2300     vYearlyH2UnservedCost(z,y)   'Annual Cost of external H2 unserved in USD'
2301  ;
2302   
2303  Integer variable
2304     vBuiltCapVarH2(hh,y)
2305     vRetireCapVarH2(hh,y)
2306  ;
2307   
2308  Equations
2309      eH2UnservedCost(z,y)
2310      eCapBalanceH2(hh,y)
2311      eCapBalance1H2(hh,y)
2312      eCapBalance2H2
2313      eBuildNewH2(hh)
2314      eBuiltCapH2(hh,y)
2315      eRetireCapH2(hh,y)
2316      eMaxCF_H2(hh,q,y)
2317      eFuel_H2(c,q,y)
2318      eFuel_H2_2(c,z,y)
2319      eRampDnLimitH2(hh,q,d,t,y)
2320      eRampUpLimitH2(hh,q,d,t,y)
2321      eFuelLimitH2(c,f,y)
2322      eFuelLimitH2_2(c,f,y)
2323      eAnnCapexH2_1(hh,y)
2324      eAnnCapexH2(hh,y)
2325      eRE2H2(g,f,q,d,t,y)
2326      eRE2H2_2(z,q,d,t,y)
2327      eRE2H2_3(z,q,d,t,y)
2328      eRE2H2_4(z,q,d,t,y)
2329      eMaxH2PwrInjection(hh,q,d,t,y)
2330  ;
2331   
2332   
2333  * =============================
2334  * Hydrogen Contributions to Main Equations
2335  * =============================
2336   
2337  * --- Hydrogen Contribution to Yearly Cost ---
2338  Equation eYearlyTotalCost_H2Contribution;
2339   
2340  eYearlyTotalCost_H2Contribution(c,y)..
2341  *   vYearlyTotalCost(c,y) =e= vYearlyTotalCost(c,y)
2342      0 =e=
2343                            + sum(zcmap(z,c), vYearlyH2UnservedCost(z,y))$fEnableH2Production;
2344   
2345  * --- Hydrogen Contribution to Total Annualized CAPEX ---
2346  Equation eTotalAnnualizedCapex_H2Contribution;
2347   
2348  eTotalAnnualizedCapex_H2Contribution(z,y)..
2349  *   vAnnCapex(z,y) =e= vAnnCapex(z,y)
2350      0 =e=
2351                     + sum(h2zmap(ndcH2,z), pCRFH2(ndcH2)*vCapH2(ndcH2,y)*pH2Data(ndcH2,"Capex")*1e6)$fEnableH2Production
2352                     + sum(h2zmap(dcH2,z), vAnnCapexH2(dcH2,y))$fEnableH2Production;
2353   
2354  * --- Hydrogen Contribution to Yearly Variable O&M Cost ---
2355  Equation eYearlyVOMCost_H2Contribution;
2356   
2357  eYearlyVOMCost_H2Contribution(z,y)..
2358  *   vYearlyVOMCost(z,y) =e= vYearlyVOMCost(z,y)
2359      0 =e=
2360                           + sum((h2zmap(hh,z),q,d,t), pVarCostH2(hh,y)*pH2Data(hh,"Heatrate")*vH2PwrIn(hh,q,d,t,y)*pHours(q,d,t))$fEnableH2Production;
2361   
2362  * --- Hydrogen Unserved Demand Cost (can stay modular as-is) ---
2363  Equation eH2UnservedCost;
2364   
2365  eH2UnservedCost(z,y)..
2366     vYearlyH2UnservedCost(z,y) =e= sum(q, vUnmetExternalH2(z,q,y)) * pH2UnservedCost $fEnableH2Production;
2367   
2368  * --- Hydrogen Supply Contribution to Demand Balance ---
2369  Equation eSupply_H2Contribution;
2370   
2371  * TODO: Change that
2372  eSupply_H2Contribution(z,q,d,t,y)..
2373  *   vSupply(z,q,d,t,y) =e=vSupply(z,q,d,t,y)
2374  *        -sum((gzmap(g,z),gfmap(g,f)),vPwrOut(g,f,q,d,t,y))
2375      0 =e=
2376       + sum((gzmap(nRE,z),gfmap(nRE,f)),vPwrOut(nRE,f,q,d,t,y))$(fEnableH2Production)
2377       + vPwrREGrid(z,q,d,t,y)$fEnableH2Production;
2378   
2379  * =============================
2380  * Hydrogen Specific Equations
2381  * =============================
2382   
2383   
2384  * Total capacity of H2 plants at 1st year of optimization is equal to pre-existing capacity plus capacity being bulit minus retired capacity
2385  eCapBalanceH2(hh,sStartYear(y))$(fEnableH2Production)..
2386     vCapH2(hh,y) =e= pH2Data(hh,"Capacity")$(eh(hh) and (pH2Data(hh,"StYr") <= sStartYear.val))
2387                 + vBuildH2(hh,y) - vRetireH2(hh,y);
2388   
2389  * Total capacity of existing H2 palnts is equal to capacity over previous year plus capacity being built in current year minus retired capacity in current year
2390  *Checked
2391  eCapBalance1H2(eh,y)$(not sStartYear(y) and fEnableH2Production)..
2392     vCapH2(eh,y) =e= vCapH2(eh,y-1) + vBuildH2(eh,y) - vRetireH2(eh,y);
2393   
2394  * Total capacity of candidate H2 plants is equal to total capacity at previous year plus capacity being built in current year minus retired capacity in current year
2395  *Checked
2396  eCapBalance2H2(nh,y)$(not sStartYear(y) and fEnableH2Production)..
2397     vCapH2(nh,y) =e= vCapH2(nh,y-1) + vBuildH2(nh,y);
2398   
2399  * New H2 plants can be buuilt only after the StYr; the newly built capacity need to be less than declared capacity
2400  *Checked
2401  eBuildNewH2(eh)$(pH2Data(eh,"StYr") > sStartYear.val and fEnableH2Production)..
2402      sum(y, vBuildH2(eh,y)) =l= pH2Data(eh,"Capacity");
2403   
2404   
2405  * (Integer units ) Built capacity each year is equal to unit size
2406  *Checked
2407  eBuiltCapH2(nh,y)$(pH2Data(nh,"DescreteCap") and fEnableH2Production)..
2408     vBuildH2(nh,y) =e= pH2Data(nh,"UnitSize")*vBuiltCapVarH2(nh,y);
2409   
2410  * (Integer units ) Retired capacity each year is equal to unit size
2411  *Checked
2412  eRetireCapH2(eh,y)$(pH2Data(eh,"DescreteCap") and (y.val <= pH2Data(eh,"RetrYr")) and fEnableH2Production)..
2413     vRetireH2(eh,y) =e= pH2Data(eh,"UnitSize")*vRetireCapVarH2(eh,y);
2414   
2415  *  Maximum capacity factor of H2 production based on availability
2416  *Checked
2417  eMaxCF_H2(hh,q,y)$(fEnableH2Production)..
2418     sum((d,t), vH2PwrIn(hh,q,d,t,y)*pHours(q,d,t)) =l= pAvailabilityH2(hh,q)*vCapH2(hh,y)*sum((d,t), pHours(q,d,t));
2419   
2420  *       mmBTU of H2 produced
2421  eFuel_H2(c,q,y)$(fEnableH2Production)..
2422  *                   mmBTU            mmBTU                    mmBTU                                                                     -MWe-                Hr                mmBTU/MWhe
2423      sum(zcmap(z,c), pExternalH2(z,q,y)-vUnmetExternalH2(z,q,y)$pExternalH2(z,q,y)+vFuelH2Quarter(z,q,y)) =e= sum( (zcmap(z,c),h2zmap(hh,z), d,t), vH2PwrIn(hh,q,d,t,y)*pHours(q,d,t)*pH2Data(hh,"HeatRate"));
2424   
2425  eFuel_H2_2(c,z,y)$(fEnableH2Production)..
2426      sum((zcmap(z,c),q),vFuelH2Quarter(z,q,y)) =e=  sum(zcmap(z,c),vFuelH2(z,y));
2427   
2428  eMaxH2PwrInjection(hh,q,d,t,y)$fEnableH2Production..
2429      vH2PwrIn(hh,q,d,t,y)  =l= vCapH2(hh,y);
2430   
2431  * The amount of hydrogen fuel that can be used for electricity generation can not be more than the amount of H2 that was produced from VRE curtailment
2432  eFuelLimitH2(c,f,y)$(pFuelDataH2(f) and fEnableH2Production)..
2433     sum((zcmap(z,c)),  vFuel(z,f,y)) =e=  sum((zcmap(z,c)), vFuelH2(z,y));
2434   
2435   
2436  *When the H2 production flag is off don't account for H2 fuel
2437  eFuelLimitH2_2(c,f,y)$(pFuelDataH2(f) and fEnableH2Production=0)..
2438     sum((zcmap(z,c)),  vFuel(z,f,y)) =e=  0;
2439   
2440   
2441  eRampDnLimitH2(hh,q,d,t,y)$(RamprateH2(hh) and not sFirstHour(t) and fApplyRampConstraint and fEnableH2Production)..
2442      vH2PwrIn(hh,q,d,t-1,y) -  vH2PwrIn(hh,q,d,t,y) =l= vCapH2(hh,y)*pH2Data(hh,"RampDnRate");
2443   
2444  eRampUpLimitH2(hh,q,d,t,y)$(RamprateH2(hh) and not sFirstHour(t) and fApplyRampConstraint and fEnableH2Production)..
2445     vH2PwrIn(hh,q,d,t,y) -  vH2PwrIn(hh,q,d,t-1,y) =l= vCapH2(hh,y)*pH2Data(hh,"RampUpRate");
2446   
2447  *Calculation of Annualized CAPEX for electrolyzers
2448  eAnnCapexH2_1(dcH2,y)$(not sStartYear(y) and fEnableH2Production)..
2449     vAnnCapexH2(dcH2,y) =e= vAnnCapexH2(dcH2,y-1)
2450                       + vBuildH2(dcH2,y)*pH2Data(dcH2,"Capex")*pCapexTrajectoriesH2(dcH2,y)*pCRFH2(dcH2)*1e6;
2451   
2452  eAnnCapexH2(dcH2,sStartYear(y))$fEnableH2Production..
2453     vAnnCapexH2(dcH2,y) =e= vBuildH2(dcH2,y)*pH2Data(dcH2,"Capex")*pCapexTrajectoriesH2(dcH2,y)*pCRFH2(dcH2)*1e6;                                                                          ;
2454   
2455  eRE2H2_4(z,q,d,t,y)$fEnableH2Production..
2456    sum(h2zmap(hh,z),vH2PwrIn(hh,q,d,t,y))=e=vPwrREH2(z,q,d,t,y);
2457   
2458   
2459  eRE2H2_3(z,q,d,t,y)$fEnableH2Production..
2460   vPwrREH2(z,q,d,t,y) =e= sum((gfmap(RE,f),gzmap(RE,z)),vREPwr2H2(RE,f,q,d,t,y));
2461   
2462  eRE2H2_2(z,q,d,t,y)$fEnableH2Production..
2463  vPwrREGrid(z,q,d,t,y)=e=sum((gfmap(RE,f),gzmap(RE,z)),vREPwr2Grid(RE,f,q,d,t,y));
2464   
2465  eRE2H2(RE,f,q,d,t,y)$fEnableH2Production..
2466   vPwrOut(RE,f,q,d,t,y)=e=vREPwr2Grid(RE,f,q,d,t,y)+vREPwr2H2(RE,f,q,d,t,y);
2467   
2468  *For example equation below is deactivated when H2 is on and is replaced by eVREProfile2
2469   
2470  * =============================
2471  * Updating Hydrogen Model
2472  * =============================
2473   
2474   
2476  Model PA /
2477   
2478      eYearlyTotalCost_H2Contribution,
2479      eTotalAnnualizedCapex_H2Contribution,
2480      eYearlyVOMCost_H2Contribution,
2481      eH2UnservedCost,
2482      eSupply_H2Contribution
2483   
2484     vH2PwrIn(sH2PwrIn)
2485     eBuildNewH2
2486     eCapBalance1H2
2487     eCapBalance2H2
2488     eCapBalanceH2
2489     eBuiltCapH2
2490     eRetireCapH2
2491  *eDemSupplyH2
2492     eMaxCF_H2
2493     eFuel_H2
2494     eFuel_H2_2
2495     eRampDnLimitH2
2496     eRampUpLimitH2
2497     eFuelLimitH2
2498     eFuelLimitH2_2
2499  *eYearlyCurtailmentCost2
2500   
2501     eRE2H2
2502     eRE2H2_2
2503     eRE2H2_3
2504     eRE2H2_4
2505     eMaxH2PwrInjection
2506   
2507     eAnnCapexH2_1
2508     eAnnCapexH2
2509     /
2510  ;
2512   
2513  *-------------------------------------------------------------------------------------
2514   
2515  * Copy to temp parameter and normalize standalone storage (g,'') to paired format (g,g) for uniform processing
2516  pStorageDataTemp(g,g2,pStorageDataHeader) = pStorageDataInput(g,g2,pStorageDataHeader);
2517  pStorageDataTemp(g,g,pStorageDataHeader)$pStorageDataInput(g,'',pStorageDataHeader) = pStorageDataInput(g,'',pStorageDataHeader);
2518   
2519   
2520  * Generate gfmap and others from pGenDataInput
2521  parameter gstatIndex(gstatus) / Existing 1, Candidate 3, Committed 2 /;
2522  parameter tstatIndex(tstatus) / Candidate 3, Committed 2 /;
2523   
2524  *H2 model parameter
2525  parameter H2statIndex(H2status) / Existing 1, Candidate 3, Committed 2 /;
2526   
2527   
2528  * Aggregate `gmap(g,z,tech,f)` over `tech` and `f` to get `gzmap(g,z)`,
2529  * which represents the mapping of generator `g` to zone `z`.
2530  gzmap(g,z) = sum((tech,f), gmap(g,z,tech,f));
2531   
2532  * Aggregate `gmap(g,z,tech,f)` over `tech` and `z` to get `gfmap(g,f)`,
2533  * which represents the mapping of generator `g` to fuel `f`.
2534  gfmap(g,f) = sum((tech,z), gmap(g,z,tech,f));
2535   
2536  * Compute `gprimf(g,f)`, which is similar to `gfmap(g,f)`,
2537  * aggregating over `tech` and `z` to represent the primary fuel mapping.
2538  gprimf(g,f) = sum((tech,z), gmap(g,z,tech,f));
2539   
2540  * Aggregate `gmap(g,z,tech,f)` over `z` and `f` to get `gtechmap(g,tech)`,
2541  * which represents the mapping of generator `g` to technology `tech`.
2542  gtechmap(g,tech) = sum((z,f), gmap(g,z,tech,f));
2543   
2544  * Update `gfmap(g,f)`, ensuring it includes additional mappings
2545  * based on `pGenDataInput(g,z,tech,f2,'fuel2')` when a condition is met.
2546  gfmap(g,f) = gfmap(g,f)
2547           or sum((z,tech,f2), (pGenDataInput(g,z,tech,f2,'fuel2') = ftfindex(f)));
2548   
2549   
2550  * Map generator status from input data
2551  gstatusmap(g,gstatus) = sum((z,tech,f),pGenDataInput(g,z,tech,f,'status')=gstatIndex(gstatus));
2552   
2553   
2554  pHeatrate(gprimf(g,f)) = sum((z,tech), pGenDataInput(g,z,tech,f,"Heatrate"));
2555  pHeatrate(g,f2)$(gfmap(g,f2) and not gprimf(g,f2)) =
2556      sum((z,tech,f), pGenDataInput(g,z,tech,f,"Heatrate2")
2557  *  $(pGenDataInput(g,z,tech,f,"fuel2") = ftfindex(f2))
2558      );
2559   
2560   
2561  pGenData(g,pGenDataInputHeader) = sum((z,tech,f),pGenDataInput(g,z,tech,f,pGenDataInputHeader));
2562   
2563  ***********************H2 model parameters***************************************************
2564   
2565  pH2Data(hh,pH2Header)=pH2DataExcel(hh,pH2Header);
2566  H2statusmap(hh,H2status) = pH2DataExcel(hh,'status')=H2statIndex(H2status);
2567  * TODO: Check is that works for H2
2568  * h2zmap(hh,z) = pH2DataExcel(hh,'Zone')=pZoneIndex(z);
2569  h2zmap(hh,z) = pH2DataExcel(hh,'Zone');
2570   
2571  *-------------------------------------------------------------------------------------
2572   
2573  *--- Parameter initialisation for same demand profile for all years
2574   
INCLUDE    /Data/SAPP_2026/EPM/epm/generate_demand.gms
2576  **********************************************************************
2577  * ELECTRICITY PLANNING MODEL (EPM)
2578  * Developed at the World Bank
2579  **********************************************************************
2580  * Description:
2581  * This GAMS-based model is designed for electricity system planning,
2582  * incorporating capacity expansion, generation dispatch, and policy
2583  * constraints such as renewable energy targets, emissions reductions,
2584  * and market mechanisms.
2585  *
2586  * Author(s): ESMAP Modelling Team
2587  * Organization: World Bank
2588  * Version:
2589  * License: Creative Commons Zero v1.0 Universal
2590  *
2591  * Key Features:
2592  * - Optimization of electricity generation and capacity planning
2593  * - Inclusion of renewable energy integration and storage technologies
2594  * - Multi-period, multi-region modeling framework
2595  * - CO2 emissions constraints and policy instruments
2596  *
2597  * Notes:
2598  * - Ensure GAMS is installed before running this model.
2599  * - The model requires input data in .GDX or Excel format.
2600  *
2601  * Contact:
2602  * Claire Nicolas, cnicolas@worldbank.org
2603  **********************************************************************
2604   
2605  *--- Adjust peak and energy in case user selected same demand profile for all years
2606   
2607  Parameters
2608     pmax(z,y)
2609     pmin(z,y)
2610     pdiff(z,y)
2611     ptotalenergy(z,y)
2612     ptemp2(y)
2613     ptemp(y)
2614     pTempDemand(z,q,d,y,t)
2615  ;
2616   
2617  Variable
2618     pyval(z,q,d,y,t)
2619     divisor(z,y)
2620     obj
2621  ;
2622   
2623  divisor.lo(z,y) = card(q)*card(d)*card(t);
2624   
2625  Equation
2626     getDivisor(z,q,d,y,t)
2627     getArea(z,y)
2628     objFn
2629  ;
2630   
2631  getDivisor(z,q,d,y,t)..  pyval(z,q,d,y,t) =e=  [2*pdiff(z,y)/divisor(z,y) * (pmax(z,y) - pDemandProfile(z,q,d,t))]/sqr(pmax(z,y) - pmin(z,y));
2632  getArea(z,y)..           sum((q,d,t), pyval(z,q,d,y,t) * pHours(q,d,t)) =e=  pdiff(z,y);
2633  objFn..                  obj =e= sum((z,q,d,y,t), pyval(z,q,d,y,t));
2634   
2635  model demand / getDivisor, getArea, objFn /;
2636   
2637  * If using alt demand:
2638  if (pSettings("fUseSimplifiedDemand") = 1,
2639     pTempDemand(z,q,d,y,t) = pDemandProfile(z,q,d,t) * pDemandForecast(z,"Peak",y);
2640   
2641     pdiff(z,y) = ((pDemandForecast(z,"Energy",y)*1e3) - sum((q,d,t), pTempDemand(z,q,d,y,t)*pHours(q,d,t) )) ;
2642   
2643     pmax(z,y) = smax((q,d,t), pDemandProfile(z,q,d,t));
2644     pmin(z,y) = smin((q,d,t)$pDemandProfile(z,q,d,t), pDemandProfile(z,q,d,t));
2645  *   option limrow=1000; debugging
2646     Solve demand using nlp min obj;
2647   
2648     abort$(demand.modelstat<>1 and demand.modelstat<>2) 'Demand model not solved successfully';
2650     pDemandData(z,q,d,y,t) =  pTempDemand(z,q,d,y,t) + pyval.l(z,q,d,y,t);
2652     ptemp(y) = sum((z,q,d,t), pdemanddata(z,q,d,y,t)*pHours(q,d,t))/1000;
2653     ptemp2(y) = smax((q,d,t),sum(z, pdemanddata(z,q,d,y,t)));
2654  );
2655   
2656  ptotalenergy(z,y) =  sum((q,d,t), pdemanddata(z,q,d,y,t)*pHours(q,d,t))/1e3;
2657   
2658  *--- Part2: Start of initialisation of other parameters
2659   
2660  * Read main parameters from pSettings
2661   
2662  fEnableStorage                     = pSettings("fEnableStorage");
2663  fDispatchMode                      = pSettings("fDispatchMode");
2664   
2665  * --- Settings: Dispatch constraint switches
2666  fApplyMinGenCommitment      = pSettings("fApplyMinGenCommitment");
2667  fApplyStartupCost                  = pSettings("fApplyStartupCost");
2668  fApplyRampConstraint               = pSettings("fApplyRampConstraint");
2669  fApplyMUDT                       = pSettings("fApplyMUDT");
2670   
2671  * --- Settings: Economic parameters and penalties
2672  pDR                          = pSettings("DR");
2673  pWACC                        = pSettings("WACC");
2674  pVoLL                        = pSettings("VoLL");
2675  pPlanningReserveVoLL         = pSettings("ReserveVoLL");
2676  pSpinningReserveVoLL         = pSettings("SpinReserveVoLL");
2677  pSurplusPenalty              = pSettings("CostSurplus");
2678  pCostOfCurtailment           = pSettings("CostCurtail");
2679  pCostOfCO2backstop           = pSettings("CO2backstop");
2680  pH2UnservedCost              = pSettings("H2UnservedCost");
2681  ssMaxCapitalInvestmentInvestment = pSettings("sMaxCapitalInvestment") * 1e6;
2682   
2683  * --- Settings: Reserve requirements
2684  fApplyPlanningReserveConstraint    = pSettings("fApplyPlanningReserveConstraint");
2685  sReserveMarginPct                  = pSettings("sReserveMarginPct");
2686  fApplyCountrySpinReserveConstraint = pSettings("fApplyCountrySpinReserveConstraint");
2687  fApplySystemSpinReserveConstraint = pSettings("fApplySystemSpinReserveConstraint");
2688  psVREForecastErrorPct              = pSettings("sVREForecastErrorPct");
2689  sIntercoReserveContributionPct     = pSettings("sIntercoReserveContributionPct");
2690  fCountIntercoForReserves           = pSettings("fCountIntercoForReserves");
2691   
2692  * --- Settings: Policy and operational switches
2693  fApplyMinGenShareAllHours      = pSettings("fApplyMinGenShareAllHours");
2694  fApplyFuelConstraint               = pSettings("fApplyFuelConstraint");
2695  fApplyCapitalConstraint            = pSettings("fApplyCapitalConstraint");
2696  fEnableCSP                         = pSettings("fEnableCSP");
2697  fEnableCapacityExpansion           = pSettings("fEnableCapacityExpansion");
2698  pMinRE                             = pSettings("sMinRenewableSharePct");
2699  pMinsRenewableTargetYear           = pSettings("sRenewableTargetYear");
2700  fApplyCountryCo2Constraint         = pSettings("fApplyCountryCo2Constraint");
2701  fApplySystemCo2Constraint         = pSettings("fApplySystemCo2Constraint");
2702  fEnableCarbonPrice                     = pSettings("fEnableCarbonPrice");
2703  fEnableEnergyEfficiency           = pSettings("fEnableEnergyEfficiency");
2704   
2705   
2706  * --- Settings: Transmission and trade
2707  fEnableInternalExchange            = pSettings("fEnableInternalExchange");
2708  fRemoveInternalTransferLimit       = pSettings("fRemoveInternalTransferLimit");
2709  fAllowTransferExpansion            = pSettings("fAllowTransferExpansion");
2710  fAllowTransferExpansion            = fAllowTransferExpansion * fEnableCapacityExpansion;
2711   
2712  fEnableExternalExchange            = pSettings("fEnableExternalExchange");
2713  sMaxHourlyImportExternalShare                 = pSettings("sMaxHourlyImportExternalShare");
2714  sMaxHourlyExportExternalShare                 = pSettings("sMaxHourlyExportExternalShare");
2715   
2716  * --- Settings: Hydrogen options
2717  fEnableCapexTrajectoryH2           = pSettings("fEnableCapexTrajectoryH2");
2718  fEnableH2Production               = pSettings("fEnableH2Production");
2719   
2720  * ----------------------------
2721  singleton set sFinalYear(y);
2722  scalar TimeHorizon;
2723   
2724  sStartYear(y) = y.first;
2725  sFinalYear(y) = y.last;
2726  TimeHorizon = sFinalYear.val - sStartYear.val + 1;
2727  sFirstHour(t) = t.first;
2728  sLastHour(t) = t.last;
2729  sFirstDay(d) = d.first;
2730   
2731  sFirstHourAT(AT) = AT.first;
2732   
2733  sLastDay(d) = yes$(ord(d) = card(d));
2734   
2735  * ------------------------------
2736  * Commitment initialization defaults
2737  * Consolidates initial ON/OFF values so a single section shows which units start online.
2738  * ------------------------------
2739  pInitialOnStart(g) = 0;
2740  pInitialOnStart(g)$pGenData(g,"InitialOn") = pGenData(g,"InitialOn");
2741   
2742   
2743  pStorageInitShare = pSettings("InitialSOCforBattery");
2744  if (pStorageInitShare < 0,
2745     pStorageInitShare = 0.5;
2746  );
2747   
2748  FD(q,d,t) = yes;
2749  if (fDispatchMode,
2750     FD(q,d,t)$(ord(q) eq 2 and ord(d) > 28) = no;
2751     FD(q,d,t)$((ord(q) eq 4 or ord(q) eq 6 or ord(q) eq 9 or ord(q) eq 11) and ord(d) > 30) = no;
2752  );
2753   
2754  * Identify which generators carry minimum-generation commitments so that startup cost logic can focus on them.
2755  MinGenPoint(g) = yes$(pGenData(g,"MinGenCommitment") > 0);
2756   
2757  * ------------------------------
2758   
2759   
2760  * Set external transfer limits to zero if exports are not allowed
2761  pExtTransferLimit(z,zext,q,"Import",y)$(not fEnableExternalExchange)  = 0 ;
2762  pExtTransferLimit(z,zext,q,"Export",y)$(not fEnableExternalExchange)  = 0 ;
2763   
2764  * Assign import and export transfer limits only if exports are allowed
2765  pExtTransferLimitIn(z,zext,q,y)$fEnableExternalExchange   = pExtTransferLimit(z,zext,q,"Import",y) ;
2766  pExtTransferLimitOut(z,zext,q,y)$fEnableExternalExchange  = pExtTransferLimit(z,zext,q,"Export",y) ;
2767   
2768  * Define `Zt(z)` to check if total demand in a zone `z` is zero
2769  Zt(z) = sum((q,d,y,t),pDemandData(z,q,d,y,t)) = 0;
2770  * Define `Zd(z)` as the complement of `Zt(z)`, indicating zones with demand
2771  Zd(z) = not Zt(z);
2772   
2773   
2774  * Assign storage data from pStorageDataTemp based on the generator-storage mapping
2775  option gsmap<pStorageDataTemp;
2776  loop(gsmap(g2,g), pStorageData(g,pStorageDataHeader) = pStorageDataTemp(g,g2,pStorageDataHeader));
2777   
2778  * Remove generator pairs (`g,g`) that correspond to standalone storage plants from `gsmap`
2779  gsmap(g,g) = no;
2780   
2781  * Identify candidate generators (`ng(g)`) based on their status in `gstatusmap`
2782  ng(g)  = gstatusmap(g,'candidate') or gstatusmap(g,'committed');
2783   
2784  * Define existing generators (`eg(g)`) as those that are not candidates, include comitted
2785  eg(g)  = not ng(g);
2786   
2787  * Identify variable renewable energy (VRE) generators (`vre(g)`) based on hourly variation data
2788  vre(g) = sum(gtechmap(g,tech)$pTechData(tech,'Hourly Variation'),1);
2789   
2790  * Identify renewable energy (RE) generators (`re(g)`) based on RE technology classification
2791  re(g)  = sum(gtechmap(g,tech)$pTechData(tech,'RE Technology'),1);
2792   
2793  * Identify concentrated solar power (CSP) technologies
2794  cs(g)  = gtechmap(g,"CSPPlant");
2795   
2796  * Identify PV with storage technologies
2797  so(g)  = gtechmap(g,"PVwSTO");
2798   
2799  * Identify solar thermal with PV (`STOPV`)
2800  stp(g) = gtechmap(g,"STOPV");
2801   
2802  * Identify storage technologies
2803  stg(g) = gtechmap(g,"Storage");
2804   
2805  * Define a general storage category (`st(g)`) as either `STOPV` or `STORAGE`
2806  st(g)  = gtechmap(g,"STOPV") or gtechmap(g,"Storage");
2807   
2808  * Define generators with capex trajectory data
2809  dc(g)  = sum(y, pCapexTrajectories(g,y));
2810   
2811  * Define generators without capex trajectory data
2812  ndc(g) = not dc(g);
2813   
2814  * Identify run-of-river hydro generators (`ror(g)`)
2815  ror(g) = gtechmap(g,"ROR");
2816   
2817  * Identify VRE generators excluding run-of-river hydro (`VRE_noROR(g)`)
2818  VRE_noROR(g) = vre(g) and not ror(g);
2819   
2820  * Define ramp-down rate for generators
2821  RampRate(g) = pGenData(g,"RampDnRate");
2822   
2823  * Map zones (`z`) to fuels (`f`) based on generator-fuel assignments (`gzmap` and `gfmap`)
2824  zfmap(z,f) = sum((gzmap(g,z),gfmap(g,f)), 1);
2825   
2826  * H2 model specific sets
2827  nh(hh)  = H2statusmap(hh,'candidate');
2828  eh(hh)  = not nh(hh);
2829  RampRateH2(hh)= pH2Data(hh,"RampDnRate");
2830  dcH2(hh)  = sum(y, pCapexTrajectoryH2(hh,y));
2831  ndcH2(hh) = not dcH2(hh);
2832  nRE(g) = not re(g);
2833  nVRE(g)=not VRE(g);
2834  REH2(g)= sum(gtechmap(g,tech)$pTechData(tech,'RE Technology'),1) - sum(gtechmap(g,tech)$pTechData(tech,'Hourly Variation'),1);
2835  nREH2(g)= not REH2(g);
2836   
2837  *-------------------------------------------------------------------
2838  * TOPOLOGY DEFINITION
2839  *-------------------------------------------------------------------
2840   
2841  * Defining sTopology based on existing, committed and candidate transmission lines
2842  sTopology(z,z2) = sum((q,y),pTransferLimit(z,z2,q,y)) + sum(pTransmissionHeader,pNewTransmission(z,z2,pTransmissionHeader)) + sum(pTransmissionHeader,pNewTransmission(z2,z,pTransmissionHeader));
2843   
2844  * If not running in interconnected mode, set network to 0
2845  sTopology(z,z2)$(not fEnableInternalExchange) = no;
2846   
2847  * if ignore transfer limit, set limits to high value
2848  pTransferLimit(sTopology,q,y)$fRemoveInternalTransferLimit = inf;
2849   
2850  * Default life for transmission lines
2851  pNewTransmission(sTopology,"Life")$(pNewTransmission(sTopology,"Life")=0 and fAllowTransferExpansion) = 30;
2852   
2853  * Map transmission status from input data
2854  tstatusmap(sTopology(z,z2),tstatus) = (pNewTransmission(z,z2, 'status')=tstatIndex(tstatus)) + (pNewTransmission(z2,z, 'status')=tstatIndex(tstatus));
2855   
2856  * Identify candidate generators (`ng(g)`) based on their status in `gstatusmap`
2857  commtransmission(sTopology(z,z2))  = tstatusmap(z,z2,'committed');
2858   
2859  *-------------------------------------------------------------------
2860  * CAPACITY CREDIT
2861  *-------------------------------------------------------------------
2862   
2863  * Identify the system peak demand for each year based on the highest total demand across all zones, times, and demand segments
2864  pFindSysPeak(y)     = smax((t,d,q), sum(z, pDemandData(z,q,d,y,t)));
2865   
2866  * Identify hours that are close to the peak demand for capacity credit calculations
2867  pAllHours(q,d,y,t)  = 1$(abs(sum(z,pDemandData(z,q,d,y,t))/pFindSysPeak(y) - 1)<pSettings("sPeakLoadProximityThreshold"));
2868   
2869  * Default capacity credit for all generators is set to 1
2870  pCapacityCredit(g,y)= 1;
2871   
2872  * Protect against unintended changes while modifying `pVREgenProfile` with `pVREProfile` data
2873  pVREgenProfile(VRE,q,d,t)$(not(pVREgenProfile(VRE,q,d,t))) = sum((z,tech)$(gzmap(VRE,z) and gtechmap(VRE,tech)),pVREProfile(z,tech,q,d,t));
2874   
2875  * Set capacity credit for VRE based on predefined values or calculated generation-weighted availability
2876  pCapacityCredit(VRE,y) =  Sum((z,q,d,t)$gzmap(VRE,z),Sum(f$gfmap(VRE,f),pVREgenProfile(VRE,q,d,t)) * pAllHours(q,d,y,t)) * (Sum((z,f,q,d,t)$(gfmap(VRE,f) and gzmap(VRE,z) ),pVREgenProfile(VRE,q,d,t))/sum((q,d,t),1));
2877   
2878  * Compute capacity credit for run-of-river hydro as an availability-weighted average
2879  pCapacityCredit(ROR,y) =  sum(q,pAvailability(ROR,y,q)*sum((d,t),pHours(q,d,t)))/sum((q,d,t),pHours(q,d,t));
2880   
2881  * Compute CSP and PV with storage generation profiles
2882  pCSPProfile(cs,q,d,t)    = sum((z,tech)$(gtechmap(cs,tech) and gzmap(cs,z)), pVREProfile(z,tech,q,d,t));
2883  pStoPVProfile(so,q,d,t)  =  sum((z,tech)$(gtechmap(so,tech) and gzmap(so,z)), pVREProfile(z,tech,q,d,t));
2884   
2885  * H2 model parameters
2886  pCapexTrajectoriesH2(hh,y) =1;
2887  pCapexTrajectoriesH2(dch2,y)$fEnableCapexTrajectoryH2 = pCapexTrajectoryH2(dcH2,y);
2888   
2889  *-------------------------------------------------------------------
2890  * Cost of capital
2891  *-------------------------------------------------------------------
2892   
2893  * Set the weight of the start year to 1.0
2894  pWeightYear(sStartYear) = 1.0;
2895  * Compute weight for each year as the difference from the previous year's cumulative weight
2896  pWeightYear(y)$(not sStartYear(y)) = y.val - sum(sameas(y2+1,y), y2.val) ;
2897   
2898  * Compute the present value discounting factor considering mid-year adjustments
2899  pRR(y) = 1.0;
2900  pRR(y)$(ord(y)>1) = 1/((1+pDR)**(sum(y2$(ord(y2)<ord(y)),pWeightYear(y2))-1 + sum(sameas(y2,y), pWeightYear(y2)/2))) ;
2901   
2902  *-------------------------------------------------------------------
2903  * Parameter Processing
2904  *-------------------------------------------------------------------
2905  pLossFactorInternal(z2,z,y)$(pLossFactorInternal(z,z2,y) and not pLossFactorInternal(z2,z,y)) = pLossFactorInternal(z,z2,y);
2906   
2907  pEnergyEfficiencyFactor(z,y)$(not fEnableEnergyEfficiency) = 1;
2908  pEnergyEfficiencyFactor(z,y)$(pEnergyEfficiencyFactor(z,y)=0) = 1;
2909   
2910  pVOMCost(gfmap(g,f),y) = pGenData(g,"VOM")
2911                         + pStorageData(g, "VOMMWh")
2912                         + pCSPData(g, "Storage", "VOMMWh")
2913                         + pCSPData(g, "Thermal Field", "VOMMWh");
2914   
2915  pFuelCost(g,f,y)$(gfmap(g,f)) = sum((gzmap(g,z),zcmap(z,c)),pFuelPrice(c,f,y)*pHeatRate(g,f));
2916  pVarCost(g,f,y)$(gfmap(g,f)) = pFuelCost(g,f,y) + pVOMCost(g,f,y);
2917  pVarCostH2(hh,y) = pH2Data(hh,"VOM");
2918   
2919  * pCRF refers to the Capital Recovery Factor, which is used to calculate the annualized cost of capital for a project.
2920  pCRF(g)$pGenData(g,'Life') = pWACC / (1 - (1 / ( (1 + pWACC)**pGenData(g,'Life'))));
2921  pCRFH2(hh)$pH2Data(hh,'Life') = pWACC / (1 - (1 / ( (1 + pWACC)**pH2Data(hh,'Life'))));
2922  pCRFsst(st)$pGenData(st,'Life') = pWACC / (1 - (1 / ( (1 + pWACC)**pGenData(st,'Life'))));
2923  pCRFcst(cs)$pGenData(cs,'Life') = pWACC / (1 - (1 / ( (1 + pWACC)**pGenData(cs,'Life'))));
2924  pCRFcth(cs)$pGenData(cs,'Life') = pWACC / (1 - (1 / ( (1 + pWACC)**pGenData(cs,'Life'))));
2925   
2926  * Defines which connected zones belong to different countries.
2927  sMapConnectedZonesDiffCountries(sTopology(z,z2)) = sum(c$(zcmap(z,c) and zcmap(z2,c)), 1) = 0;
2928   
2929  *** Simple bounds
2930   
2931  * Set upper limit for generation capacity based on predefined data
2932  vCap.up(g,y) = pGenData(g,"Capacity");
2933   
2934  * Fix the build decision variable to zero for existing generation projects (started before or at the model start year)
2935  vBuild.fx(eg,y)$(pGenData(eg,"StYr") <= sStartYear.val) = 0;
2936   
2937  * Set the upper limit for new generation builds per year, accounting for the annual build limit and year weighting
2938  vBuild.up(ng,y) = pGenData(ng,"BuildLimitperYear")*pWeightYear(y);
2939   
2940  * Define the upper limit for additional transmission capacity, subject to high transfer allowance
2941  vNewTransmissionLine.up(sTopology(z,z2),y)$fAllowTransferExpansion = max(pNewTransmission(z,z2,"MaximumNumOfLines"),pNewTransmission(z2,z,"MaximumNumOfLines"));
2942   
2943  sAdditionalTransfer(sTopology(z,z2),y) = yes;
2944  sAdditionalTransfer(sTopology(z,z2),y) $((y.val < pNewTransmission(z,z2,"EarliestEntry")) or (y.val < pNewTransmission(z2,z,"EarliestEntry"))) = no;
2945   
2946  * Fix
2947  vNewTransmissionLine.fx(commtransmission(z,z2),y)$((max(pNewTransmission(z,z2,"EarliestEntry"),pNewTransmission(z2,z,"EarliestEntry")) <= y.val) and fAllowTransferExpansion) = max(pNewTransmission(z,z2,"MaximumNumOfLines"),pNewTransmission(z2,z,"MaximumNumOfLines"));
2948  vNewTransmissionLine.fx(commtransmission(z,z2),y)$(not sAdditionalTransfer(z,z2,y) and fAllowTransferExpansion) = 0;
2949   
2950  * Compute bounds
2951  vBuildTransmissionLine.lo(sTopology(z,z2),y) = max(0,vNewTransmissionLine.lo(z,z2,y) - vNewTransmissionLine.up(z,z2,y-1));
2952  vBuildTransmissionLine.up(sTopology(z,z2),y) = max(0,vNewTransmissionLine.up(z,z2,y) - vNewTransmissionLine.lo(z,z2,y-1));
2953   
2954  * Fix the storage build variable to zero if the project started before the model start year and storage is included
2955  vBuildStor.fx(eg,y)$(pGenData(eg,"StYr") <= sStartYear.val and fEnableStorage) = 0;
2956   
2957  * Fix the thermal build variable to zero if the project started before the model start year and CSP (Concentrated Solar Power) is included
2958  vBuildTherm.fx(eg,y)$(pGenData(eg,"StYr") <= sStartYear.val and fEnableCSP) = 0;
2959   
2960  * Disable all capacity expansion decisions when flag is off
2961  if (fEnableCapacityExpansion = 0,
2962     vBuild.fx(g,y)            = 0;
2963     vBuiltCapVar.fx(g,y)      = 0;
2964     vBuildStor.fx(g,y)        = 0;
2965     vBuildTherm.fx(g,y)       = 0;
2966     vBuildTransmissionLine.fx(z,z2,y) = 0;
2967     vNewTransmissionLine.fx(z,z2,y)   = 0;
2968     vBuildH2.fx(hh,y)         = 0;
2969     vBuiltCapVarH2.fx(hh,y)   = 0;
2970  );
2971   
2972  *-------------------------------------------------------------------
2973  * Fixed conditions
2974  *-------------------------------------------------------------------
2975   
2976   
2977  ********************* Load a previously saved solution**********************************************************
2978   
2979  * Load a previously saved solution from the specified path (if LOADSOLPATH is defined)
2980  * This solution contains the .l (level) values of capacity-related variables from a previous run
2982   
2983  ********************* Equations for generation capacity**********************************************************
2984  * Fix capacity to zero for generation projects that have not yet started in a given year
2985  vCap.fx(g,y)$(pGenData(g,"StYr") > y.val) = 0;
2986   
2987  * Set the fixed capacity for existing generation projects at the start year, if they were commissioned before the model start year
2988  vCap.fx(eg,sStartYear)$(pGenData(eg,"StYr") < sStartYear.val) = pGenData(eg,"Capacity");
2989   
2990  * Set fixed capacity for generation projects in years where they are within their operational period
2991  vCap.fx(eg,y)$((pGenData(eg,"StYr") <= y.val) and (pGenData(eg,"StYr") >= sStartYear.val)) = pGenData(eg,"Capacity");
2992   
2993  * Retire capacity by setting it to zero in the year of retirement
2994  vCap.fx(eg,y)$(pGenData(eg,"RetrYr") and (pGenData(eg,"RetrYr") <= y.val)) = 0;
2995   
2996  * Set the initial thermal capacity for CSP plants at the model start year, if commissioned before that year
2997  vCapTherm.fx(eg,sStartYear)$(pGenData(eg,"StYr") < sStartYear.val) = pCSPData(eg,"Thermal Field","CapacityMWh");
2998   
2999  * Set the initial storage capacity at the model start year, considering both CSP and standalone storage units
3000  vCapStor.fx(eg,sStartYear)$(pGenData(eg,"StYr") < sStartYear.val) = pCSPData(eg,"Storage","CapacityMWh") + pStorageData(eg,"CapacityMWh");
3001   
3002  * Prevent decommissioning of storage hours from existing storage when economic retirement is disabled
3003  vCapStor.fx(eg,y)$((pSettings("fEnableEconomicRetirement") = 0) and (pGenData(eg,"StYr") <= y.val) and (pGenData(eg,"RetrYr") >= y.val)) = pStorageData(eg,"CapacityMWh");
3004   
3005  * Fix the retirement variable to zero, meaning no unit is retired by default unless specified otherwise
3006  vRetire.fx(ng,y) = 0;
3007   
3008  * Ensure plants with a lifetime of 99 years (considered effectively infinite) are not retired
3009  vRetire.fx(eg,y)$(pGenData(eg,"Life") = 99) = 0;
3010   
3011  * Ensure capacity remains unchanged when economic retirement is disabled and the plant is still within its operational lifetime
3012  vCap.fx(eg,y)$((pSettings("fEnableEconomicRetirement") = 0 and pGenData(eg,"StYr") < y.val) and (pGenData(eg,"RetrYr") >= y.val)) = pGenData(eg,"Capacity");
3013   
3014  * Prevent thermal capacity from appearing in years before the commissioning date
3015  vCapTherm.fx(ng,y)$(pGenData(ng,"StYr") > y.val) = 0;
3016   
3017  * Prevent storage capacity from appearing in years before the commissioning date
3018  vCapStor.fx(ng,y)$(pGenData(ng,"StYr") > y.val) = 0;
3019   
3020  * Ensure storage capacity is set to zero if storage is not included in the scenario
3021  vCapStor.fx(ng,y)$(not fEnableStorage) = 0;
3022   
3023   
3024  ********************* Equations for hydrogen production**********************************************************
3025  *Maximum capacity is equal to "Capacity"
3026  vCapH2.up(hh,y) = pH2Data(hh,"Capacity");
3027   
3028  *No new capacity can be built for existing generators
3029  vBuildH2.fx(eh,y)$(pH2Data(eh,"StYr") <= sStartYear.val) = 0;
3030   
3031  *The new capacity for new generators can not exceed the annual limit
3032  vBuildH2.up(nh,y) = pH2Data(nh,"BuildLimitperYear")*pWeightYear(y);
3033   
3034  *Electrolyzers can not operate at days with zero demand (applicable to dispatch model)
3035  vH2PwrIn.fx(hh,q,d,t,y)$(sum(z,pDemandData(z,q,d,y,t))  =0)   =0;
3036   
3037  *The maximum power drawn for H2 production can't be more than the Capacity of the electrolyzer
3038  vH2PwrIn.up(hh,q,d,t,y)  =pH2Data(hh,"Capacity");
3039   
3040   
3041  vCapH2.fx(hh,y)$(pH2Data(hh,"StYr") > y.val)=0;
3042  vCapH2.fx(eh,sStartYear)$(pH2Data(eh,"StYr") < sStartYear.val) = pH2Data(eh,"Capacity");
3043  vCapH2.fx(eh,y)$((pH2Data(eh,"StYr") <= y.val) and (pH2Data(eh,"StYr") >= sStartYear.val)) = pH2Data(eh,"Capacity");
3044  vCapH2.fx(eh,y)$(pH2Data(eh,"RetrYr") and (pH2Data(eh,"RetrYr") <= y.val)) = 0;
3045   
3046  vRetireH2.fx(nh,y) = 0;
3047  vRetireH2.fx(eh,y)$(pH2Data(eh,"Life") = 99) = 0;
3048   
3049  vCapH2.fx(eh,y)$((pSettings("fEnableEconomicRetirement") = 0 and pH2Data(eh,"StYr") < y.val) and (pH2Data(eh,"RetrYr") >= y.val)) = pH2Data(eh,"Capacity");
3050   
3051  sH2PwrIn(hh,q,d,t,y) = yes;
3052   
3053  vREPwr2H2.fx(nRE,f,q,d,t,y)=0;
3054  vREPwr2Grid.fx(nRE,f,q,d,t,y)=0;
3055   
3056  *******************************************************************************************************************
3057   
3058  sPwrOut(gfmap(g,f),q,d,t,y) = yes;
3059  sPwrOut(gfmap(st,f),q,d,t,y)$(not fEnableStorage) = yes;
3060   
3061  * If price based export is not allowed, set to 0
3062  sExportPrice(z,zext,q,d,t,y)$(fEnableExternalExchange) = yes;
3063  sExportPrice(z,zext,q,d,t,y)$(not fEnableExternalExchange) = no;
3064   
3065  * If price based import is not allowed, set to 0
3066  sImportPrice(z,zext,q,d,t,y)$(fEnableExternalExchange) = yes;
3067  sImportPrice(z,zext,q,d,t,y)$(not fEnableExternalExchange) = no;
3068   
3069  vYearlyImportExternal.up(z,zext,q,d,t,y)$fEnableExternalExchange = pExtTransferLimitIn(z,zext,q,y);
3070  vYearlyExportExternal.up(z,zext,q,d,t,y)$fEnableExternalExchange = pExtTransferLimitOut(z,zext,q,y);
3071   
3072  * Do not allow imports and exports for a zone without import/export prices
3073  sExportPrice(z,zext,q,d,t,y)$(pTradePrice(zext,q,d,y,t)= 0) = no;
3074  sImportPrice(z,zext,q,d,t,y)$(pTradePrice(zext,q,d,y,t)= 0) = no;
3075   
3076  * Define the flow of electricity between zones
3077  sFlow(z,z2,q,d,t,y)$(sTopology(z,z2)) = yes;
3078   
3079  * Define spinning reserve constraints based on the settings for zonal and system spinning reserves
3080  sSpinningReserve(g,q,d,t,y)$((fApplyCountrySpinReserveConstraint or fApplySystemSpinReserveConstraint) ) = yes;
3081   
3082  *To avoid bugs when there is no candidate transmission expansion line
3083  pNewTransmission(z,z2,"EarliestEntry")$(not fAllowTransferExpansion) = 2500;
3084   
3085  *-------------------------------------------------------------------------------------
3086  * Ensure that variables fixed (`.fx`) at specific values remain unchanged during the solve process
3087  PA.HoldFixed=1;
3088   
3089  * Declare a file object `fmipopt` and set its name dynamically based on the modeltype
3090  file fmipopt / cplex.opt /;
3091  * Check if the set `mipopt` contains any elements (i.e., if modeltype options exist)
3092  if (card(mipopt),
3093   put fmipopt;
3094  * Loop over each entry in `mipopt` and write its text content to the file
3095   loop(mipline, put mipopt.te(mipline) /);
3096   putclose;
3097  );
3098   
3099  * Enable the modeltype to read an external modeltype option file
3100  PA.optfile = 1;
3101   
3102   
3103  * ############## SOLVE ##############
3104  * SOLVEMODE == 2 solves as usual
3105  * SOLVEMODE == 1 solves as usual but generates a savepoint file at the end
3106  * SOLVEMODE == 0 uses a savepoint file to skip the solve (This speeds up development of post solve features)
3107   
3110   
3111   
3113  *  Solve model as usual
3114     Solve PA using MIP minimizing vNPVcost;
3115  *  Abort if model was not solved successfully
3116     abort$(not (PA.modelstat=1 or PA.modelstat=8)) 'ABORT: no feasible solution found.', PA.modelstat;
3118   
3119  *  Export model data only when debugging is enabled
3121  * ####################################
3122   
3123  * Include the external report file specified by `%REPORT_FILE%`
3124   
3127   
INCLUDE    /Data/SAPP_2026/EPM/epm/generate_report.gms
3129  **********************************************************************
3130  * ELECTRICITY PLANNING MODEL (EPM)
3131  * Developed at the World Bank
3132  **********************************************************************
3133  * Description:
3134  * This GAMS-based model is designed for electricity system planning,
3135  * incorporating capacity expansion, generation dispatch, and policy
3136  * constraints such as renewable energy targets, emissions reductions,
3137  * and market mechanisms.
3138  *
3139  * Author(s): ESMAP Modelling Team
3140  * Organization: World Bank
3141  * Version:
3142  * License: Creative Commons Zero v1.0 Universal
3143  *
3144  * Key Features:
3145  * - Optimization of electricity generation and capacity planning
3146  * - Inclusion of renewable energy integration and storage technologies
3147  * - Multi-period, multi-region modeling framework
3148  * - CO2 emissions constraints and policy instruments
3149  *
3150  * Notes:
3151  * - Ensure GAMS is installed before running this model.
3152  * - The model requires input data in .GDX or Excel format.
3153  *
3154  * Contact:
3155  * Claire Nicolas, cnicolas@worldbank.org
3156  **********************************************************************
3157   
3158   
3160  * Report
3161   
3162  set sumhdr /
3163    "Generation costs: $m",
3164    "Fixed O&M: $m",
3165    "Variable O&M: $m",
3166    "Startup costs: $m",
3167    "Fuel costs: $m",
3168    "Transmission costs: $m",
3169    "Spinning reserve costs: $m",
3170    "Unmet demand costs: $m",
3171    "Unmet country spinning reserve costs: $m",
3172    "Unmet country planning reserve costs: $m",
3173    "Unmet country CO2 backstop cost: $m",
3174    "Unmet system planning reserve costs: $m",
3175    "Unmet system spinning reserve costs: $m",
3176    "Unmet system CO2 backstop cost: $m",
3177    "Excess generation: $m",
3178    "VRE curtailment: $m",
3179    "Import costs with external zones: $m",
3180    "Export revenues with external zones: $m",
3181    "Import costs with internal zones: $m",
3182    "Export revenues with internal zones: $m",
3183    "Trade shared benefits: $m",
3184    "Carbon costs: $m",
3185    "NPV of system cost: $m"
3186  /;
3187   
3188  * Set of demand-related summary labels
3189  set dshdr /
3190    "Demand: GWh",
3191    "Electricity demand for H2 production: GWh",
3192    "Total Demand (Including P to H2): GWh",
3193    "Total production: GWh",
3194    "Unmet demand: GWh",
3195    "Surplus generation: GWh",
3196    "Imports exchange: GWh",
3197    "Exports exchange: GWh",
3198    "Net interchange: GWh",
3199    "Net interchange Ratio: GWh"
3200  /;
3201   
3202  * H2-specific
3203  set dsH2hdr /
3204    "Electricity demand for H2 production: GWh",
3205    "Total H2 Production: mmBTU",
3206    "External Demand of H2: mmBTU",
3207    "Unmet External Demand of H2: mmBTU",
3208    "H2 produced for power production: mmBTU"
3209  /;
3210   
3211  set zgmap(z,g); option zgmap<gzmap;
3212  set zH2map(z,hh); option zH2map<h2zmap;
3213   
3214  set capexComponent /
3215    Generation,
3216    StorageEnergy,
3217    CSPThermalField,
3218    CSPStorage,
3219    Hydrogen,
3220    Transmission
3221  /;
3222   
3223  set capexComponentPlant(capexComponent) /
3224    Generation,
3225    StorageEnergy,
3226    CSPThermalField,
3227    CSPStorage
3228  /;
3229   
3230  set genCostCmp /
3231    "Generation costs: $m",
3232    "Fixed O&M: $m",
3233    "Variable Cost: $m"
3234  /;
3235   
3236  set fEnergyBalance /
3237    #f,
3238    UnmetDemand,
3239    Surplus,
3240    Imports,
3241    Exports
3242  /;
3243   
3244  Parameters
3245   
3246  * ============================================================
3247  * 1. CAPACITY
3248  * ============================================================
3249   
3250    pCapacityPlant(z,g,y)                      'Installed capacity [MW] by plant, zone, and year'
3251    pNewCapacityPlant(z,g,y)                   'Newly added capacity [MW] by plant, zone, and year'
3252    pCapacityTechFuel(z,tech,f,y)              'Installed capacity [MW] by technology, fuel, and zone'
3253    pCapacityFuel(z,f,y)                       'Installed capacity [MW] by fuel and zone'
3254    pCapacityTechFuelCountry(c,tech,f,y)       'Installed capacity [MW] by technology, fuel, and country'
3255    pCapacityFuelCountry(c,f,y)                'Installed capacity [MW] by fuel and country'
3256   
3257    pRetirementsPlant(z,g,y)                   'Retired capacity [MW] by plant, zone, and year'
3258    pRetirementsFuel(z,f,y)                    'Retired capacity [MW] by fuel and zone'
3259    pRetirementsCountry(c,y)                   'Total retired capacity [MW] by country and year'
3260    pRetirementsFuelCountry(c,f,y)             'Retired capacity [MW] by fuel and country'
3261   
3262    pNewCapacityFuel(z,f,y)                    'Newly added capacity [MW] by fuel and zone'
3263    pNewCapacityTech(z,tech,y)                 'Newly added capacity [MW] by technology and zone'
3264    pNewCapacityTechFuel(z,tech,f,y)           'Newly added capacity [MW] by technology, fuel, and zone'
3265    pNewCapacityFuelCountry(c,f,y)             'Newly added capacity [MW] by fuel and country'
3266    pNewCapacityTechCountry(c,tech,y)          'Newly added capacity [MW] by technology and country'
3267    pNewCapacityTechFuelCountry(c,tech,f,y)    'Newly added capacity [MW] by technology, fuel, and country'
3268   
3269    pAdditionalTransmissionCapacity(z, z2, y)
3270    pAnnualTransmissionCapacity(z,z2,y)        'Total available transmission capacity [MW] between internal zones'
3271    pNewTransmissionCapacity(z,z2,y)           'New transmission capacity built [MW] between internal zones'
3272   
3273    pCapacitySummary(z,*,y)                    'Summary of capacity indicators [MW] by zone and year'
3274    pCapacitySummaryCountry(c,*,y)             'Summary of capacity indicators [MW] by country and year'
3275   
3276    pCapacityPlantH2(z,hh,y)                   'Capacity plan of electrolyzers [MW] by zone'
3277    pGeneratorTechFuel(g,tech,f)               'Mapping of generator to technology and fuel'
3278    pZoneCountry(z,c)                          'Mapping of zone to country'
3279   
3280  * ============================================================
3281  * 2. COSTS
3282  * ============================================================
3283   
3284    pCostsPlant(z, g, *, y)                       'Yearly cost breakdown by plant and year'
3285   
3286    pCapexInvestmentPlant(z, g, *, y) 'CAPEX investment [USD] by plant and component'
3287    pCapexInvestmentTransmission(z, z2, y) 'Transmission CAPEX [USD] by line and year'
3288    pCapexInvestmentComponent(z, *, y) 'Annual CAPEX investment [USD] by component and zone'
3289    pCapexInvestment(z, y)                        'Annual CAPEX investment in USD by zone and year'
3290   
3291    pPrice(z, q, d, t, y)                         'Marginal cost [USD/MWh] by zone, time, and year'
3292    pImportCostsInternal(z, y)                    'Import costs with internal zones [USD] by zone and year'
3293    pExportRevenuesInternal(z, y)                 'Export revenues with internal zones [USD] by zone and year'
3294    pCongestionRevenues(z, z2, y)                 'Congestion rents [USD] from saturated lines z→z2 by year'
3295    pTradeSharedBenefits(z, y)                    'Congestion rents shared equally between countries [USD] by zone and year'
3296   
3297    pYearlyCostsZone(z, *, y)                      'Annual cost summary [million USD] by zone and year'
3298    pYearlyDiscountedWeightedCostsZone(z, *, y)   'Discounted weighted annual cost [million USD] by zone and year'
3299    pCostsZone(z, *)                               'Total cost [million USD] by zone and cost category'
3300    pYearlyCostsCountry(c, *, y)                   'Annual cost summary [million USD] by country and year'
3301    pYearlyCostsSystem
3302    pCostsSystem(*)                                'System-level cost summary [million USD], weighted and discounted'
3303    pCostsSystemPerMWh(*)                          'System-level cost summary [$ / MWh], weighted and discounted'
3304    pYearlySystemCostEnergyBasis(y)                'System cost energy denominator [MWh] by year'
3305    pDiscountedDemandZoneMWh(z)                    'Discounted electricity demand basis [MWh] by zone'
3306    pDiscountedDemandCountryMWh(c)                 'Discounted electricity demand basis [MWh] by country'
3307    pDiscountedDemandSystemMWh                     'Discounted electricity demand basis [MWh] for the system'
3308   
3309    pFuelCosts(z, f, y)                           'Annual fuel costs [million USD] by fuel, zone, and year'
3310    pFuelCostsCountry(c, f, y)                    'Annual fuel costs [million USD] by fuel, country, and year'
3311    pFuelConsumption(z, f, y)                     'Annual fuel consumption [MMBtu] by fuel, zone, and year'
3312    pFuelConsumptionCountry(c, f, y)              'Annual fuel consumption [MMBtu] by fuel, country, and year'
3313   
3314  * ============================================================
3315  * 3. ENERGY BALANCE
3316  * ============================================================
3317   
3318    pEnergyPlant(z,g,y)                     'Annual energy generation by plant [GWh]'
3319    pEnergyFuel(z,f,y)                      'Annual energy generation by fuel and zone [GWh]'
3320    pEnergyFuelCountry(c,f,y)               'Annual energy generation by fuel and country [GWh]'
3321    pEnergyFuelComplete(z,*,y)              'Energy balance by fuel and slack components [GWh]'
3322    pEnergyTechFuel(z,tech,f,y)             'Annual energy generation by technology, fuel, and zone [GWh]'
3323    pEnergyTechFuelComplete(z,*,*,y)        'Energy balance by technology, fuel, and slack components [GWh]'
3324    pEnergyTechFuelCountry(c,tech,f,y)      'Annual energy generation by technology, fuel, and country [GWh]'
3325   
3326    pEnergyBalance(z,*,y)                   'Annual supply-demand balance by zone [GWh]'
3327    pEnergyBalanceCountry(c,*,y)            'Annual supply-demand balance by country [GWh]'
3328    pEnergyBalanceH2(z,*,y)                 'Annual hydrogen supply-demand balance by zone [mmBTU]'
3329    pEnergyBalanceCountryH2(c,*,y)          'Annual hydrogen supply-demand balance by country [mmBTU]'
3330   
3331    pUtilizationPlant(z,g,y)                'Annual plant utilization factor'
3332    pUtilizationTech(z,tech,y)              'Annual technology utilization factor'
3333    pUtilizationFuel(z,f,y)                 'Annual average capacity factor by fuel'
3334    pUtilizationTechFuel(z,tech,f,y)        'Annual average capacity factor by technology and fuel'
3335    pUtilizationFuelCountry(c,f,y)          'Annual average capacity factor by fuel and country'
3336    pUtilizationTechFuelCountry(c,tech,f,y) 'Annual average capacity factor by technology, fuel, and country'
3337   
3338  * ============================================================
3339  * 4. ENERGY DISPATCH
3340  * ============================================================
3341   
3342    pDispatchPlant(z, y, q, d, g, t, *)      'Plant-level hourly dispatch and reserve [MW]'
3343    pDispatchFuel(z, y, q, d, f, t)          'Fuel-level hourly dispatch [MW]'
3344    pDispatchTechFuel(z, y, q, d, tech, f, t) 'Technology-fuel level hourly dispatch [MW]'
3345    pDispatch(z, y, q, d, *, t)              'Zone-level hourly dispatch and flows [MW]'
3346   
3347  * ============================================================
3348  * 5. RESERVES
3349  * ============================================================
3350   
3351    pReserveSpinningPlantZone(z,g,y)        'Spinning reserve provided by plant [MWh] per zone and year'
3352    pReserveSpinningFuelZone(z,f,y)         'Spinning reserve provided by fuel [MWh] per zone and year'
3353    pReserveSpinningTechFuelZone(z,tech,f,y) 'Spinning reserve provided by technology-fuel [GWh] per zone and year'
3354    pReserveSpinningPlantCountry(c,g,y)     'Spinning reserve provided by plant [MWh] per country and year'
3355    pReserveSpinningTechFuelCountry(c,tech,f,y) 'Spinning reserve provided by technology-fuel [GWh] per country and year'
3356   
3357    pReserveMargin(z,*,y)                   'Reserve margin indicators by zone and year'
3358    pReserveMarginCountry(c,*,y)            'Reserve margin indicators by country and year'
3359   
3360  * ============================================================
3361  * 6. INTERCONNECTIONS
3362  * ============================================================
3363   
3364    pInterchange(z, z2, y)                'Annual energy exchanged [GWh] between internal zones'
3365    pInterconUtilization(z, z2, y)        'Interconnection utilization [%] between internal zones'
3366    pLossesTransmission(z, y)             'Transmission losses [MWh] per internal zone'
3367    pInterchangeCountry(c, c2, y)         'Annual energy exchanged [GWh] between countries'
3368    pLossesTransmissionCountry(c, y)      'Transmission losses [MWh] per country'
3369    isCongested(z, z2, q, d, t, y)        'Congestion indicator for line z-z2 at time q,d,t,y'
3370    pCongestionShare(z, z2, y)            'Share of time congested [%] for line z-z2'
3371   
3372    pHourlyInterchangeExternal(z, y, q, d, *, t)            'Hourly external trade [MW] per zone'
3373    pYearlyInterchangeExternal(z, *, y)                     'Annual external trade [GWh] per zone'
3374    pYearlyInterchangeExternalCountry(c, *, y)              'Annual external trade [GWh] per country'
3375    pHourlyInterchangeExternalCountry(c, y, q, d, *, t)     'Hourly external trade [MW] per country'
3376   
3377    pInterchangeExternalExports(z, zext, y)                 'Annual exports [GWh] from zone z to external zone zext'
3378    pInterchangeExternalImports(zext, z, y)                 'Annual imports [GWh] from external zone zext to zone z'
3379    pInterconUtilizationExternalExports(z, zext, y)         'External export line utilization [%] zone z to zext'
3380    pInterconUtilizationExternalImports(zext, z, y)         'External import line utilization [%] zext to zone z'
3381   
3382  * ============================================================
3383  * 7. EMISSIONS
3384  * ============================================================
3385   
3386    pEmissionsZone(z,y)                    'CO2 emissions [Mt] by zone and year'
3387    pEmissionsIntensityZone(z,y)           'CO2 intensity [tCO2/GWh] by zone and year'
3388    pEmissionsCountrySummary(c,*,y)        'CO2 emissions [Mt] by country, type, and year'
3389    pEmissionsIntensityCountry(c,y)        'CO2 intensity [tCO2/GWh] by country and year'
3390   
3391    pEmissionMarginalCostsCountry(c,y)     'Marginal cost of country emission constraint [USD/tCO2]'
3392    pEmissionMarginalCosts(y)              'Marginal cost of system emission constraint [USD/tCO2]'
3393   
3394  * ============================================================
3395  * 8. PRICES
3396  * ============================================================
3397   
3398    pYearlyPrice(z,y)                        'Demand-weighted average electricity price [USD/MWh] by zone and year'
3399    pYearlyPriceExport(z,y)                  'Flow-weighted average export price [USD/MWh] by zone and year'
3400    pYearlyPriceImport(z,y)                  'Flow-weighted average import price [USD/MWh] by zone and year'
3401    pYearlyPriceHub(z,y)                     'Flow-weighted hub price [USD/MWh] by zone and year'
3402    pYearlyPriceCountry(c,y)                 'Demand-weighted average electricity price [USD/MWh] by country and year'
3403    pYearlyPriceExportCountry(c,y)           'Flow-weighted average export price [USD/MWh] by country and year'
3404    pYearlyPriceImportCountry(c,y)           'Flow-weighted average import price [USD/MWh] by country and year'
3405   
3406  * ============================================================
3407  * 9. SPECIAL TECHNOLOGIES
3408  * ============================================================
3409   
3410    pCSPBalance(y,g,q,d,*,t)                  'CSP hourly output by type [MW]'
3411    pCSPComponents(g,*,y)                     'CSP installed components and metrics'
3412    pPVwSTOBalance(y,q,d,g,*,t)               'PV+Storage hourly output by type [MW]'
3413    pPVwSTOComponents(g,*,y)                  'PV+Storage installed components and metrics'
3414    pStorageBalance(y,g,q,d,*,t)              'Generic storage hourly output by type [MW]'
3415    pStorageComponents(g,*,y)                 'Generic storage installed components and metrics'
3416    pSolarValueZone(z,y)                      'Average market value of solar [USD/MWh]'
3417    pSolarCost(z,y)                           'Levelized cost of solar [USD/MWh]'
3418    pSolarPower(z,q,d,t,y)                    'Solar hourly output [MWh]'
3419   
3420  * ============================================================
3421  * 10. METRICS
3422  * ============================================================
3423   
3424    pPlantAnnualLCOE(z,g,y)          'Plant-level LCOE [USD/MWh] by year'
3425    pYearlyGenCostZonePerMWh(z,genCostCmp,y) 'Zone generation cost by component [USD/MWh]'
3426    pCostsZonePerMWh(z,sumhdr)       'Zone cost per discounted demand [USD/MWh]'
3427    pCostsCountryPerMWh(c,sumhdr)    'Country cost per discounted demand [USD/MWh]'
3428    pYearlyCostsZonePerMWh(z,sumhdr,y)    'Zone average cost by component [USD/MWh]'
3429    pYearlyCostsCountryPerMWh(c,sumhdr,y) 'Country average cost by component [USD/MWh]'
3430    pYearlyCostsSystemPerMWh(sumhdr, y)            'System average cost [USD/MWh] by year'
3431   
3432  * ============================================================
3433  * 11. modeltype PARAMETERS
3434  * ============================================================
3435     pSolverParameters(*)                      'modeltype parameters'
3436  ;
3437   
3438  * Mapping
3439   
3440  pGeneratorTechFuel(g, tech, f) = sum(z, gmap(g, z, tech, f));
3441  pGeneratorTechFuel(g, tech, f)$pGeneratorTechFuel(g, tech, f) = 1;
3442   
3443  pZoneCountry(z, c) = zcmap(z, c);
3444  pZoneCountry(z, c)$pZoneCountry(z, c) = 1;
3445   
3446   
3447  * ============================================================
3448  * 1. CAPACITY
3449  * ============================================================
3450   
3451  * ---------------------------------------------------------
3452  * Plant and technology-level capacity and utilization
3453  * ---------------------------------------------------------
3454  * Records installed capacity, retirements, and utilization
3455  * factors for each plant and aggregated by technology:
3456  *   - pCapacityPlant: installed capacity by plant
3457  *   - pRetirementsPlant: retired capacity by plant
3458   
3459  * ---------------------------------------------------------
3460   
3461  pCapacityPlant(zgmap(z,g),y)                 = vCap.l(g,y);
3462   
3463  pNewCapacityPlant(zgmap(z,g),y)              = vBuild.l(g,y);
3464   
3465  pRetirementsPlant(zgmap(z,g),y)                  = vRetire.l(g,y);
3466   
3467   
3468  * ---------------------------------------------------------
3469  * Capacity, new builds, retirements, and utilization by fuel and technology
3470  * ---------------------------------------------------------
3471  * Tracks installed capacity, new capacity, and retirements
3472  * disaggregated by fuel type and technology.
3473  * Also computes utilization factors:
3474  *   - pCapacityTechFuel / pCapacityFuel: installed capacity
3475  *   - pNewCapacityFuel / pNewCapacityTech: new builds
3476  *   - pRetirementsFuel: retirements
3477   
3478  * ---------------------------------------------------------
3479   
3480  * Installed capacity by technology and fuel [MW]
3481  pCapacityTechFuel(z, tech, f, y) =
3482    sum((gzmap(g, z), gtechmap(g, tech), gprimf(g, f)), vCap.l(g, y));
3483   
3484  * Installed capacity by fuel [MW]
3485  pCapacityFuel(z, f, y) =
3486    sum((gzmap(g, z), gprimf(g, f)), vCap.l(g, y));
3487   
3488  * New capacity by fuel [MW]
3489  pNewCapacityFuel(z, f, y) =
3490    sum((gzmap(g, z), gprimf(g, f)), vBuild.l(g, y));
3491   
3492  * New capacity by technology [MW]
3493  pNewCapacityTech(z, tech, y) =
3494    sum((gzmap(g, z), gtechmap(g, tech), gprimf(g, f)), vBuild.l(g, y));
3495   
3496  * New capacity by technology and fuel [MW]
3497  pNewCapacityTechFuel(z, tech, f, y) =
3498    sum((gzmap(g, z), gtechmap(g, tech), gprimf(g, f)), vBuild.l(g, y));
3499   
3500  * Retirements by fuel [MW]
3501  pRetirementsFuel(z, f, y) =
3502    sum((gzmap(g, z), gprimf(g, f)), vRetire.l(g, y));
3503   
3504  * ---------------------------------------------------------
3505  * Transmission capacity expansion and annual limits
3506  * ---------------------------------------------------------
3507  * pNewTransmissionCapacity:
3508  *   - Incremental transmission capacity built in year y
3509  *   - Based on yearly build decisions and per-line capacity
3510  *
3511  * pAnnualTransmissionCapacity:
3512  *   - Total available transfer capacity in a year
3513  *   - Equals existing maximum transfer limit plus any new additions
3514  * ---------------------------------------------------------
3515   
3516  pNewTransmissionCapacity(sTopology(z,z2),y) =
3517    vBuildTransmissionLine.l(z,z2,y)
3518    * max(pNewTransmission(z,z2,"CapacityPerLine"),pNewTransmission(z2,z,"CapacityPerLine"))
3519    * fAllowTransferExpansion;
3520   
3521  pAdditionalTransmissionCapacity(sTopology(z,z2),y) = vNewTransmissionLine.l(z,z2,y)*max(pNewTransmission(z,z2,"CapacityPerLine"),pNewTransmission(z2,z,"CapacityPerLine"))*fAllowTransferExpansion;
3522  pAnnualTransmissionCapacity(sTopology(z,z2),y) = pAdditionalTransmissionCapacity(z,z2,y) + smax(q, pTransferLimit(z,z2,q,y)) ;
3523   
3524  * ---------------------------------------------------------
3525  * Country-level capacity, new builds, retirements, and utilization
3526  * ---------------------------------------------------------
3527  * Aggregates zonal results to the country level:
3528  *   - pCapacityPlantCountry: installed capacity by plant
3529  *   - pCapacityTechFuelCountry / pCapacityFuelCountry: installed capacity by tech-fuel or fuel
3530  *   - pNewCapacityFuelCountry / pNewCapacityTechCountry: new builds by fuel or tech
3531  *   - pRetirementsFuelCountry / pRetirementsCountry: retirements by fuel and total
3532  *   - pUtilizationFuelCountry / pUtilizationTechFuelCountry:
3533  *       utilization factors (energy ÷ capacity × hours) by fuel or tech-fuel
3534  * ---------------------------------------------------------
3535   
3536  pCapacityTechFuelCountry(c, tech, f, y) =
3537    sum(zcmap(z, c), pCapacityTechFuel(z, tech, f, y));
3538   
3539  pCapacityFuelCountry(c, f, y) =
3540    sum(zcmap(z, c), pCapacityFuel(z, f, y));
3541   
3542  pNewCapacityFuelCountry(c, f, y) =
3543    sum(zcmap(z, c), pNewCapacityFuel(z, f, y));
3544   
3545  pNewCapacityTechCountry(c, tech, y) =
3546    sum(zcmap(z, c), pNewCapacityTech(z, tech, y));
3547   
3548  pNewCapacityTechFuelCountry(c, tech, f, y) =
3549    sum(zcmap(z, c), pNewCapacityTechFuel(z, tech, f, y));
3550   
3551  pRetirementsFuelCountry(c, f, y) =
3552    sum(zcmap(z, c), pRetirementsFuel(z, f, y));
3553   
3554  pRetirementsCountry(c, y) =
3555    sum((zcmap(z, c), f), pRetirementsFuel(z, f, y));
3556   
3557  * ---------------------------------------------------------
3558  * Capacity summary at zone and country level [MW]
3559  * ---------------------------------------------------------
3560  * Provides aggregated indicators of system capacity:
3561  *   - Available capacity
3562  *   - Peak demand (with and without power-to-hydrogen load)
3563  *   - New capacity builds
3564  *   - Retired capacity
3565  *   - Committed total transmission capacity
3566  * Reported at both zonal and country aggregation levels.
3567  * ---------------------------------------------------------
3568   
3569  pCapacitySummary(z,"Available capacity: MW",y) = sum(gzmap(g,z), vCap.l(g,y));
3570  pCapacitySummary(z,"Peak demand: MW"       ,y) = smax((q,d,t), pDemandData(z,q,d,y,t)*pEnergyEfficiencyFactor(z,y));
3571  pCapacitySummary(z,"Peak demand including P to H2: MW"       ,y) = smax((h2zmap(hh,z),q,d,t), pDemandData(z,q,d,y,t)*pEnergyEfficiencyFactor(z,y) + vH2PwrIn.l(hh,q,d,t,y))$fEnableH2Production+1e-6;
3572  pCapacitySummary(z,"New capacity: MW"      ,y) = sum(gzmap(g,z), vBuild.l(g,y));
3573  pCapacitySummary(z,"Retired capacity: MW"  ,y) = sum(gzmap(g,z), vRetire.l(g,y));
3574  pCapacitySummary(z,"Committed Total TX capacity: MW"  ,y) = sum((z2,q), pTransferLimit(z,z2,q,y)/card(q));
3575   
3576  pCapacitySummaryCountry(c,"Available capacity: MW",y) = sum(zcmap(z,c), pCapacitySummary(z,"Available capacity: MW",y));
3577  pCapacitySummaryCountry(c,"Peak demand: MW"       ,y) = smax((q,d,t), sum(zcmap(z,c), pDemandData(z,q,d,y,t)*pEnergyEfficiencyFactor(z,y)));
3578  pCapacitySummaryCountry(c,"New capacity: MW"      ,y) = sum(zcmap(z,c), pCapacitySummary(z,"New capacity: MW",y));
3579  pCapacitySummaryCountry(c,"Retired capacity: MW"  ,y) = sum(zcmap(z,c), pCapacitySummary(z,"Retired capacity: MW",y));
3580  pCapacitySummaryCountry(c,"Committed Total TX capacity: MW",y) = sum(zcmap(z,c), pCapacitySummary(z,"Committed Total TX capacity: MW",y));
3581   
3582  * H2 model additions
3583  pCapacityPlantH2(zh2map(z,hh),y) = vCapH2.l(hh,y)$fEnableH2Production+1e-6;
3584   
3585  * ============================================================
3586  * 2. COSTS
3587  * ============================================================
3588   
3589  * Reporting costs by plant
3590  * Plant-level cost reporting (prettier formatting)
3591  pCostsPlant(z, g, "Generation costs: $m", y)$gzmap(g, z) =
3592    vAnnGenCapex.l(g, y) / 1e6;
3593   
3594  pCostsPlant(z, g, "Fixed O&M: $m", y)$gzmap(g, z) =
3595    (
3596      vCap.l(g, y)      * pGenData(g, "FOMperMW")
3597      + vCapStor.l(g, y)  * pStorageData(g, "FixedOMMWh")
3598      + vCapStor.l(g, y)  * pCSPData(g, "Storage", "FixedOMMWh")
3599      + vCapTherm.l(g, y) * pCSPData(g, "Thermal field", "FixedOMMWh")
3600    ) / 1e6;
3601   
3602  pCostsPlant(z, g, "Variable Cost: $m", y)$gzmap(g, z) =
3603    sum((gfmap(g, f), q, d, t),
3604      pVarCost(g, f, y) * vPwrOut.l(g, f, q, d, t, y) * pHours(q, d, t)
3605    ) / 1e6;
3606   
3607  pCostsPlant(z, g, "Spinning Reserve Cost: $m", y)$gzmap(g, z) =
3608    sum((q, d, t),
3609      vSpinningReserve.l(g, q, d, t, y) * pGenData(g, "ReserveCost") * pHours(q, d, t)
3610    ) / 1e6;
3611   
3612  * ---------------------------------------------------------
3613  * Plant-level CAPEX investment breakdown [USD]
3614  * ---------------------------------------------------------
3615  * Stores the non-Generation costs flows for each plant and
3616  * component so that we can add dedicated transmission and
3617  * hydrogen entries later on.
3618  * ---------------------------------------------------------
3619   
3620  pCapexInvestmentPlant(zgmap(z,g), "Generation", y)$((not st(g))) =
3621    1e6 * vBuild.l(g, y) * pGenData(g, "Capex") * pCapexTrajectories(g, y);
3622   
3623  pCapexInvestmentPlant(zgmap(z,g), "StorageEnergy", y)$((st(g)) and (not cs(g))) =
3624    1e3 * vBuildStor.l(g, y) * pStorageData(g, "CapexMWh") * pCapexTrajectories(g, y) +
3625    1e6 * vBuild.l(g, y) * pGenData(g, "Capex") * pCapexTrajectories(g, y);
3626   
3627  pCapexInvestmentPlant(zgmap(z,g), "CSPThermalField", y)$cs(g) =
3628    1e3 * vBuildTherm.l(g, y) * pCSPData(g, "Thermal Field", "CapexMWh") * 1e3 * pCapexTrajectories(g, y);
3629   
3630  pCapexInvestmentPlant(zgmap(z,g), "CSPStorage", y)$cs(g) =
3631    1e3 * vBuildStor.l(g, y) * pCSPData(g, "Storage", "CapexMWh") * pCapexTrajectories(g, y);
3632   
3633  * Derive zonal totals per component (generation-related ones come from plants)
3634  pCapexInvestmentComponent(z, capexComponentPlant, y) =
3635    sum(zgmap(z, g), pCapexInvestmentPlant(z, g, capexComponentPlant, y));
3636   
3637  * Hydrogen CAPEX is tracked separately
3638  pCapexInvestmentComponent(z, "Hydrogen", y)$fEnableH2Production =
3639    1e6 * sum(zH2map(z, hh),
3640      vBuildH2.l(hh, y) * pH2Data(hh, "Capex") * pCapexTrajectoriesH2(hh, y)
3641    );
3642   
3643  * Transmission CAPEX additions
3644  pCapexInvestmentComponent(z, "Transmission", y)$(fAllowTransferExpansion and sum(sTopology(z, z2), 1)) =
3645    0.5 * sum(sTopology(z, z2),
3646      vBuildTransmissionLine.l(z, z2, y)
3647      * max(pNewTransmission(z,z2,"CostPerLine"),pNewTransmission(z2,z,"CostPerLine"))
3648      * 1e6
3649    );
3650   
3651  pCapexInvestmentTransmission(sTopology(z, z2), y)$fAllowTransferExpansion =
3652    0.5 * vBuildTransmissionLine.l(z, z2, y)
3653    * max(pNewTransmission(z,z2,"CostPerLine"),pNewTransmission(z2,z,"CostPerLine"))
3654    * 1e6;
3655   
3656  * ---------------------------------------------------------
3657  * Zone-level CAPEX investment flows [$]
3658  * ---------------------------------------------------------
3659  * Captures the annual capital expenditures for new builds
3660  * in zone z and year y, before annualization.
3661  *
3662  * Components:
3663  *   - Generation builds (MW × $/MW × cost trajectory)
3664  *   - Storage builds (MWh × $/MWh × cost trajectory)
3665  *   - CSP thermal field and storage builds (MWh × $/MWh × trajectory)
3666  *   - Hydrogen builds (MW × $/MW × cost trajectory), optional
3667  *   - Small epsilon added to avoid divide-by-zero issues
3668  * ---------------------------------------------------------
3669   
3670  pCapexInvestment(z, y) =
3671    sum(capexComponent, pCapexInvestmentComponent(z, capexComponent, y))
3672    + 1e-6;
3673   
3674   
3675  * ---------------------------------------------------------
3676  * Price calculation [$/MWh]
3677  * ---------------------------------------------------------
3678  * Market clearing price derived from the dual variable of the
3679  * demand-supply balance constraint, scaled by operating hours,
3680  * discount rate (pRR), and year weight.
3681  * --------------------------------------------------------
3682   
3683  pPrice(z,q,d,t,y)$(pHours(q,d,t)) = -eDemSupply.m(z,q,d,t,y)/pHours(q,d,t)/pRR(y)/pWeightYear(y);
3684   
3685  * ---------------------------------------------------------
3686  * Import and export costs with internal zones [$]
3687  * ---------------------------------------------------------
3688  * Import costs:
3689  *   - Value of inflows from neighboring zones
3690  *   - Calculated as local price × imported flow × hours
3691  *
3692  * Export revenues:
3693  *   - Value of outflows to neighboring zones
3694  *   - Negative sign ensures revenues reduce total cost
3695  * ---------------------------------------------------------
3696   
3697  pImportCostsInternal(z,y) = sum((sTopology(Zd,z),q,d,t), pPrice(z,q,d,t,y)*vFlow.l(Zd,z,q,d,t,y)*pHours(q,d,t));
3698   
3699  pExportRevenuesInternal(z,y) = - sum((sTopology(z,Zd),q,d,t), pPrice(z,q,d,t,y)*vFlow.l(z,Zd,q,d,t,y)*pHours(q,d,t));
3700   
3701  * ---------------------------------------------------------
3702  * Congestion rents between zones [$]
3703  * ---------------------------------------------------------
3704  * Difference in marginal prices × traded flow × hours
3705  * Negative sign ensures consistency with rent allocation
3706  * ---------------------------------------------------------
3707   
3708  pCongestionRevenues(z,Zd,y) = - sum((q,d,t), (pPrice(zD,q,d,t,y) - pPrice(z,q,d,t,y))*vFlow.l(z,Zd,q,d,t,y)*pHours(q,d,t));
3709   
3710  * ---------------------------------------------------------
3711  * Trade shared benefits [$]
3712  * ---------------------------------------------------------
3713  * Congestion rents are split equally (50/50) between
3714  * importing and exporting zones as the allocation rule
3715  * ---------------------------------------------------------
3716   
3717  pTradeSharedBenefits(z,y) = 0.5*sum(sTopology(Zd,z), pCongestionRevenues(Zd,z,y)) + 0.5*sum(sTopology(z,Zd), pCongestionRevenues(z,Zd,y));
3718   
3719  * ---------------------------------------------------------
3720  * Net trade costs with internal zones [$]
3721  * ---------------------------------------------------------
3722  * Equivalent formulation where:
3723  *   Trade cost = Import cost + Export revenues + Shared rents
3724  * This matches pricing trades at the average marginal price
3725  * between connected zones
3726  * ---------------------------------------------------------
3727   
3728  * pTradeCostsInternal(z,y) = pExportRevenuesInternal(z,y) + pImportCostsInternal(z,y) + pTradeSharedBenefits(z,y);
3729   
3730  * ---------------------------------------------------------
3731  * Demand allocation [GWh → TWh]
3732  * ---------------------------------------------------------
3733  * Zone-level demand:
3734  *   - Sum of hourly demand × operating hours
3735  *   - Adjusted by efficiency factor
3736  *   - Converted from GWh to TWh
3737  *
3738  * Country-level demand:
3739  *   - Aggregation of zonal demand by mapping zones to countries
3740  * ---------------------------------------------------------
3741  Parameter
3742    pDemandEnergyZone(z,y)         'Total energy demand [GWh] by zone and year'
3743    pDemandEnergyCountry(c,y)      'Total energy demand [GWh] by country and year'
3744    pDemandEnergySystem(y)         'Total system energy demand [GWh] by year'
3745    pDemandPeakZone(z,y)           'Peak demand [MW] by zone and year'
3746    pDemandPeakCountry(c,y)        'Peak demand [MW] by country and year'
3747    pDemandPeakSystem(y)           'Peak demand [MW] by year'
3748  ;
3749   
3750  pDemandEnergyZone(z,y) = sum((q,d,t), pDemandData(z,q,d,y,t) * pHours(q,d,t) * pEnergyEfficiencyFactor(z,y)) / 1e3;
3751  pDemandEnergyCountry(c,y) = sum(zcmap(z,c), pDemandEnergyZone(z,y));
3752  pDemandEnergySystem(y) = sum(z, pDemandEnergyZone(z,y));
3753   
3754  pDemandPeakZone(z,y) = smax((q,d,t), pDemandData(z,q,d,y,t) * pEnergyEfficiencyFactor(z,y));
3755  pDemandPeakCountry(c,y) = smax((q,d,t), sum(zcmap(z,c), pDemandData(z,q,d,y,t) * pEnergyEfficiencyFactor(z,y)));
3756  pDemandPeakSystem(y) = smax((q,d,t), sum(z, pDemandData(z,q,d,y,t) * pEnergyEfficiencyFactor(z,y)));
3757   
3758  * ---------------------------------------------------------
3759  * Zone-level cost components [$m]
3760  * ---------------------------------------------------------
3761  * Each entry in pYearlyCostsZone stores one annual cost component
3762  * at the zonal level in million $.
3763  *
3764  * Categories included:
3765  *   - Generation costs
3766  *   - Fixed O&M
3767  *   - Variable O&M
3768  *   - Fuel costs
3769  *   - Transmission costs
3770  *   - Spinning reserve costs
3771  *   - Unmet demand, reserve, and CO2 backstop costs
3772  *       (allocated proportionally to zonal demand at country/system level)
3773  *   - Excess generation
3774  *   - VRE curtailment
3775  *   - Import/export costs (external and internal zones)
3776  *   - Trade shared benefits
3777  *   - Carbon costs (system-wide total)
3778  * ---------------------------------------------------------
3779   
3780  * Investment-related costs
3781  pYearlyCostsZone(z, "Generation costs: $m", y) =
3782    vAnnCapex.l(z, y) / 1e6;
3783   
3784  pYearlyCostsZone(z, "Transmission costs: $m", y) =
3785    vAnnualizedTransmissionCapex.l(z, y) / 1e6;
3786   
3787  * Operation-related costs
3788  pYearlyCostsZone(z, "Fixed O&M: $m", y) =
3789    vYearlyFOMCost.l(z, y) / 1e6;
3790   
3791  pYearlyCostsZone(z, "Variable O&M: $m", y) =
3792    vYearlyVOMCost.l(z, y) / 1e6;
3793   
3794  pYearlyCostsZone(z, "Startup costs: $m", y) =
3795    vYearlyStartupCost.l(z, y) / 1e6;
3796   
3797  pYearlyCostsZone(z, "Fuel costs: $m", y) =
3798    vYearlyFuelCost.l(z, y) / 1e6;
3799   
3800  * System balancing costs
3801  pYearlyCostsZone(z, "Unmet demand costs: $m", y) =
3802    vYearlyUSECost.l(z, y) / 1e6;
3803   
3804  pYearlyCostsZone(z, "Excess generation: $m", y) =
3805    vYearlySurplus.l(z, y) / 1e6;
3806   
3807  pYearlyCostsZone(z, "VRE curtailment: $m", y) =
3808    vYearlyCurtailmentCost.l(z, y) / 1e6;
3809   
3810  * Reserve-related costs
3811  pYearlyCostsZone(z, "Spinning reserve costs: $m", y) =
3812    vYearlySpinningReserveCost.l(z, y) / 1e6;
3813   
3814  pYearlyCostsZone(z, "Unmet country spinning reserve costs: $m", y) =
3815    sum(c$(zcmap(z, c) and pDemandEnergyCountry(c, y) > 0),
3816      vYearlyUnmetSpinningReserveCostCountry.l(c, y) * (pDemandEnergyZone(z, y) / pDemandEnergyCountry(c, y))
3817    ) / 1e6;
3818   
3819  pYearlyCostsZone(z, "Unmet country planning reserve costs: $m", y) =
3820    sum(c$(zcmap(z, c) and pDemandEnergyCountry(c, y) > 0),
3821      vYearlyUnmetPlanningReserveCostCountry.l(c, y) * (pDemandEnergyZone(z, y) / pDemandEnergyCountry(c, y))
3822    ) / 1e6;
3823   
3824  pYearlyCostsZone(z, "Unmet system planning reserve costs: $m", y) =
3825    vYearlyUnmetPlanningReserveCostSystem.l(y) * (pDemandEnergyZone(z, y) / pDemandEnergySystem(y)) / 1e6;
3826   
3827  pYearlyCostsZone(z, "Unmet system spinning reserve costs: $m", y) =
3828    vYearlyUnmetSpinningReserveCostSystem.l(y) * (pDemandEnergyZone(z, y) / pDemandEnergySystem(y)) / 1e6;
3829   
3830  * Carbon-related costs
3831  pYearlyCostsZone(z, "Carbon costs: $m", y) =
3832    vYearlyCarbonCost.l(z, y) / 1e6;
3833   
3834  pYearlyCostsZone(z, "Unmet country CO2 backstop cost: $m", y) =
3835    sum(c$(zcmap(z, c) and pDemandEnergyCountry(c, y) > 0),
3836      vYearlyCO2BackstopCostCountry.l(c, y) * (pDemandEnergyZone(z, y) / pDemandEnergyCountry(c, y))
3837    ) / 1e6;
3838   
3839  pYearlyCostsZone(z, "Unmet system CO2 backstop cost: $m", y) =
3840    vYearlyCO2BackstopCostSystem.l(y) * (pDemandEnergyZone(z, y) / pDemandEnergySystem(y)) / 1e6;
3841   
3842  * Trade-related costs
3843  pYearlyCostsZone(z, "Import costs with internal zones: $m", y) =
3844    pImportCostsInternal(z, y) / 1e6;
3845   
3846  pYearlyCostsZone(z, "Export revenues with internal zones: $m", y) =
3847    pExportRevenuesInternal(z, y) / 1e6;
3848   
3849  pYearlyCostsZone(z, "Trade shared benefits: $m", y) =
3850    pTradeSharedBenefits(z, y) / 1e6;
3851   
3852  pYearlyCostsZone(z, "Import costs with external zones: $m", y) =
3853    vYearlyImportExternalCost.l(z, y) / 1e6;
3854   
3855  pYearlyCostsZone(z, "Export revenues with external zones: $m", y) =
3856    vYearlyExportExternalCost.l(z, y) / 1e6;
3857   
3858  * Discounted weighted yearly costs by zone
3859  pYearlyDiscountedWeightedCostsZone(z, sumhdr, y) =
3860      pYearlyCostsZone(z, sumhdr, y) * pRR(y) * pWeightYear(y);
3861   
3862  * Cost
3863  pCostsZone(z, sumhdr) =
3864      sum(y, pYearlyDiscountedWeightedCostsZone(z, sumhdr, y));
3865   
3866  * ---------------------------------------------------------
3867   
3868  * Cost by country and year
3869  pYearlyCostsCountry(c,sumhdr,y) = sum(z$(zcmap(z,c)), pYearlyCostsZone(z,sumhdr,y));
3870   
3871  * ---------------------------------------------------------
3872  * System-level cost summary
3873  * ---------------------------------------------------------
3874  * Aggregates all zone-level costs into a single system-wide
3875  * metric across the entire time horizon.
3876  *
3877  * - pCostsSystem(sumhdr):
3878  *     Weighted sum of all zone-level costs
3879  *     Units: million $ (after scaling)
3880  *
3881  * - "NPV of system cost: $m":
3882  *     The model's computed Net Present Value of system costs
3883  *     Directly taken from optimization variable vNPVCost
3884  * ---------------------------------------------------------
3885   
3886  pYearlyCostsSystem(sumhdr, y) = sum(z, pYearlyCostsZone(z, sumhdr, y));
3887   
3888  * pCostsSystem(sumhdr) = sum((y,z), pYearlyCostsZone(z,sumhdr,y) * pRR(y) * pWeightYear(y));
3889  pCostsSystem(sumhdr) = sum(z, pCostsZone(z,sumhdr));
3890   
3891  pCostsSystem("NPV of system cost: $m") = vNPVCost.l/1e6;
3892   
3893  * ---------------------------------------------------------
3894   
3895  * Annual average cost benchmarks ($/MWh) without discounting:
3896  * divide yearly costs by the matching energy basis.
3897  pYearlyCostsZonePerMWh(z,sumhdr,y) =
3898      pYearlyCostsZone(z,sumhdr,y)*1e6 / (pDemandEnergyZone(z,y) * 1e3);
3899   
3900  pYearlyCostsCountryPerMWh(c,sumhdr,y) =
3901      1e6 * pYearlyCostsCountry(c,sumhdr,y) / (pDemandEnergyCountry(c,y) * 1e3);
3902   
3903  pYearlyCostsSystemPerMWh(sumhdr,y) =
3904      1e6 * pYearlyCostsSystem(sumhdr, y) / (pDemandEnergySystem(y) * 1e3);
3905   
3906  * Discount zonal demand over the horizon; convert GWh -> MWh via 1e3
3907  * and apply both the discount rate (pRR) and scenario weight (pWeightYear).
3908  pDiscountedDemandZoneMWh(z) =
3909      sum(y, pDemandEnergyZone(z,y) * 1e3 * pRR(y) * pWeightYear(y));
3910   
3911  pDiscountedDemandCountryMWh(c) =
3912      sum(zcmap(z,c), pDiscountedDemandZoneMWh(z));
3913   
3914  pDiscountedDemandSystemMWh =
3915      sum(z, pDiscountedDemandZoneMWh(z));
3916   
3917  * Divide the discounted cost ledger by discounted demand to express
3918  * each zonal cost component as an average $/MWh metric.
3919  pCostsZonePerMWh(z,sumhdr)$pDiscountedDemandZoneMWh(z) =
3920      pCostsZone(z,sumhdr) * 1e6 / pDiscountedDemandZoneMWh(z);
3921   
3922  * Country totals reuse the zonal discounted costs and demands,
3923  * aggregating before taking the ratio so shared demand weights apply.
3924  pCostsCountryPerMWh(c,sumhdr)$pDiscountedDemandCountryMWh(c) =
3925      1e6 * sum(zcmap(z,c), pCostsZone(z,sumhdr)) / pDiscountedDemandCountryMWh(c);
3926   
3927  * System-wide average cost: sum of discounted zonal costs divided by
3928  * the discounted system demand (sum of zonal denominators).
3929  pCostsSystemPerMWh(sumhdr)$pDiscountedDemandSystemMWh =
3930      (pCostsSystem(sumhdr) * 1e6) / pDiscountedDemandSystemMWh;
3931   
3932  * ---------------------------------------------------------
3933  * Fuel costs and consumption [$m, PJ] by zone and country
3934  * ---------------------------------------------------------
3935  * Calculates annual fuel expenditures and consumption
3936  * based on generation output, heat rates, and fuel prices.
3937  * Results are stored at both zonal and country aggregation levels.
3938  * ---------------------------------------------------------
3939   
3940  pFuelCosts(z,f,y) = sum((gzmap(g,z),gfmap(g,f),zcmap(z,c),q,d,t), vPwrOut.l(g,f,q,d,t,y)*pHours(q,d,t)*pFuelPrice(c,f,y)*pHeatRate(g,f))/1e6;
3941  pFuelConsumption(z,f,y) = vFuel.l(z,f,y)/1e6;
3942   
3943  pFuelCostsCountry(c,f,y) = sum(zcmap(z,c), pFuelCosts(z,f,y));
3944  pFuelConsumptionCountry(c,f,y) = sum(zcmap(z,c), pFuelConsumption(z,f,y));
3945   
3946  * ============================================================
3947  * 3. ENERGY BALANCE
3948  * ============================================================
3949   
3950  * ---------------------------------------------------------
3951  * Energy generation by plant, technology-fuel, and country
3952  * ---------------------------------------------------------
3953  * Calculates annual electricity generation (TWh) from model
3954  * outputs at different aggregation levels:
3955  *   - pEnergyPlant: plant-level generation
3956  *   - pEnergyTechFuel / pEnergyTechFuelCountry: by technology and fuel, zonal and country
3957  *   - pEnergyTechFuelComplete: tech-fuel generation plus balance components
3958  *   - pEnergyFuel / pEnergyFuelCountry: by fuel, zonal and country
3959  * ---------------------------------------------------------
3960   
3961  pEnergyPlant(zgmap(z,g),y) = sum((gfmap(g,f),q,d,t), vPwrOut.l(g,f,q,d,t,y)*pHours(q,d,t))/1e3;
3962  pEnergyFuel(z,f,y) = sum((gzmap(g,z),gfmap(g,f),q,d,t), vPwrOut.l(g,f,q,d,t,y)*pHours(q,d,t))/1e3;
3963  pEnergyFuelCountry(c,f,y) = sum(zcmap(z,c), pEnergyFuel(z,f,y));
3964   
3965  * Energy balance including demand slack, surplus, and exchanges
3966  pEnergyFuelComplete(z,f,y) = pEnergyFuel(z,f,y);
3967  pEnergyFuelComplete(z,"UnmetDemand",y) = sum((q,d,t), vUSE.l(z,q,d,t,y)*pHours(q,d,t))/1e3;
3968  pEnergyFuelComplete(z,"Surplus",y) = sum((q,d,t), vSurplus.l(z,q,d,t,y)*pHours(q,d,t))/1e3;
3969  pEnergyFuelComplete(z,"Imports",y) = sum((sTopology(Zd,z),q,d,t), vFlow.l(Zd,z,q,d,t,y)*pHours(q,d,t))/1e3;
3970  pEnergyFuelComplete(z,"Exports",y) = -sum((sTopology(z,Zd),q,d,t), vFlow.l(z,Zd,q,d,t,y)*pHours(q,d,t))/1e3;
3971   
3972  pEnergyTechFuel(z,tech,f,y) = sum((gzmap(g,z),gtechmap(g,tech),gfmap(g,f),q,d,t), vPwrOut.l(g,f,q,d,t,y)*pHours(q,d,t))/1e3;
3973  pEnergyTechFuelCountry(c,tech,f,y) = sum(zcmap(z,c), pEnergyTechFuel(z,tech,f,y));
3974  * Copy slack components under synthetic technology "EnergyBalance"
3975  pEnergyTechFuelComplete(z,tech,f,y) = pEnergyTechFuel(z,tech,f,y);
3976  pEnergyTechFuelComplete(z,"EnergyBalance",fEnergyBalance,y) = pEnergyFuelComplete(z,fEnergyBalance,y);
3977   
3978   
3979  * ---------------------------------------------------------
3980  * Utilization factors by plant, technology, fuel, and country
3981  * ---------------------------------------------------------
3982  * Computes average utilization (capacity factor) as the ratio
3983  * of generated energy to available capacity and hours:
3984  *   - pUtilizationPlant / pUtilizationTech: plant-level
3985  *     and tech-level capacity factors
3986  *   - pUtilizationFuel / pUtilizationTechFuel: by fuel and tech-fuel at zone level
3987  *   - pUtilizationFuelCountry / pUtilizationTechFuelCountry:
3988  *     by fuel and tech-fuel at country level
3989  * ---------------------------------------------------------
3990   
3991   
3992  * Plant-level utilization (capacity factor, annual average)
3993  pUtilizationPlant(zgmap(z,g),y)$vCap.l(g,y) =
3994    sum((gfmap(g,f), q, d, t), vPwrOut.l(g,f,q,d,t,y) * pHours(q,d,t))
3995    / vCap.l(g,y) / 8760;
3996   
3997  * Technology-level utilization (capacity factor, annual average)
3998  pUtilizationTech(z, tech, y)$sum((zgmap(z,g), gfmap(g,f), gtechmap(g,tech))$vCap.l(g,y), vCap.l(g,y)) =
3999    sum((zgmap(z,g), gfmap(g,f), gtechmap(g,tech), q, d, t)$vCap.l(g,y),
4000      vPwrOut.l(g,f,q,d,t,y) * pHours(q,d,t))
4001    / sum((zgmap(z,g), gfmap(g,f), gtechmap(g,tech))$vCap.l(g,y), vCap.l(g,y))
4002    / 8760;
4003   
4004  * Fuel-level utilization (capacity factor, annual average)
4005  pUtilizationFuel(z, f, y)$(pCapacityFuel(z, f, y)) =
4006    pEnergyFuel(z, f, y)
4007    / (pCapacityFuel(z, f, y) * sum((q, d, t), pHours(q, d, t)))
4008    * 1000;
4009   
4010  * Technology-fuel-level utilization (capacity factor, annual average)
4011  pUtilizationTechFuel(z, tech, f, y)$(pCapacityTechFuel(z, tech, f, y)) =
4012    pEnergyTechFuel(z, tech, f, y)
4013    / (pCapacityTechFuel(z, tech, f, y) * sum((q, d, t), pHours(q, d, t)))
4014    * 1000;
4015   
4016  * Country-level fuel utilization (capacity factor, annual average)
4017  pUtilizationFuelCountry(c, f, y)$(pCapacityFuelCountry(c, f, y)) =
4018    pEnergyFuelCountry(c, f, y)
4019    / (pCapacityFuelCountry(c, f, y) * sum((q, d, t), pHours(q, d, t)))
4020    * 1000;
4021   
4022  * Country-level technology-fuel utilization (capacity factor, annual average)
4023  pUtilizationTechFuelCountry(c, tech, f, y)$(pCapacityTechFuelCountry(c, tech, f, y)) =
4024    pEnergyTechFuelCountry(c, tech, f, y)
4025    / (pCapacityTechFuelCountry(c, tech, f, y) * sum((q, d, t), pHours(q, d, t)))
4026    * 1000;
4027   
4028   
4029  * ---------------------------------------------------------
4030  * Energy balance [GWh] by zone and country
4031  * ---------------------------------------------------------
4032  * Accounts for demand (electricity and H2), production,
4033  * unmet demand, surplus generation, imports/exports,
4034  * and net interchange, with aggregation to country level.
4035  * ---------------------------------------------------------
4036   
4037  pEnergyBalance(z, "Demand: GWh", y) =
4038    sum((q, d, t), pDemandData(z, q, d, y, t) * pHours(q, d, t) * pEnergyEfficiencyFactor(z, y)) / 1e3;
4039   
4040  pEnergyBalance(z, "Demand H2: GWh", y) =
4041    (sum((h2zmap(hh, z), q, d, t), vH2PwrIn.l(hh, q, d, t, y) * pHours(q, d, t)) / 1e3) $ (fEnableH2Production + 1e-6);
4042   
4043  pEnergyBalance(z, "Total Demand: GWh", y) =
4044    pEnergyBalance(z, "Demand: GWh", y) + pEnergyBalance(z, "Demand H2: GWh", y);
4045   
4046  pEnergyBalance(z, "Total production: GWh", y) =
4047    sum(gzmap(g, z), pEnergyPlant(z, g, y));
4048   
4049  pEnergyBalance(z, "Unmet demand: GWh", y) =
4050    sum((q, d, t), vUSE.l(z, q, d, t, y) * pHours(q, d, t)) / 1e3;
4051   
4052  pEnergyBalance(z, "Surplus generation: GWh", y) =
4053    sum((q, d, t), vSurplus.l(z, q, d, t, y) * pHours(q, d, t)) / 1e3;
4054   
4055  pEnergyBalance(z, "Imports exchange: GWh", y) =
4056    (sum((sTopology(z, z2), q, d, t), vFlow.l(z2, z, q, d, t, y) * pHours(q, d, t))
4057     + sum((zext, q, d, t), vYearlyImportExternal.l(z, zext, q, d, t, y) * pHours(q, d, t))) / 1e3;
4058   
4059  pEnergyBalance(z, "Exports exchange: GWh", y) =
4060    (sum((sTopology(z, z2), q, d, t), vFlow.l(z, z2, q, d, t, y) * pHours(q, d, t))
4061     + sum((zext, q, d, t), vYearlyExportExternal.l(z, zext, q, d, t, y) * pHours(q, d, t))) / 1e3;
4062   
4063  pEnergyBalance(z, "Net interchange: GWh", y) =
4064    pEnergyBalance(z, "Imports exchange: GWh", y) - pEnergyBalance(z, "Exports exchange: GWh", y);
4065   
4066  pEnergyBalance(z, "Net interchange Ratio: GWh", y) $ pEnergyBalance(z, "Demand: GWh", y) =
4067    pEnergyBalance(z, "Net interchange: GWh", y) / pEnergyBalance(z, "Demand: GWh", y);
4068   
4069  pEnergyBalanceCountry(c,dshdr,y) = sum(z$(zcmap(z,c)), pEnergyBalance(z,dshdr,y));
4070   
4071   
4072  *--- H2 Demand-Supply Balance
4073  pEnergyBalanceH2(z,"Demand H2: GWh",y)   =(sum( (h2zmap(hh,z), q,d,t), vH2PwrIn.l(hh,q,d,t,y)*pHours(q,d,t))/1000)$fEnableH2Production+1e-6;
4074  pEnergyBalanceH2(z,"Production H2: mmBTU",           y)        =sum( (h2zmap(hh,z), q,d,t), vH2PwrIn.l(hh,q,d,t,y)*pHours(q,d,t)*pH2Data(hh,"HeatRate"))$fEnableH2Production+1e-6;
4075  pEnergyBalanceH2(z,"External Demand H2: mmBTU",         y)        =sum(q,pExternalH2(z,q,y)       )$fEnableH2Production+1e-6;
4076  pEnergyBalanceH2(z,"Unmet External Demand H2: mmBTU",   y)        =sum(q,vUnmetExternalH2.l(z,q,y))$fEnableH2Production+1e-6;
4077  pEnergyBalanceH2(z,"H2 Power: mmBTU",       y)        =sum(q,vFuelH2Quarter.l(z,q,y)  )$fEnableH2Production+1e-6;
4078   
4079  pEnergyBalanceCountryH2(c,dsH2hdr,y) = sum(z$(zcmap(z,c)), pEnergyBalanceH2(z,dsH2hdr,y));
4080   
4081  * ============================================================
4082  * 4. ENERGY DISPATCH
4083  * ============================================================
4084   
4085  * ---------------------------------------------------------
4086  * Hourly dispatch reporting: plant, fuel, and zone level
4087  * ---------------------------------------------------------
4088  * - pDispatchPlant: plant-level hourly generation and reserve [MW]
4089  * - pDispatchFuel: fuel-level hourly generation [MW]
4090  * - pDispatch: zone-level hourly imports, exports, unmet demand, storage charge, and demand [MW]
4091  * ---------------------------------------------------------
4092   
4093  pDispatchPlant(z, y, q, d, g, t, "Generation")$zgmap(z, g) = sum(gfmap(g, f), vPwrOut.l(g, f, q, d, t, y));
4094  pDispatchPlant(z, y, q, d, g, t, "Reserve")$zgmap(z, g) = vSpinningReserve.l(g, q, d, t, y);
4095   
4096  pDispatchFuel(z, y, q, d, f, t) = sum((gzmap(g, z), gfmap(g, f)), vPwrOut.l(g, f, q, d, t, y));
4097  pDispatchTechFuel(z, y, q, d, tech, f, t) =
4098    sum((gzmap(g, z), gtechmap(g, tech), gfmap(g, f)), vPwrOut.l(g, f, q, d, t, y));
4099   
4100  pDispatch(z, y, q, d, "Imports", t) = sum(sTopology(z, z2), vFlow.l(z2, z, q, d, t, y)) + sum(zext, vYearlyImportExternal.l(z, zext, q, d, t, y));
4101  pDispatch(z, y, q, d, "Exports", t) = -sum(sTopology(z, z2), vFlow.l(z, z2, q, d, t, y)) - sum(zext, vYearlyExportExternal.l(z, zext, q, d, t, y));
4102  pDispatch(z, y, q, d, "Unmet demand", t) = vUSE.l(z, q, d, t, y);
4103  pDispatch(z, y, q, d, "Storage Charge", t) = -sum(zgmap(z, st), vStorInj.l(st, q, d, t, y));
4104  pDispatch(z, y, q, d, "Demand", t) = pDemandData(z, q, d, y, t) * pEnergyEfficiencyFactor(z, y);
4105   
4106  * ============================================================
4107  * 5. RESERVES
4108  * ============================================================
4109   
4110  * ---------------------------------------------------------
4111  * Spinning reserve and reserve margin reporting
4112  * ---------------------------------------------------------
4113  * - pReserveSpinningPlantZone: annual spinning reserve provided by plant and zone [GWh]
4114  * - pReserveSpinningFuelZone: annual spinning reserve provided by fuel and zone [GWh]
4115  * - pReserveSpinningPlantCountry: annual spinning reserve provided by plant and country [GWh]
4116  * - pReserveMargin / pReserveMarginCountry: peak demand, total firm capacity, and reserve margin by zone/country
4117  * ---------------------------------------------------------
4118   
4119  pReserveSpinningPlantZone(zgmap(z,g),y) = sum((q,d,t), vSpinningReserve.l(g,q,d,t,y)*pHours(q,d,t))/1e3 ;
4120  pReserveSpinningFuelZone(z,f,y) = sum((gzmap(g,z),gfmap(g,f),q,d,t), vSpinningReserve.l(g,q,d,t,y)*pHours(q,d,t))/1e3 ;
4121  pReserveSpinningTechFuelZone(z,tech,f,y) =
4122    sum((gzmap(g,z),gtechmap(g,tech),gfmap(g,f),q,d,t), vSpinningReserve.l(g,q,d,t,y)*pHours(q,d,t))/1e3 ;
4123  pReserveSpinningPlantCountry(c,g,y)=  sum((zcmap(z,c),zgmap(z,g)), pReserveSpinningPlantZone(z,g,y));
4124  pReserveSpinningTechFuelCountry(c,tech,f,y) =
4125    sum(zcmap(z,c), pReserveSpinningTechFuelZone(z,tech,f,y));
4126   
4127  pReserveMargin(z,"Peak demand: MW",y) = smax((q,d,t), pDemandData(z,q,d,y,t)*pEnergyEfficiencyFactor(z,y));
4128  pReserveMargin(z,"TotalFirmCapacity",y) = sum(zgmap(z,g), pCapacityCredit(g,y)* vCap.l(g,y));
4129  pReserveMargin(z,"ReserveMargin",y)$(pReserveMargin(z,"TotalFirmCapacity",y)) = pReserveMargin(z,"TotalFirmCapacity",y)/pReserveMargin(z,"Peak demand: MW",y)  ;
4130   
4131  pReserveMarginCountry(c,"Peak demand: MW",y) =   pCapacitySummaryCountry(c,"Peak demand: MW"       ,y);
4132  pReserveMarginCountry(c,"TotalFirmCapacity",y) = sum(zcmap(z,c), pReserveMargin(z,"TotalFirmCapacity",y));
4133  pReserveMarginCountry(c,"ReserveMargin",y)$(pReserveMarginCountry(c,"TotalFirmCapacity",y)) = pReserveMarginCountry(c,"TotalFirmCapacity",y)/ pReserveMarginCountry(c,"Peak demand: MW",y)  ;
4134   
4135  * ============================================================
4136  * 6. INTERCONNECTIONS
4137  * ============================================================
4138   
4139  * ---------------------------------------------------------
4140  * Internal zones: interchange, utilization, losses, congestion
4141  * ---------------------------------------------------------
4142  * - pInterchange / pInterchangeCountry: net interchange flow [GWh]
4143  * - pInterconUtilization: utilization of transfer capacity [%]
4144  * - pLossesTransmission / pLossesTransmissionCountry: transmission losses [GWh]
4145  * - isCongested / pCongestionShare: binary indicator and share of time congested
4146  * ---------------------------------------------------------
4147   
4148  * Annual interchange between internal zones [GWh]
4149  pInterchange(sTopology(z, z2), y) =
4150    sum((q, d, t), vFlow.l(z, z2, q, d, t, y) * pHours(q, d, t)) / 1e3;
4151   
4152  * Utilization of interconnection throughout modeling horizon [%]
4153  pInterconUtilization(sTopology(z, z2), y)$pInterchange(z, z2, y) =
4154    1e3 * pInterchange(z, z2, y)
4155    / sum((q, d, t),
4156      (pTransferLimit(z, z2, q, y)
4157       + vNewTransmissionLine.l(z, z2, y)
4158         * max(pNewTransmission(z, z2, "CapacityPerLine"),
4159           pNewTransmission(z2, z, "CapacityPerLine"))
4160         * fAllowTransferExpansion)
4161      * pHours(q, d, t)
4162      );
4163   
4164  * Transmission losses between internal zones in MWh per zone
4165  pLossesTransmission(z, y) =
4166    sum((sTopology(z, z2), q, d, t),
4167      vFlow.l(z2, z, q, d, t, y) * pLossFactorInternal(z, z2, y) * pHours(q, d, t)
4168    );
4169   
4170  * Country-level interchange and losses
4171  alias (zcmap, zcmap2);
4172   
4173  pInterchangeCountry(c, c2, y) =
4174    sum((zcmap(z, c), zcmap2(z2, c2), sMapConnectedZonesDiffCountries(z2, z)),
4175      pInterchange(z, z2, y)
4176    );
4177   
4178  pLossesTransmissionCountry(c, y) =
4179    sum(zcmap(z, c), pLossesTransmission(z, y));
4180   
4181  * Binary indicator for congestion per time step
4182  isCongested(z, z2, q, d, t, y)$(
4183    sTopology(z, z2)
4184    and abs(
4185      vFlow.l(z, z2, q, d, t, y)
4186      - (
4187        pTransferLimit(z, z2, q, y)
4188        + vNewTransmissionLine.l(z, z2, y)
4189          * max(pNewTransmission(z, z2, "CapacityPerLine"),
4190            pNewTransmission(z2, z, "CapacityPerLine"))
4191          * fAllowTransferExpansion
4192        )
4193      ) < 1e-5
4194  ) = 1;
4195   
4196  * Percentage of time (weighted by pHours) when the line is congested
4197  pCongestionShare(sTopology(z, z2), y) =
4198    sum((q, d, t), isCongested(z, z2, q, d, t, y) * pHours(q, d, t))
4199    / sum((q, d, t), pHours(q, d, t));
4200   
4201   
4202  * ---------------------------------------------------------
4203  * External zones: imports and exports
4204  * ---------------------------------------------------------
4205  * - pHourlyInterchangeExternal / pYearlyInterchangeExternal: hourly and annual imports/exports [GWh]
4206  * - pInterchangeExternalExports / pInterconUtilizationExternalExports: exports and line utilization [%]
4207  * - pInterchangeExternalImports / pInterconUtilizationExternalImports: imports and line utilization [%]
4208  * - pHourlyInterchangeExternalCountry / pYearlyInterchangeExternalCountry: aggregated country-level interchange [GWh]
4209  * ---------------------------------------------------------
4210   
4211  set thrd / Imports, Exports /;
4212   
4213  * Hourly interchange with external zones [MW]
4214  pHourlyInterchangeExternal(z, y, q, d, "Imports", t) =
4215    sum(zext, vYearlyImportExternal.l(z, zext, q, d, t, y));
4216   
4217  pHourlyInterchangeExternal(z, y, q, d, "Exports", t) =
4218    sum(zext, vYearlyExportExternal.l(z, zext, q, d, t, y));
4219   
4220  * Annual interchange with external zones [GWh]
4221  pYearlyInterchangeExternal(z, thrd, y) =
4222    sum((q, d, t), pHourlyInterchangeExternal(z, y, q, d, thrd, t) * pHours(q, d, t)) / 1e3;
4223   
4224  * Annual exports and imports with external zones [GWh]
4225  pInterchangeExternalExports(z, zext, y) =
4226    sum((q, d, t), vYearlyExportExternal.l(z, zext, q, d, t, y) * pHours(q, d, t)) / 1e3;
4227   
4228  pInterchangeExternalImports(zext, z, y) =
4229    sum((q, d, t), vYearlyImportExternal.l(z, zext, q, d, t, y) * pHours(q, d, t)) / 1e3;
4230   
4231  * Utilization of external interconnections [%]
4232  pInterconUtilizationExternalExports(z, zext, y)$pInterchangeExternalExports(z, zext, y) =
4233    1e3 * pInterchangeExternalExports(z, zext, y)
4234    / sum((q, d, t), pExtTransferLimitOut(z, zext, q, y) * pHours(q, d, t));
4235   
4236  pInterconUtilizationExternalImports(zext, z, y)$pInterchangeExternalImports(zext, z, y) =
4237    1e3 * pInterchangeExternalImports(zext, z, y)
4238    / sum((q, d, t), pExtTransferLimitIn(z, zext, q, y) * pHours(q, d, t));
4239   
4240  * Country-level hourly and annual interchange with external zones
4241  pHourlyInterchangeExternalCountry(c, y, q, d, thrd, t) =
4242    sum(zcmap(z, c), pHourlyInterchangeExternal(z, y, q, d, thrd, t));
4243   
4244  pYearlyInterchangeExternalCountry(c, thrd, y) =
4245    sum(zcmap(z, c), pYearlyInterchangeExternal(z, thrd, y));
4246   
4247  * ============================================================
4248  * 7. EMISSIONS
4249  * ============================================================
4250   
4251  * ---------------------------------------------------------
4252  * Emissions reporting: zone, country, and marginal costs
4253  * ---------------------------------------------------------
4254  * - pEmissionsZone: total CO2 emissions [Mt] by zone and year
4255  * - pEmissionsIntensityZone: CO2 intensity [tCO2/GWh] by zone and year
4256  * - pEmissionsCountrySummary: total and backstop CO2 emissions [Mt] by country and year
4257  * - pEmissionsIntensityCountry: CO2 intensity [tCO2/GWh] by country and year
4258  * - pEmissionMarginalCosts / pEmissionMarginalCostsCountry: marginal cost of emission constraints [USD/tCO2]
4259  * ---------------------------------------------------------
4260   
4261  pEmissionsZone(z,y)                                                     =  vZonalEmissions.l(z,y)/1e6 ;
4262  pEmissionsIntensityZone(z,y)$pEnergyBalance(z,"Total production: GWh",y) = 1e-3*pEmissionsZone(z,y)/pEnergyBalance(z,"Total production: GWh",y);
4263  pEmissionsCountrySummary(c,"Emissions: mm tCO2eq",y)                               = sum(zcmap(z,c), pEmissionsZone(z,y));
4264  pEmissionsCountrySummary(c,"CO2backstopEmissions: mm tCO2eq",y)                    = vYearlyCO2backstop.l(c,y)/1e6;
4265  pEmissionsIntensityCountry(c,y)$pEnergyBalanceCountry(c,"Total production: GWh",y) = 1e-3*sum(zcmap(z,c), vZonalEmissions.l(z,y))/pEnergyBalanceCountry(c,"Total production: GWh",y);
4266   
4267  pEmissionMarginalCosts(y) $(pWeightYear(y))                  = -eTotalEmissionsConstraint.M(y)/pRR(y)/pWeightYear(y);
4268  pEmissionMarginalCostsCountry(c,y) $(pWeightYear(y))         = -eEmissionsCountry.M(c,y)/pRR(y)/pWeightYear(y);
4269   
4270  * ============================================================
4271  * 8. PRICES
4272  * ============================================================
4273  * ---------------------------------------------------------
4274  * Average yearly electricity prices at zone and country level
4275  * ---------------------------------------------------------
4276  * Calculates demand-weighted consumer prices, export/import
4277  * prices weighted by actual flows (internal & external),
4278  * and hub prices. Aggregates results to country averages
4279  * using zonal weights and interconnection flows.
4280  * ---------------------------------------------------------
4281   
4282  * Average yearly price paid by consumers, weighted by demand
4283  pYearlyPrice(z,y)$pEnergyBalance(z,"Demand: GWh",y) = 1e-3*sum((q,d,t),pPrice(z,q,d,t,y)*pDemandData(z,q,d,y,t)*pHours(q,d,t)*pEnergyEfficiencyFactor(z,y))
4284                                                       /pEnergyBalance(z,"Demand: GWh",y) ;
4285   
4286  Parameter
4287    pFlowMWSum(z,z2,y)    "Sum of hourly MW flows over the year (used for weights)"
4288    pFlowMWh(z,z2,y)      "Annual energy flow between zones [MWh]"
4289  ;
4290   
4291  pFlowMWSum(z,z2,y) = sum(sFlow(z,z2,q,d,t,y),vFlow.l(z,z2,q,d,t,y));
4292  pFlowMWh(z,z2,y) = sum(sFlow(z,z2,q,d,t,y),vFlow.l(z,z2,q,d,t,y)*pHours(q,d,t));
4293   
4294  * Average price of exports and imports, weighted by actual flows on the lines
4295  pYearlyPriceExport(z,y) $(sum(Zd, pFlowMWh(z,Zd,y))  > 0) = (sum((sTopology(z,Zd),q,d,t),  pPrice(z,q,d,t,y) *vFlow.l(z,Zd,q,d,t,y)*pHours(q,d,t))
4296                                                             + sum((zext,q,d,t), vYearlyExportExternal.l(z,zext,q,d,t,y) * pTradePrice(zext,q,d,y,t) * pHours(q,d,t)))
4297                                                           /(sum(Zd, pFlowMWh(z,Zd,y))+ sum((zext,q,d,t), vYearlyExportExternal.l(z,zext,q,d,t,y)* pHours(q,d,t)));
4298   
4299  pYearlyPriceImport(z,y) $(sum(Zd, pFlowMWh(Zd,z,y))  > 0) = (sum((sTopology(Zd,z),q,d,t),  pPrice(Zd,q,d,t,y)*vFlow.l(Zd,z,q,d,t,y)*pHours(q,d,t))
4300                                                              + sum((zext,q,d,t), vYearlyImportExternal.l(z,zext,q,d,t,y) * pTradePrice(zext,q,d,y,t) * pHours(q,d,t)))
4301                                                           /(sum(Zd, pFlowMWh(Zd,z,y))+ sum((zext,q,d,t), vYearlyImportExternal.l(z,zext,q,d,t,y)  * pHours(q,d,t)));
4302   
4303  * Average price at the hub, weighted by actual flows on the lines (TODO: check not with pHours)
4304  pYearlyPriceHub(Zt,y)$(sum(Zd, pFlowMWSum(Zt,Zd,y))   > 0) = sum((sTopology(Zt,Zd),q,d,t), pPrice(Zt,q,d,t,y)*vFlow.l(Zt,Zd,q,d,t,y))
4305                                                           /sum(Zd, pFlowMWSum(Zt,Zd,y));
4306   
4307  * Average yearly price paid by consumers, weighted by demand
4308  pYearlyPriceCountry(c,y)$pEnergyBalanceCountry(c,"Demand: GWh",y) = sum(zcmap(z,c), pYearlyPrice(z,y)*pEnergyBalance(z,"Demand: GWh",y))/pEnergyBalanceCountry(c,"Demand: GWh",y);
4309   
4310  * ---------------------------------------------------------
4311  * Country-level interconnection energy flows [MWh]
4312  * ---------------------------------------------------------
4313  * Aggregated annual energy exchanged between a country and its
4314  * neighboring countries, used as weights to compute average
4315  * export and import prices:
4316  *   - pCountryExportFlowMWh: total export energy from country c
4317  *   - pCountryImportFlowMWh: total import energy into country c
4318  * ---------------------------------------------------------
4319   
4320  Parameter
4321      pCountryExportFlowMWh(c,y) "Annual exported energy [MWh] from country c"
4322      pCountryImportFlowMWh(c,y) "Annual imported energy [MWh] into country c";
4323   
4324  pCountryExportFlowMWh(c,y) = sum((zcmap(z,c), sMapConnectedZonesDiffCountries(z,Zd)), pFlowMWh(z,Zd,y));
4325   
4326  pYearlyPriceExportCountry(c,y)$(pCountryExportFlowMWh(c,y) > 0) =
4327      sum((zcmap(z,c), sMapConnectedZonesDiffCountries(z,Zd),q,d,t),
4328          pPrice(z,q,d,t,y)*vFlow.l(z,Zd,q,d,t,y)*pHours(q,d,t))
4329      / pCountryExportFlowMWh(c,y);
4330   
4331  pCountryImportFlowMWh(c,y) = sum((zcmap(z,c), sMapConnectedZonesDiffCountries(Zd,z)), pFlowMWh(Zd,z,y));
4332   
4333  pYearlyPriceImportCountry(c,y)$(pCountryImportFlowMWh(c,y) > 0) =
4334      sum((zcmap(z,c), sMapConnectedZonesDiffCountries(Zd,z),q,d,t),
4335          pPrice(Zd,q,d,t,y)*vFlow.l(Zd,z,q,d,t,y)*pHours(q,d,t))
4336      / pCountryImportFlowMWh(c,y);
4337   
4338   
4339   
4340  * ============================================================
4341  * 9. SPECIAL TECHNOLOGIES
4342  * ============================================================
4343  * ---------------------------------------------------------
4344  * CSP, PV+Storage, and Generic Storage balances and components
4345  * ---------------------------------------------------------
4346  * Tracks technology-specific balances and installed components:
4347  *   - pCSPBalance: thermal, storage input/output, and power output by CSP
4348  *   - pCSPComponents: thermal field, storage, power block, solar multiple, storage hours
4349  *   - pPVwSTOBalance: PV output, storage input/output, storage losses and levels for PV+storage systems
4350  *   - pPVwSTOComponents: PV capacity, storage MW/MWh, storage hours
4351  *   - pStorageBalance: input, output, losses, net change, and storage level for generic storage
4352  *   - pStorageComponents: installed MW, MWh, and storage hours
4353  * ---------------------------------------------------------
4354   
4355  pCSPBalance(y, g,q,d,"Thermal output",t) = vThermalOut.l(g,q,d,t,y);
4356  pCSPBalance(y,cs,q,d,"Storage Input" ,t) = vStorInj.l(cs,q,d,t,y);
4357  pCSPBalance(y,cs,q,d,"Storage Output",t) = vStorOut.l(cs,q,d,t,y);
4358  pCSPBalance(y,cs,q,d,"Power Output"  ,t) = sum(gfmap(cs,f), vPwrOut.l(cs,f,q,d,t,y));
4359   
4360  pCSPComponents(g, "Thermal Field: WM" ,y) = vCapTherm.l(g,y);
4361  pCSPComponents(cs,"Storage: MWh"      ,y) = vCapStor.l(cs,y);
4362  pCSPComponents(cs,"Power Block: MW"   ,y) = vCap.l(cs,y);
4363  pCSPComponents(g, "Solar Multiple"    ,y) = vCapTherm.l(g,y)/max(vCap.l(g,y),1);
4364  pCSPComponents(cs,"Storage Hours: hrs",y) = vCapStor.l(cs,y)/max(vCap.l(cs,y),1);
4365   
4366  pPVwSTOBalance(y,q,d,so, "PV output"     ,t) = sum(gfmap(so,f), vPwrOut.l(so,f,q,d,t,y));
4367  pPVwSTOBalance(y,q,d,stp,"Storage Input" ,t) = vStorInj.l(stp,q,d,t,y);
4368  pPVwSTOBalance(y,q,d,stp,"Storage output",t) = sum(gfmap(stp,f), vPwrOut.l(stp,f,q,d,t,y));
4369  pPVwSTOBalance(y,q,d,stp,"Storage Losses",t) = (1-pStorageData(stp,"Efficiency"))*vStorInj.l(stp,q,d,t,y);
4370  pPVwSTOBalance(y,q,d,stp,"Storage level" ,t) = vStorage.l(stp,q,d,t,y);
4371   
4372  pPVwSTOComponents(so, "PV Plants"           ,y) = vCap.l(so,y);
4373  pPVwSTOComponents(stp,"Storage Capacity MW" ,y) = vCap.l(stp,y);
4374  pPVwSTOComponents(stp,"Storage Capacity MWh",y) = vCapStor.l(stp,y);
4375  pPVwSTOComponents(stp,"Storage Hours"       ,y) = vCapStor.l(stp,y)/max(vCap.l(stp,y),1);
4376   
4377  pStorageBalance(y,stg,q,d,"Storage Input"     ,t) = vStorInj.l(stg,q,d,t,y);
4378  pStorageBalance(y,stg,q,d,"Storage Output"    ,t) = sum(gfmap(stg,f), vPwrOut.l(stg,f,q,d,t,y));
4379  pStorageBalance(y,stg,q,d,"Storage Losses"    ,t) = (1-pStorageData(stg,"Efficiency"))*vStorInj.l(stg,q,d,t,y);
4380  pStorageBalance(y,stg,q,d,"Net Storage Change",t) = vStorNet.l(stg,q,d,t,y);
4381  pStorageBalance(y,stg,q,d,"Storage Level"     ,t) = vStorage.l(stg,q,d,t,y);
4382   
4383  pStorageComponents(stg,"Storage Capacity: MW",y) = vCap.l(stg,y);
4384  pStorageComponents(stg,"Storage Capacity: MWh"  ,y) = vCapStor.l(stg,y);
4385  pStorageComponents(stg,"Storage Hours"         ,y) = vCapStor.l(stg,y)/max(vCap.l(stg,y),1);
4386   
4387  * ---------------------------------------------------------
4388  * Zonal solar energy, value, and cost indicators
4389  * ---------------------------------------------------------
4390  * Computes solar power output, annual energy, market value,
4391  * and levelized cost of solar at the zonal level:
4392  *   - pSolarPower: hourly solar generation
4393  *   - pSolarEnergyZone: total annual solar energy (MWh)
4394  *   - pSolarValueZone: average market value of solar ($/MWh)
4395  *   - pSolarCost: levelized cost of solar based on Generation costs ($/MWh)
4396  * ---------------------------------------------------------
4397   
4398  set PVtech(tech) / PV, PVwSTO /;
4399  Parameter pSolarEnergyZone(z,y);
4400   
4401  pSolarPower(z,q,d,t,y) = sum((gzmap(g,z),gtechmap(g,PVtech),gfmap(g,f)), vPwrOut.l(g,f,q,d,t,y));
4402  pSolarEnergyZone(z,y) = sum((q,d,t), pSolarPower(z,q,d,t,y)*pHours(q,d,t));
4403  pSolarValueZone(z,y)$(pSolarEnergyZone(z,y) > 0) = sum((q,d,t), pPrice(z,q,d,t,y)*pSolarPower(z,q,d,t,y))/pSolarEnergyZone(z,y);
4404  pSolarCost(z,y)$(pSolarEnergyZone(z,y) > 0) = (sum((gzmap(ng,z),gtechmap(ng,PVtech)), pCRF(ng)*vCap.l(ng,y)*pGenData(ng,"Capex")*pCapexTrajectories(ng,y))*1e6)/pSolarEnergyZone(z,y);
4405   
4406   
4407  * ============================================================
4408  * 10. METRICS
4409  * ============================================================
4410   
4411  * ---------------------------------------------------------
4412  * LCOE by plant [$/MWh]
4413  * ---------------------------------------------------------
4414   
4415  Parameter
4416    pPlantEnergyMWh(z,g,y) "Annual energy production by plant [MWh]"
4417  ;
4418   
4419  * Plant-level energy denominator
4420  pPlantEnergyMWh(z,g,y)$pEnergyPlant(z,g,y) = pEnergyPlant(z,g,y)*1e3;
4421   
4422  * LCOE for new capacity plants (without direct spinning reserve cost)
4423  pPlantAnnualLCOE(z,g,y)$((pPlantEnergyMWh(z,g,y)) and (pPlantEnergyMWh(z,g,y) >= 1e3)) =
4424      1e6 * (
4425          pCostsPlant(z, g, "Generation costs: $m", y)
4426        + pCostsPlant(z, g, "Fixed O&M: $m", y)
4427        + pCostsPlant(z, g, "Variable Cost: $m", y)
4428  *      + pCostsPlant(z, g, "Spinning Reserve Cost: $m", y)
4429      ) / pPlantEnergyMWh(z,g,y);
4430   
4431   
4432  * Zone-level generation cost intensity by component [$/MWh]
4433  pYearlyGenCostZonePerMWh(z,genCostCmp,y)$sum(gzmap(g,z), pEnergyPlant(z,g,y)) =
4434      1e6 * sum(gzmap(g,z), pCostsPlant(z, g, genCostCmp, y))
4435      / (sum(gzmap(g,z), pEnergyPlant(z,g,y)) * 1e3);
4436   
4437   
4438  * ============================================================
4439  * 11. modeltype PARAMETERS
4440  * ============================================================
4441   
4442  pSolverParameters("modeltype Status")               = PA.modelstat + EPS;
4443  pSolverParameters("modeltype Time: ms")             = PA.etSolve + EPS;
4444  pSolverParameters("Absolute gap")                = PA.objVal-PA.objEst + EPS;
4445  pSolverParameters("Relative gap")$(PA.objVal >0) = pSolverParameters("Absolute gap")/PA.objVal + EPS;
4446   
4447  *--- END RESULTS
4448   
4449   
4451  * create output directory
4452   
4453  *$call /bin/sh -c "mkdir -p '%OUTPUT_DIR%'"
4454   
4455  embeddedCode Connect:
4456  - PythonCode:
4457      code: |
4458        import os
4459        os.makedirs(r"output_csv", exist_ok=True)
4460  endEmbeddedCode
4461   
4462   
4463  embeddedCode Connect:
4464  - PythonCode:
4465      code: |
4466        symbols = [
4467          "pGeneratorTechFuel",
4468          "pZoneCountry",
4469          "pDemandEnergyZone",
4470          "pDemandPeakZone",
4471          "pCapacityPlant",
4472          "pNewCapacityPlant",
4473          "pNewCapacityTechFuel",
4474          "pCapacityTechFuel",
4475          "pNewTransmissionCapacity",
4476          "pAnnualTransmissionCapacity",
4477   
4478          "pCostsPlant",
4479          "pCapexInvestmentComponent",
4480   
4481          "pPrice",
4482          "pYearlyCostsZone",
4483          "pYearlyDiscountedWeightedCostsZone",
4484          "pCostsSystem",
4485          "pCostsSystemPerMWh",
4486          "pFuelCosts",
4487          
4488          "pEnergyPlant",
4489          "pEnergyTechFuel",
4490          "pEnergyTechFuelComplete",
4491          "pEnergyBalance",
4492   
4493          "pUtilizationPlant",
4494          "pUtilizationTechFuel",
4495          "pReserveSpinningPlantZone",
4496          
4497          "pInterchange",
4498          "pInterconUtilization",
4499          "pCongestionShare",
4500          
4501          "pEmissionsZone",
4502          "pEmissionsIntensityZone",
4503   
4504          "pDispatchTechFuel",
4505          "pDispatch",
4506          
4507          "pPlantAnnualLCOE",
4508          "pYearlyGenCostZonePerMWh",
4509          "pCostsZonePerMWh",
4510          "pCostsCountryPerMWh",
4511          "pYearlyCostsZonePerMWh",
4512          "pYearlyCostsCountryPerMWh",
4513          "pSettings"
4514          ]
4515        instructions.append(
4516          {'GAMSReader': {'symbols': [{'name': s} for s in symbols]}}
4517        )
4518        for s in symbols:
4519          instructions.append(
4520          {
4521            'CSVWriter':
4522            {
4523              'file': fr'output_csv/{s}.csv',
4524              'name': s
4525            }
4526          })
4527  endEmbeddedCode
4528   
4529  * Additional outputs which can be included in epmresults according to the modelers' needs: pPVwSTOBalance,pPVwSTOComponents, pSolarValueZone, pSolarCost, pCapacityTechFuel, pUtilizationTech
4530   
4532  * Extensive reporting is used
4533      execute_unload 'epmresults',
4534        pSettings, pGeneratorTechFuel, pZoneCountry,
4535        pDemandEnergyZone, pDemandEnergyCountry, pDemandEnergySystem,
4536        pDemandPeakZone, pDemandPeakCountry, pDemandPeakSystem,
4537  * 1. CAPACITY
4538        pCapacityPlant, pNewCapacityPlant, pCapacityTechFuel, pCapacityFuel, pCapacityTechFuelCountry, pCapacityFuelCountry, pCapacityPlantH2,
4539        pRetirementsPlant, pRetirementsFuel, pRetirementsCountry, pRetirementsFuelCountry,
4540        pNewCapacityFuel, pNewCapacityTech, pNewCapacityTechFuel, pNewCapacityFuelCountry, pNewCapacityTechCountry, pNewCapacityTechFuelCountry,
4541        pAnnualTransmissionCapacity, pNewTransmissionCapacity,
4542        pCapacitySummary, pCapacitySummaryCountry,
4543  * 2. COSTS
4544        pCostsPlant,
4545        pCapexInvestment, pCapexInvestmentPlant, pCapexInvestmentTransmission, pCapexInvestmentComponent,
4546        pPrice, pImportCostsInternal, pExportRevenuesInternal, pCongestionRevenues, pTradeSharedBenefits,
4547        pYearlyCostsZone, pYearlyDiscountedWeightedCostsZone, pYearlyCostsCountry, pCostsZone, pCostsSystem, pCostsSystemPerMWh, pYearlyCostsSystem,
4548        pFuelCosts, pFuelCostsCountry, pFuelConsumption, pFuelConsumptionCountry,
4549  * 3. ENERGY BALANCE
4550        pEnergyPlant, pEnergyTechFuel, pEnergyTechFuelComplete, pEnergyFuel, pEnergyFuelComplete, pEnergyTechFuelCountry, pEnergyFuelCountry,
4551        pUtilizationPlant, pUtilizationTech, pUtilizationFuel, pUtilizationTechFuel, pUtilizationFuelCountry, pUtilizationTechFuelCountry,
4552        pEnergyBalance, pEnergyBalanceCountry, pEnergyBalanceH2, pEnergyBalanceCountryH2,
4553  * 4. ENERGY DISPATCH
4554        pDispatchPlant, pDispatchFuel, pDispatchTechFuel, pDispatch,
4555  * 5. RESERVES
4556        pReserveSpinningPlantZone, pReserveSpinningFuelZone, pReserveSpinningTechFuelZone, pReserveSpinningPlantCountry, pReserveSpinningTechFuelCountry,
4557        pReserveMargin, pReserveMarginCountry,
4558  * 5. INTERCONNECTIONS
4559        pInterchange, pInterconUtilization, pLossesTransmission, pInterchangeCountry, pLossesTransmissionCountry,
4560        pCongestionShare,
4561        pHourlyInterchangeExternal, pYearlyInterchangeExternal, pYearlyInterchangeExternalCountry, pHourlyInterchangeExternalCountry,
4562        pInterchangeExternalExports, pInterchangeExternalImports, pInterconUtilizationExternalExports, pInterconUtilizationExternalImports,
4563  * 6. EMISSIONS
4564        pEmissionsZone, pEmissionsIntensityZone, pEmissionsCountrySummary, pEmissionsIntensityCountry,
4565        pEmissionMarginalCosts, pEmissionMarginalCostsCountry,
4566  * 7. PRICES
4567        pYearlyPrice, pYearlyPriceExport, pYearlyPriceImport, pYearlyPriceHub,
4568        pYearlyPriceCountry, pYearlyPriceExportCountry, pYearlyPriceImportCountry,
4569  * 8. SPECIAL TECHNOLOGIES
4570        pCSPBalance, pCSPComponents, pPVwSTOBalance, pPVwSTOComponents, pStorageBalance, pStorageComponents,
4571        pSolarPower, pSolarEnergyZone, pSolarValueZone, pSolarCost,
4572  * 9. METRICS
4573        pPlantAnnualLCOE, pCostsZonePerMWh, pCostsCountryPerMWh,
4574        pYearlyGenCostZonePerMWh,
4575        pYearlyCostsZonePerMWh, pYearlyCostsCountryPerMWh, pYearlyCostsSystemPerMWh,
4576        pDiscountedDemandZoneMWh, pDiscountedDemandCountryMWh, pDiscountedDemandSystemMWh,
4577  * 10. modeltype PARAMETERS
4578        pSolverParameters,
4579  * 11. ADDITIONAL OUTPUTS
4580        pVarCost, pCapacityCredit
4581  ;
4583   
4584  * ---------------------------------------------------------
4585  * Post-process CSV files: rename columns, fill TechFuel combinations, and calculate cumulative values
4586  * Note: These treatments are for Tableau compatibility - warnings here are non-fatal
4587  * ---------------------------------------------------------
4588  embeddedCode Python:
4589  from output_treatment import run_output_treatment_gams
4590   
4591  output_dir = r"output_csv"
4592  run_output_treatment_gams(gams, output_dir)
4593   
4594  endEmbeddedCode
GAMS 48.6.1  67fbb04b Jan 23, 2025          LEX-LEG x86 64bit/Linux - 12/16/25 15:08:32 Page 2
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
Include File Summary


   SEQ   GLOBAL TYPE      PARENT   LOCAL  FILENAME

     1        1 INPUT          0       0  /Data/SAPP_2026/EPM/epm/main.gms
     2       66 CALL           1      66  rm -f cplex.opt
     3       67 CALL           1      67  cp "/Data/SAPP_2026/EPM/epm/input/data_sapp/cplex/cplex_baseline.opt" cplex.opt
     4      236 INCLUDE        1     246  ./Data/SAPP_2026/EPM/epm/input_readers.gms
     5      876 GDXIN          1     249  /Data/SAPP_2026/EPM/epm/output/simulations_run_20251216_150832/baseline/input.gdx
     6      972 INCLUDE        1     345  ./Data/SAPP_2026/EPM/epm/base.gms
     7     2256 INCLUDE        1     347  ./Data/SAPP_2026/EPM/epm/hydrogen_module.gms
     8     2575 INCLUDE        1     411  ./Data/SAPP_2026/EPM/epm/generate_demand.gms
     9     3128 INCLUDE        1     925  ./Data/SAPP_2026/EPM/epm/generate_report.gms


COMPILATION TIME     =        4.597 SECONDS      6 MB  48.6.1 67fbb04b LEX-LEG
GAMS 48.6.1  67fbb04b Jan 23, 2025          LEX-LEG x86 64bit/Linux - 12/16/25 15:08:32 Page 3
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
Range Statistics    SOLVE demand Using NLP From line 2646


RANGE STATISTICS (ABSOLUTE NON-ZERO FINITE VALUES)

RHS       [min, max] : [ 1.027E+04, 8.087E+06] - Zero values observed as well
Bound     [min, max] : [ 3.840E+02, 3.840E+02]
Matrix    [min, max] : [ 7.020E-03, 1.798E+02]

GAMS 48.6.1  67fbb04b Jan 23, 2025          LEX-LEG x86 64bit/Linux - 12/16/25 15:08:32 Page 4
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
Model Statistics    SOLVE demand Using NLP From line 2646


MODEL STATISTICS

BLOCKS OF EQUATIONS           3     SINGLE EQUATIONS       59,291
BLOCKS OF VARIABLES           3     SINGLE VARIABLES       59,291  154 projected
NON ZERO ELEMENTS       235,170     NON LINEAR N-Z         57,761
CODE LENGTH             462,088     CONSTANT POOL             258


GENERATION TIME      =        0.151 SECONDS     42 MB  48.6.1 67fbb04b LEX-LEG
GAMS 48.6.1  67fbb04b Jan 23, 2025          LEX-LEG x86 64bit/Linux - 12/16/25 15:08:32 Page 5
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
Solution Report     SOLVE demand Using NLP From line 2646


               S O L V E      S U M M A R Y

     MODEL   demand              OBJECTIVE  obj
     TYPE    NLP                 DIRECTION  MINIMIZE
     SOLVER  CONOPT4             FROM LINE  2646

**** SOLVER STATUS     1 Normal Completion
**** MODEL STATUS      2 Locally Optimal
**** OBJECTIVE VALUE          2788843.9330

 RESOURCE USAGE, LIMIT          0.829    300000.000
 ITERATION COUNT, LIMIT        14    2147483647
 EVALUATION ERRORS              0             0
 
 
    C O N O P T   version 4.35
    Copyright (C) GAMS Software GmbH
                  GAMS Development Corporation
 
 
    The user model has 59291 constraints and 59291 variables
    with 235170 Jacobian elements, 57761 of which are nonlinear.
 
    The pre-triangular part of the model has 1375 constraints and variables.
    The post-triangular part of the model has 1 constraints and variables.
 
    Preprocessed model has 57915 constraints and 57915 variables
    with 173283 Jacobian elements, 57761 of which are nonlinear.
 
 ** Optimal solution. There are no superbasic variables.
 
 
 CONOPT time Total                            0.841 seconds
   of which: Function evaluations             0.139 = 16.5%
             1st Derivative evaluations       0.136 = 16.2%
 


**** REPORT SUMMARY :        0     NONOPT
                             0 INFEASIBLE
                             0  UNBOUNDED
                             0     ERRORS
GAMS 48.6.1  67fbb04b Jan 23, 2025          LEX-LEG x86 64bit/Linux - 12/16/25 15:08:32 Page 6
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
Range Statistics    SOLVE PA Using MIP From line 3114


RANGE STATISTICS (ABSOLUTE NON-ZERO FINITE VALUES)

RHS       [min, max] : [ 2.000E-03, 2.302E+09] - Zero values observed as well
Bound     [min, max] : [ 2.000E+00, 4.000E+04] - Zero values observed as well
Matrix    [min, max] : [ 1.000E-03, 6.333E+07] - Zero values observed as well

GAMS 48.6.1  67fbb04b Jan 23, 2025          LEX-LEG x86 64bit/Linux - 12/16/25 15:08:32 Page 7
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
Model Statistics    SOLVE PA Using MIP From line 3114


MODEL STATISTICS

BLOCKS OF EQUATIONS         135     SINGLE EQUATIONS    5,989,202
BLOCKS OF VARIABLES          82     SINGLE VARIABLES    5,338,425
NON ZERO ELEMENTS    21,917,702     DISCRETE VARIABLES        506


GENERATION TIME      =       34.922 SECONDS  4,007 MB  48.6.1 67fbb04b LEX-LEG
GAMS 48.6.1  67fbb04b Jan 23, 2025          LEX-LEG x86 64bit/Linux - 12/16/25 15:08:32 Page 8
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
Solution Report     SOLVE PA Using MIP From line 3114


               S O L V E      S U M M A R Y

     MODEL   PA                  OBJECTIVE  vNPVCost
     TYPE    MIP                 DIRECTION  MINIMIZE
     SOLVER  CPLEX               FROM LINE  3114

**** SOLVER STATUS     1 Normal Completion
**** MODEL STATUS      8 Integer Solution
**** OBJECTIVE VALUE     174137231073.9695

 RESOURCE USAGE, LIMIT      20136.050    300000.000
 ITERATION COUNT, LIMIT   2865604    2147483647
--- GAMS/CPLEX licensed for continuous and discrete problems.

*** Error Cannot open parameter file "/Data/SAPP_2026/EPM/epm/output/simulations_run_20251216_150832/baseline/cplex.opt"
*** Error Error code = 2; No such file or directory

--- GMO setup time: 0.00s
--- Space for names approximately 622.66 Mb
--- Use option 'names no' to turn use of names off
--- GMO memory 2297.36 Mb (peak 2338.09 Mb)
--- Dictionary memory 0.00 Mb
--- Cplex 22.1.1.0 link memory 170.36 Mb (peak 1156.48 Mb)
--- Starting Cplex


--- MIP status (102): integer optimal, tolerance.
--- Cplex Time: 11759.92sec (det. 5391636.70 ticks)

--- Returning a primal only solution to GAMS (marginals all set to NA).
--- Fixing integer variables and solving final LP...


--- Fixed MIP status (1): optimal.
--- Cplex Time: 8374.67sec (det. 3320671.43 ticks)


Solution satisfies tolerances
--- Cplex returned a model status that does not guarantee feasibility of the returned solution.
--- Found infeasibility of 0 (smaller than tolerance 1e-06).



**** REPORT SUMMARY :        0     NONOPT
                             0 INFEASIBLE
                             0  UNBOUNDED
GAMS 48.6.1  67fbb04b Jan 23, 2025          LEX-LEG x86 64bit/Linux - 12/16/25 15:08:32 Page 9
G e n e r a l   A l g e b r a i c   M o d e l i n g   S y s t e m
E x e c u t i o n


**** REPORT FILE SUMMARY



EXECUTION TIME       =    20248.608 SECONDS  4,009 MB  48.6.1 67fbb04b LEX-LEG


USER: Medium MUD - 10 User License                   G250212|0002CO-GEN
      The World Bank, Energy Sector Management Assistance PrograDC12370


**** FILE SUMMARY

Input      /Data/SAPP_2026/EPM/epm/main.gms
Output     /Data/SAPP_2026/EPM/epm/output/simulations_run_20251216_150832/baseline/main.lst
