# Tableau Workflow

Tableau is the recommended approach for most users, providing a user-friendly interface for comparing scenarios, countries, and years across various indicators (capacity, energy, trade flows, costs, etc.). Interactive filters allow detailed data exploration.

Example: _[SAPP overview](https://public.tableau.com/app/profile/celia.escribe/viz/SAPPregionalintegration/Home?publish=yes)_  
_[SAPP comparison of scenarios](https://public.tableau.com/app/profile/celia.escribe/viz/SAPP-Comparison/Compare?publish=yes)_

This dashboard directly uses the CSV files exported during EPM runs. No manual data formatting is required if the model is launched from the Python workflow.

## How to use Tableau for EPM

1. **Setup a new Tableau project** for your simulation results. **Done only once per project, using the shared VDI machine**  
> A **Tableau Creator license** is required for creating or editing dashboards. Contact the energy planning team for more details.

2. **Analyze results online from Tableau Public**, accessible from any computer.
 

## 1. Create the folder structure for Tableau

The folder structure should look like this:
```plaintext
├── ESMAP_Tableau_Compare.twb
├── ESMAP_Tableau_Overview.twb
├── ESMAP_Tableau_Complete.twb
├── ESMAP_logo.png
├── linestring_countries.geojson
└── scenarios/
    ├── baseline/
    │   ├── output_csv/
    │       ├── *.csv
    ├── scenario_1/
    │   ├── output_csv/
    │       ├── *.csv
    └── ...
```

In `output/tableau` in your EPM repository, you’ll find the required file structure. 

Drag and drop your simulation results into the `scenarios/` folder. Each scenario folder must contain an `output_csv/` subfolder with EPM-generated CSVs. If using GAMS Studio, manually extract the CSVs.

> **Important**: One scenario must be named `baseline`, or an error will occur.


## 2. Generate `linestring_countries.geojson` and add to the directory

This file is required for geographic visualizations in Tableau. It can be generated by updating the `geojson_to_epm.csv` file and running the script below.

### Step 1: Update the `geojson_to_epm.csv`

> Example can be found [here](https://github.com/ESMAP-World-Bank-Group/EPM/blob/main/epm/postprocessing/static/geojson_to_epm.csv).

This CSV file defines how names from the GeoJSON file should be translated into EPM-compatible zone names. It also allows you to split countries into sub-zones if needed (e.g. North/South).

- `Geojson`: the name of the country or region as it appears in the GeoJSON file.
    _Example_: `United Republic of Tanzania`
    When a country is split into multiple regions, this name should include the corresponding region. Example: `Democratic Republic of the Congo - North`.
- `EPM`: the name used for that zone in the EPM model.  
  _Example_: `Tanzania`
- `region`: _(optional)_ only used when splitting a country into several zones. Specifies which part of the country this line refers to.  
  _Example_: `north`
- `country`: _(optional)_ if a country is split, this column gives the full country name (e.g. `Democratic Republic of the Congo`), while the `Geojson` column may be something like `Democratic Republic of the Congo - North`.
- `division`: _(optional)_ describes how the country is split. Current accepted values:  
  - `NS` = North/South  
  - `EW` = East/West  
  More division types may be added in the future.

### Step 2: Run the script to generate GeoJSON data

Run the following command from the root of the repository at `epm/postprocessing`:
```sh
cd EPM/epm/postprocessing
python create_geojson.py
```

The script will generate linestring_countries.geojson for use in Tableau visualizations.


## 3. Upload the folder to OneDrive

Upload the folder to OneDrive to access from the shared VDI machine. From the VDI, you can access OneDrive and load the files into Tableau.

## 4. Connect to the shared VDI

Tableau is pre-installed on the shared VDI machine. 
You may need to register if this is your first connection.

## 5. Open the Tableau file

From the shared VDI, click on the `.twb` file corresponding to your desired visualization.

**Available Tableau interfaces**:  
- **Single scenario viewer**: Use for exploring one scenario at a time: [ESMAP_Tableau_Overview.twb](https://github.com/ESMAP-World-Bank-Group/EPM/blob/main/docs/dwld/ESMAP_Tableau_Overview.twb)
- **Scenario comparison viewer**: Use for comparing multiple scenarios side by side: [ESMAP_Tableau_Compare.twb](https://github.com/ESMAP-World-Bank-Group/EPM/blob/main/docs/dwld/ESMAP_Tableau_Compare.twb)
- **Complete viewer**: For simpler models: [ESMAP_Tableau_Complete.twb](https://github.com/ESMAP-World-Bank-Group/EPM/blob/main/docs/dwld/ESMAP_Tableau_Complete.twb)

## 6. Save your Dashboard as Public

Use Tableau Public to visualize and share your results.

In Tableau, go to `Server`, `Tableau Public`, `Save to Tableau Public as`. Choose a name and complete the upload. You will be asked to sign in Tableau with your IDs. Once published, a browser window will open with your dashboard.
You may adapt the settings based on the intended usage of this visualization, by going to the `Settings` button (after signing in on your browser):
- Remove `Show Viz on Profile` if you want the visualization to only be accessible to those with a link (hide it from your public profile)
- Remove `Allow Access` to prevent data download.

> **Important**: this visualization will only work when data has been extracted as described in Step 2 of paragraph Update visualization. Tableau will prompt an error if you attempt to publish with live connections.


## 7. Update visualization

To update the visualization for new scenarios, you should follow the steps:
1. Upload new scenarios with the correct structure, ensuring one is named `baseline`.
2. Tableau opens in live connection mode by default. This causes delays when interacting with filters or switching views.
To avoid these delays, you must extract the data. For each of these four data sets, you must extract the data by going to `Data` and `Extract data`: `linestring`, `pCostSummaryWeightedAverageCountry`, `Plant DB` and `pSummary`. You should click on `Save settings` when asked. If Tableau warns that a file already exists, click Replace this file.
3. Once this has been done, data is extracted and optimized so that the visualizations will now load faster.
4. When refreshing with new scenarios, extrated data remains based on the previous scenarios. Two steps can be used to refresh the data and access the new visualization:
   1. Keep previous extracts but view new data: For each of the dataset above, unclick `Use Extract` (reverts to live mode).
   2. Replace extracts with new data: for each of the dataset above, go to `Extract` → `Remove` → `Remove the extract and delete the extract file`.
   Then re-extract to optimize the new data (Step 2)

**Note**: If nothing shows up: (i) check the folder and file structure, (ii) verify filters are not hiding the data and (iii) make sure data extraction was completed (especially on slower machines).






