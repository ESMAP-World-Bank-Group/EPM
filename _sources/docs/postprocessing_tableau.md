# Tableau workflow

There are two main workflows for visualizing EPM model results:
- _Tableau_ for interactive exploration and dashboards
- _Python_ for custom plots and analyses, relying on in-house libraries. Check out the Advanced Topics for more details.

Tableau is the recommended approach for most users, as it provides a user-friendly interface and powerful visualization capabilities without requiring programming skills.
It includes multiple tabs for comparing scenarios, countries, and years across various indicators (capacity, energy, trade flows, costs, etc.). Interactive filters allow detailed data exploration.

Example: _[SAPP overview](https://public.tableau.com/app/profile/celia.escribe/viz/SAPPregionalintegration/Home?publish=yes)_
_[SAPP comparison of scenarios](https://public.tableau.com/app/profile/celia.escribe/viz/SAPP-Comparison/Compare?publish=yes)_

This dashboard directly uses the CSV files exported during EPM runs. No manual data formatting is required if the model is launched from the Python workflow.

## Modelers

To update or edit Tableau dashboards with new model outputs, a **Tableau Creator license** is required. WB team members can request access to a Creator license if needed. A license already exists and is installed on the shared VDI machine. Please contact the energy planning team for more information on this.

### Loading data 
To run Tableau for EPM visualization, ensure the following:

- A WB computer or VDI (Virtual Desktop Infrastructure). 
- A YubiKey (only required for VDI authentication).
The setup will not work outside the VDI or without a Yubikey.

1. Connect to the common VDI and launch the `Tableau` app. You may need to register if this is your first connection.
2. Create the following folder structure
```markdown
├── ESMAP_Viz_v6_ex_compare.twb
├── Compare.twb
├── ESMAP_logo.png
├── linestring_countries.geojson
└── scenarios/
    ├── baseline/
    │   ├── output_csv/
        │   ├── *.csv
    ├── scenario_1/
        ├── *.csv
    └── ...
```

**Available Tableau interfaces**

To improve performance — especially for models with many zones and years — **two separate interfaces** are provided:

- **Single scenario viewer**  
  Use this `.twb` file to explore one scenario at a time:  
  [ESMAP_Tableau_Overview.twb](https://github.com/ESMAP-World-Bank-Group/EPM/blob/main/docs/dwld/ESMAP_Tableau_Overview.twb)

- **Scenario comparison viewer**  
  Use this `.twb` file to compare multiple scenarios side by side:  
  [ESMAP_Tableau_Compare.twb](https://github.com/ESMAP-World-Bank-Group/EPM/blob/main/docs/dwld/ESMAP_Tableau_Compare.twb)

For simpler models (e.g. single country, few zones), an integrated all-in-one interface is also available:
  [ESMAP_Tableau_Complete.twb](https://github.com/ESMAP-World-Bank-Group/EPM/blob/main/docs/dwld/ESMAP_Tableau_Complete.twb)



3. Each scenario folder must contain an `output_csv/` subfolder with the CSVs outputs from EPM. These are automatically generated when running the EPM model from Python. If running from GAMS Studio, CSVs must be extracted manually (less efficient). See the `Running EPM from Python` section for guidance.

> **Important**: one of the scenarios inside folder `scenarios/` must be named `baseline`, otherwise an error will be raised.

4. Add the file `linestring_countries.geojson` in the same directory as the Tableau `.twb` file.  This file is required for geographic visualizations. See the "Generating map files" section for instructions.

5. Click on the `.twb` file corresponding to the visualization you want to produce. This will open it in Tableau, and create the visualization corresponding to your scenarios in the `scenarios/` folder.

#### Generating map files

Some visualization tabs in Tableau include maps, which require a GeoJSON file to display countries or regions. This file must match the zones defined in your EPM model. The necessary data can be generated by following the steps below.

1. Step 1: Create the `geojson_to_epm.csv` mapping file. An example can be found [here](https://github.com/ESMAP-World-Bank-Group/EPM/blob/main/epm/postprocessing/static/geojson_to_epm.csv).

This CSV file defines how names from the GeoJSON file should be translated into EPM-compatible zone names. It also allows you to split countries into sub-zones if needed (e.g. North/South).

- `Geojson`: the name of the country or region as it appears in the GeoJSON file. 
  
    _Example_: `United Republic of Tanzania`
    When a country is split into multiple regions, this name should include the corresponding region. Example: `Democratic Republic of the Congo - North`.
- `EPM`: the name used for that zone in the EPM model.  
  _Example_: `Tanzania`
- `region`: _(optional)_ only used when splitting a country into several zones. Specifies which part of the country this line refers to.  
  _Example_: `north`
- `country`: _(optional)_ if a country is split, this column gives the full country name (e.g. `Democratic Republic of the Congo`), while the `Geojson` column may be something like `Democratic Republic of the Congo - North`.
- `division`: _(optional)_ describes how the country is split. Current accepted values:  
  - `NS` = North/South  
  - `EW` = East/West  
  More division types may be added in the future.

Save this file as `geojson_to_epm.csv` in the output folder for your run.

2. Step 2: Run the Script to Generate GeoJSON Data

> **Note**: Make sure to run this command from the root of the repository at `epm/postprocessing`. It will not work if it is run from `epm`. 

To navigate to the correct directory, use:
```sh
cd EPM/epm/postprocessing
````

Then run the following command:
```python 
python utils.py --zones Angola DRC DRC_South Eswatini Lesotho Malawi Mozambique Namibia South_Africa Tanzania Zambia Zimbabwe --folder Tableau
```
Here:
- `--zones`: list of EPM zones to include in the GeoJSON output. These must match the zone names in your model.
- `--folder`: name of the folder that contains your model results. This should match the folder inside the `output/` directory. Example: if your results are saved in `output/Tableau`, use `--folder Tableau`.

**Note**: The output folder (`output/your_folder`) must contain both: `geojson_to_epm.csv` (mapping file created above) and `zcmap.csv` (zone-country map used when running the model)

Once the script runs successfully, it will generate the `linestring_countries.geojson` file you can use directly in Tableau for map visualizations.

### Update visualization

To update the visualization for new scenarios, you should follow the steps:
1. Upload the new scenarios with the arborescence as described previously, keeping in mind that one of the scenarios is named `baseline`.
2. Tableau opens in live connection mode by default. This causes delays when interacting with filters or switching views.
To avoid these delays, you must extract the data. For each of these four data sets, you must extract the data by going to `Data` and `Extract data`: `linestring`, `pCostSummaryWeightedAverageCountry`, `Plant DB` and `pSummary`. You should click on `Save settings` when asked. If Tableau warns that a file already exists, click Replace this file.
3. Once this has been done, data is extracted and optimized so that the visualizations will now load faster.
4. When refreshing with new scenarios, extrated data remains based on the previous scenarios. Two steps can be used to refresh the data and access the new visualization:
   1. Keep previous extracts but view new data: For each of the dataset above, unclick `Use Extract` (reverts to live mode).
   2. Replace extracts with new data: for each of the dataset above, go to `Extract` → `Remove` → `Remove the extract and delete the extract file`.
   Then re-extract to optimize the new data (Step 2)

**Note**: If nothing shows up: (i) check the folder and file structure, (ii) verify filters are not hiding the data and (iii) make sure data extraction was completed (especially on slower machines).

## Public

The Tableau dashboard can be shared with external users who don’t need to edit data sources but can explore results interactively.

In Tableau, go to `Server`, `Tableau Public`, `Save to Tableau Public as`. Choose a name and complete the upload. You will be asked to sign in Tableau with your IDs. Once published, a browser window will open with your dashboard.
You may adapt the settings based on the intended usage of this visualization, by going to the `Settings` button (after signing in on your browser):
- Remove `Show Viz on Profile` if you want the visualization to only be accessible to those with a link (hide it from your public profile)
- Remove `Allow Access` to prevent data download.

> **Important**: this visualization will only work when data has been extracted as described in Step 2 of paragraph Update visualization. Tableau will prompt an error if you attempt to publish with live connections.
